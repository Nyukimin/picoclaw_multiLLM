{
  "version": "2026-02-17",
  "notes": [
    "方針: command → rules → classifier → fallback",
    "rulesは '強い証拠' のみで確定させる（特にCODEは誤爆厳禁）",
    "patternsは正規表現（デフォルトはマルチライン想定）",
    "同一priority内は上から評価して最初に当たったものを採用"
  ],
  "routes": ["CHAT", "PLAN", "ANALYZE", "OPS", "RESEARCH", "CODE"],
  "rules": [
    {
      "name": "CODE_DIFF_GIT",
      "route": "CODE",
      "priority": 1000,
      "match": {
        "any": [
          "(?m)^diff --git\\s+",
          "(?m)^index\\s+[0-9a-f]+\\.\\.[0-9a-f]+",
          "(?m)^---\\s+\\S+",
          "(?m)^\\+\\+\\+\\s+\\S+",
          "(?m)^@@\\s+[-+0-9, ]+\\s+@@"
        ]
      },
      "evidence_label": "diff"
    },
    {
      "name": "CODE_CODE_FENCE",
      "route": "CODE",
      "priority": 950,
      "match": {
        "any": [
          "(?s)```[\\s\\S]*?```"
        ]
      },
      "evidence_label": "code_fence"
    },
    {
      "name": "CODE_STACKTRACE_PYTHON",
      "route": "CODE",
      "priority": 900,
      "match": {
        "all": [
          "(?m)^Traceback \\(most recent call last\\):",
          "(?m)^\\s*File \".+\", line \\d+, in .+"
        ]
      },
      "evidence_label": "stacktrace"
    },
    {
      "name": "CODE_STACKTRACE_NODE",
      "route": "CODE",
      "priority": 890,
      "match": {
        "any": [
          "(?m)^\\s*at\\s+.+\\(.+\\:\\d+\\:\\d+\\)$",
          "(?m)^(Error|TypeError|ReferenceError|SyntaxError|RangeError):\\s+.+"
        ]
      },
      "evidence_label": "stacktrace"
    },
    {
      "name": "CODE_JAVA_STACKTRACE",
      "route": "CODE",
      "priority": 880,
      "match": {
        "all": [
          "(?m)^(Exception in thread|[A-Za-z0-9_.$]+Exception|[A-Za-z0-9_.$]+Error):\\s+.+",
          "(?m)^\\s*at\\s+[A-Za-z0-9_.$]+\\([A-Za-z0-9_.$]+\\.java:\\d+\\)"
        ]
      },
      "evidence_label": "stacktrace"
    },
    {
      "name": "CODE_CONCRETE_FILES_HIGH_SIGNAL",
      "route": "CODE",
      "priority": 850,
      "match": {
        "any": [
          "(?m)\\bpackage\\.json\\b",
          "(?m)\\bpackage-lock\\.json\\b",
          "(?m)\\bpnpm-lock\\.yaml\\b",
          "(?m)\\byarn\\.lock\\b",
          "(?m)\\btsconfig\\.json\\b",
          "(?m)\\bDockerfile\\b",
          "(?m)\\bdocker-compose\\.(yml|yaml)\\b",
          "(?m)\\bcompose\\.(yml|yaml)\\b",
          "(?m)\\bpyproject\\.toml\\b",
          "(?m)\\brequirements\\.txt\\b",
          "(?m)\\bPipfile(\\.lock)?\\b",
          "(?m)\\bCargo\\.(toml|lock)\\b",
          "(?m)\\bgo\\.(mod|sum)\\b",
          "(?m)\\bMakefile\\b",
          "(?m)\\bCMakeLists\\.txt\\b",
          "(?m)\\b\\.github/workflows/[^\\s]+\\.(yml|yaml)\\b",
          "(?m)\\b(\\.env(\\.[^\\s]+)?)\\b"
        ]
      },
      "evidence_label": "filenames"
    },
    {
      "name": "CODE_FILE_EXTENSIONS_IN_TEXT",
      "route": "CODE",
      "priority": 820,
      "match": {
        "any": [
          "(?m)\\b[^\\s]+\\.(ts|tsx|js|jsx|mjs|cjs|py|rb|php|java|kt|go|rs|c|cc|cpp|h|hpp|cs|swift|scala|sh|ps1|sql|html|css|json|toml|ini|conf|cfg|service|yaml|yml)\\b"
        ]
      },
      "evidence_label": "file_ext"
    },

    {
      "name": "OPS_SYSTEMD_JOURNALCTL",
      "route": "OPS",
      "priority": 700,
      "match": {
        "any": [
          "(?m)\\bsystemctl\\b",
          "(?m)\\bjournalctl\\b",
          "(?m)\\bunit\\b.*\\b(service|timer)\\b"
        ]
      },
      "evidence_label": "ops_systemd"
    },
    {
      "name": "OPS_DOCKER",
      "route": "OPS",
      "priority": 690,
      "match": {
        "any": [
          "(?m)\\bdocker\\b",
          "(?m)\\bdocker-compose\\b",
          "(?m)\\bcompose\\b.*\\b(up|down|ps|logs)\\b",
          "(?m)\\bcontainer\\b.*\\b(logs|exec|ps)\\b"
        ]
      },
      "evidence_label": "ops_docker"
    },
    {
      "name": "OPS_SSH_NETWORK",
      "route": "OPS",
      "priority": 680,
      "match": {
        "any": [
          "(?m)\\bssh\\b",
          "(?m)\\btailscale\\b",
          "(?m)\\bping\\b",
          "(?m)\\btraceroute\\b",
          "(?m)\\bip route\\b",
          "(?m)\\bnmcli\\b",
          "(?m)\\bnetstat\\b",
          "(?m)\\bss\\b\\s+-",
          "(?m)\\bufw\\b",
          "(?m)\\biptables\\b"
        ]
      },
      "evidence_label": "ops_network"
    },
    {
      "name": "OPS_GIT_OPERATIONS",
      "route": "OPS",
      "priority": 660,
      "match": {
        "any": [
          "(?m)\\bgit\\s+(status|log|diff|commit|push|pull|fetch|rebase|merge|checkout|switch|branch)\\b",
          "(?m)\\bgh\\b\\s+",
          "(?m)\\bgithub\\b.*\\b(action|workflow)\\b"
        ]
      },
      "evidence_label": "ops_git"
    },

    {
      "name": "ANALYZE_CSV_TSV_TABLE_BLOCK",
      "route": "ANALYZE",
      "priority": 600,
      "match": {
        "any": [
          "(?m)^(?:[^\\n,]+,){2,}[^\\n,]+$",
          "(?m)^(?:[^\\n\\t]+\\t){2,}[^\\n\\t]+$"
        ]
      },
      "evidence_label": "data_table"
    },
    {
      "name": "ANALYZE_JSON_BLOCK",
      "route": "ANALYZE",
      "priority": 590,
      "match": {
        "any": [
          "(?s)^\\s*\\{[\\s\\S]*\\}\\s*$",
          "(?s)^\\s*\\[[\\s\\S]*\\]\\s*$"
        ]
      },
      "evidence_label": "data_json"
    },
    {
      "name": "ANALYZE_LOG_BULK",
      "route": "ANALYZE",
      "priority": 580,
      "match": {
        "all": [
          "(?s)(\\n.*){15,}"
        ]
      },
      "evidence_label": "bulk_text"
    },
    {
      "name": "ANALYZE_KEYWORDS",
      "route": "ANALYZE",
      "priority": 560,
      "match": {
        "any": [
          "(?m)\\b(集計|傾向|統計|分布|相関|クラスタ|分類|タグ付け|抽出|構造化)\\b",
          "(?m)\\b(analyze|analysis|aggregate|trend|statistics|distribution|correlation|cluster|classify|tagging|extract|parse|normalize)\\b"
        ]
      },
      "evidence_label": "analyze_words"
    },

    {
      "name": "RESEARCH_URL_OR_SOURCE_REQUEST",
      "route": "RESEARCH",
      "priority": 520,
      "match": {
        "any": [
          "(?m)https?://\\S+",
          "(?m)\\b(出典|一次情報|引用|ソース|根拠|資料名|論文|公式)\\b",
          "(?m)\\b(最新|直近|アップデート|今週|今月)\\b",
          "(?m)\\b(compare|comparison|source|citation|paper|official|latest|update)\\b"
        ]
      },
      "evidence_label": "research"
    },

    {
      "name": "PLAN_PLANNING_KEYWORDS",
      "route": "PLAN",
      "priority": 450,
      "match": {
        "any": [
          "(?m)\\b(仕様|設計|構成|アーキテクチャ|要件|段取り|手順|タスク分解|ロードマップ|見積)\\b",
          "(?m)\\b(spec|design|architecture|requirements|plan|roadmap|breakdown|estimate)\\b"
        ]
      },
      "evidence_label": "plan_words"
    }
  ]
}
