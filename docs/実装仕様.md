# 実装仕様（統合正本）

本書は `docs/仕様.md` に対する実装の唯一の正本とする。  
`docs/実装仕様_01.md`〜`docs/実装仕様_07.md` はアーカイブ（互換参照）として扱う。

## 仕様リンク

- 元仕様: `docs/仕様.md`
- 章分割版: `docs/実装仕様_v2_00_目次.md`
- 旧版アーカイブ: `docs/実装仕様_アーカイブ一覧.md`

### 実装章 → 仕様章 対応
- 1章（スコープ・責務境界） → 仕様「目的と前提」「用語」「全体構成」
- 2章（ルーティング決定仕様） → 仕様「ルーティングカテゴリ」「ルーティング決定ルール」「分類器」
- 3章（ループ制御と再ルート） → 仕様「ループ制御」「誤分類への対策」
- 4章/5章（I/O契約/ワーカー） → 仕様「ワーカー出力契約」
- 6章（セキュリティ） → 仕様「セキュリティとデータ取り扱い」
- 7章（ログ） → 仕様「ログと改善データ」
- 8章（Prompt/宣言） → 仕様「ユーザーへの可視化（宣言）」
- 9章（状態管理） → 仕様「セッションとメモリ」
- 10章（設定値と閾値） → 仕様「分類器」「ループ制御」
- 11章（テスト観点） → 仕様全体の検証項目

---

## 1. スコープ・責務境界
- 対象チャネル: LINE / Slack（他チャネルは対象外、既存挙動を壊さない）
- 最終応答は会話LLMのみが生成する
- 分岐決定は Router / LoopController のみ
- LLMは提案者であり決定権を持たない

---

## 2. ルーティング決定仕様

### 2.1 優先順位（固定）
1. 明示コマンド
2. ルール辞書（強証拠）
3. 分類器（1入力につき最大1回）
4. 安全側フォールバック

### 2.2 明示コマンド
- `/code /analyze /plan /ops /research /chat /local /cloud`
- 行頭コマンドのみ有効
- `local_only=true` 中の `/code` は Router段階で拒否し、会話LLMで解除案内

### 2.3 ルール辞書
- 初期辞書は強証拠のみ
- 評価順は priority降順、同値は定義順
- 辞書定義は `docs/実装仕様_02.md` を正式参照

### 2.4 分類器
- 出力は JSON のみ（`route`,`confidence`,`reason`,`evidence`）
- 故障時（JSON不正/必須欠損/列挙外/範囲外）は CHAT フォールバック
- CODE判定は `confidence >= 0.8` かつ強証拠を必須

### 2.5 分類器プロンプト管理
- 分類器system promptは1枚固定
- 更新はカテゴリ追加時のみ

---

## 3. ループ制御と再ルート

### 3.1 停止条件
- `max_loops` 到達
- `max_millis` 到達
- worker失敗
- ユーザー確認が必要

### 3.2 ユーザー確認停止
- 停止理由を `need_user_confirmation` に統一
- 発火条件:
  - `risk=high`
  - 低confidenceかつ重大分岐
  - 追加情報不足

### 3.3 再ルート（最大1回）
- `fit=false` かつ `suggested_route` 有効
- または会話LLM提案IFを採択
- 同一入力で最大1回

### 3.4 会話LLM提案IF
```json
{"propose_next_loop":false,"route":"CHAT|PLAN|ANALYZE|OPS|RESEARCH|CODE","reason":"short text","confidence":0.0}
```

---

## 4. I/O契約

### 4.1 InputMessage
- `channel`, `session_id`, `user_text`, `raw`, `received_at`

### 4.2 RoutingDecision
- `primary_route`, `source`, `confidence`, `reason`, `evidence`, `flags.local_only`

### 4.3 WorkerInput
- `docs/実装仕様_03.md` の入力スキーマを採用

### 4.4 WorkerOutput（統一定義）
- 必須: `result`,`needs_next_loop`,`why`,`next_actions`,`questions_for_user`,`confidence`,`risk`
- 任意: `fit`,`suggested_route`

---

## 5. ワーカー仕様
- 全ワーカーの出力は JSON のみ
- 失敗時は `needs_next_loop=false`
- `next_actions` / `questions_for_user` は最大3
- CODEはクラウド専用、`local_only` 時は呼び出し禁止（Router拒否を主、worker保険）

---

## 6. セキュリティ仕様
- CODE以外でクラウド利用禁止
- `/local` 中はクラウド呼び出し禁止
- 機密情報（token/secret/PII）はクラウド送信前に除外
- ログ保存はマスク後のみ
- サニタイズ責務は `pkg/security/sanitizer.go` に一本化

---

## 7. ログ仕様

### 7.1 イベント種別（固定）
- `router.decision`
- `classifier.error`
- `worker.success`
- `worker.fail`
- `route.override`
- `loop.stop`
- `final.route`

### 7.2 最低保存項目
- `initial_route`, `final_route`
- `classifier_route`, `classifier_confidence`
- `worker_calls`, `needs_next_loop`, `risk`, `fit`
- `reroute_used`, `stop_reason`, `error_reason`

---

## 8. Prompt/宣言仕様
- persona/policy/overlay を固定順で連結
- system prompt はアプリ側のみが構築
- route変更時のみ1行宣言（CHATは宣言なし）

---

## 9. 状態管理仕様
- `session_id` はチャネル単位で一意管理（Slackはthread単位推奨）
- `short_memory` 中心で運用し `recent_turns` は最小限
- ANALYZE構造化データの保存先は実装で1つに統一:
  - `pkg/memory/store.go` 拡張
  - または `pkg/analyze/store.go` 新設

---

## 10. 設定値と閾値
- `routing.classifier.min_confidence = 0.6`
- `routing.classifier.min_confidence_for_code = 0.8`
- `loop.max_loops = 3`
- `loop.max_millis = 25000`
- `loop.allow_auto_reroute_once = true`
- `loop.allow_chat_propose_reroute_once = true`

---

## 11. テスト観点
- 正常系: command優先、rules確定、classifierフォールバック、reroute最大1回
- 異常系: 分類器JSON不正、ワーカーJSON不正、`local_only`中CODE、`risk=high`確認停止
- 回帰: 非対象チャネルへ副作用なし、宣言文切替の維持

---

## 12. 参照関係
- 正本: `docs/実装仕様.md`（本書）
- 分割版: `docs/実装仕様_v2_00_目次.md`
- 旧版アーカイブ一覧: `docs/実装仕様_アーカイブ一覧.md`

---

## 13. 実装状況（MVP / 2026-02-19）

### 13.1 実装済み
- Router（MVP）: `command -> rules -> classifier -> fallback` を実装
  - `pkg/agent/router.go`
- Classifier（MVP）: JSON抽出/検証、異常時フォールバックを実装
  - `pkg/agent/classifier.go`
- AgentLoop統合: ルーティング判定、宣言文付与、`local_only` セッション保持を実装
  - `pkg/agent/loop.go`
- 設定追加: `routing` / `loop` を追加（デフォルト値含む）
  - `pkg/config/config.go`
- セッション拡張: `local_only` / `prev_primary_route` を保存
  - `pkg/session/manager.go`

### 13.2 テスト状況
- パッケージテスト: `go test ./pkg/config ./pkg/session ./pkg/agent` 通過
- 追加テスト:
  - `pkg/agent/router_test.go`
  - `pkg/session/manager_test.go`（flags永続化）
  - `pkg/config/config_test.go`（routing/loop初期値）

### 13.3 既知の制約（MVP）
- 分類器はモデル出力に依存し、JSON不正時は `CHAT` にフォールバックする。
- `needs_next_loop` を前提にした高度なworker連鎖は未実装（1ターン完結中心）。
- 会話LLMの再ルート提案IF採択ロジックは次フェーズ。

### 13.4 接続運用メモ（Ollama/Tailscale）
- `api_base` は名前解決不安定時に Tailscale IP 直指定を推奨。
- 現行実装では Ollama接続時に provider判定の都合上、`model` は `ollama/<model>` 形式で指定する。
