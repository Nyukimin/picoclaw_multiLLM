# 実装仕様 v2（統合版）

本書は `docs/仕様.md` を実装に落とし込むための正本。  
既存の `実装仕様_01.md`〜`実装仕様_07.md` は参照可能だが、解釈が競合した場合は本書を優先する。

---

## 1. スコープ・責務境界

- 対象チャネル: LINE / Slack（他チャネルは非対象、既存挙動を壊さない）
- ユーザーに見える最終応答は会話LLMのみが生成
- Router/LoopControllerが唯一の分岐決定者
- LLM（分類器/ワーカー/会話LLM）は提案者であり決定権を持たない

---

## 2. ルーティング決定仕様

### 2.1 優先順位（固定）
1. 明示コマンド
2. ルール辞書（強証拠）
3. 分類器（1入力につき最大1回）
4. 安全側フォールバック

### 2.2 明示コマンド
- 対応: `/code /analyze /plan /ops /research /chat /local /cloud`
- 行頭コマンドのみ有効
- `local_only=true` 中の `/code` は Router段階で拒否し、会話LLMに解除案内を生成させる

### 2.3 ルール辞書
- 初期辞書は強証拠のみ
- 評価順: `priority` 降順、同値は定義順
- 辞書定義は `実装仕様_02.md` 形式を継承

### 2.4 分類器
- 出力は JSON のみ:
  - `route`, `confidence`, `reason`, `evidence`
- 故障時（JSON不正/必須欠損/列挙外/範囲外）は CHAT にフォールバック
- CODE判定は `confidence >= 0.8` かつ強証拠再確認を必須とする

### 2.5 分類器プロンプト管理（REQ-080）
- 分類器用 system prompt は1枚固定
- 更新条件はカテゴリ追加時のみ
- 保管場所: `pkg/llm/prompts/classifier_system.md`（提案）

---

## 3. ループ制御と再ルート仕様

### 3.1 停止条件
- `loops >= max_loops`
- 経過時間 `>= max_millis`
- ワーカー失敗
- ユーザー確認が必要

### 3.2 ユーザー確認判定
以下のいずれかで停止理由 `need_user_confirmation` を返す。
- `risk == high`
- `confidence` が閾値未満かつ分岐影響が重大
- 追加情報なしでは次処理の正当性を確保できない

### 3.3 再ルート（最大1回）
- 条件A: `fit=false` かつ `suggested_route` 有効
- 条件B: 会話LLM提案IFが `propose_next_loop=true` かつ採択基準を満たす
- 上限: 同一ユーザー入力に対して1回

### 3.4 会話LLM提案IF
```json
{
  "propose_next_loop": false,
  "route": "CHAT|PLAN|ANALYZE|OPS|RESEARCH|CODE",
  "reason": "short text",
  "confidence": 0.0
}
```

---

## 4. I/O契約

### 4.1 InputMessage
- `channel`, `session_id`, `user_text`, `raw`, `received_at`

### 4.2 RoutingDecision
- `primary_route`, `source`, `confidence`, `reason`, `evidence`, `flags.local_only`

### 4.3 WorkerInput
- `実装仕様_03` の入力スキーマを採用

### 4.4 WorkerOutput（統一定義）
- 必須:
  - `result`
  - `needs_next_loop`
  - `why`
  - `next_actions`
  - `questions_for_user`
  - `confidence`
  - `risk`
- 任意:
  - `fit`
  - `suggested_route`

注記: `fit` / `suggested_route` は任意で統一する（`実装仕様_03` の required 記述は本書で上書き）。

---

## 5. ワーカー仕様

### 5.1 共通
- 出力はJSONのみ
- `next_actions` / `questions_for_user` は最大3
- 失敗時は `needs_next_loop=false`

### 5.2 PLAN / ANALYZE / OPS / RESEARCH
- 各内部プロンプトは `実装仕様_03` をベースとする
- route不一致を検知した場合は `fit=false` と `suggested_route` を返す

### 5.3 CODE
- クラウド利用は CODE のみ
- `local_only=true` 時は呼び出し禁止（Router拒否が主、worker側は保険ガード）
- 入力はサニタイズ済みを前提

---

## 6. セキュリティ仕様

### 6.1 サニタイズ責務
- 正式責務は `pkg/security/sanitizer.go` に一本化
- `materials` 側は `security` の関数を利用する側に限定

### 6.2 禁止事項
- CODE以外でクラウド呼び出し禁止
- `/local` 中はクラウド呼び出し禁止
- 機密情報（token/secret/PII）はクラウド送信前に除外
- ログ保存時もマスク後データのみを記録

### 6.3 注入対策
- command優先、制約上書き不可
- route決定ロジックはシステム側で完結

---

## 7. ログ仕様

### 7.1 イベント種別（固定）
- `router.decision`
- `classifier.error`
- `worker.success`
- `worker.fail`
- `route.override`
- `loop.stop`
- `final.route`

### 7.2 最低保存項目
- 入力識別子（必要に応じハッシュ）
- `initial_route`, `final_route`
- `classifier_route`, `classifier_confidence`
- `worker_calls`, `needs_next_loop`, `risk`, `fit`
- `reroute_used`, `stop_reason`
- `error_reason`

### 7.3 改善データ運用
- 辞書追加/閾値調整はログ分析結果を根拠に行う

---

## 8. Prompt/宣言仕様

### 8.1 Prompt管理
- persona/policy/overlayを `実装仕様_07` の順序で連結
- system prompt はアプリ側のみが構築

### 8.2 宣言文
- route変更時のみ1行宣言
- CHATは宣言なし
- 文言:
  - CODE: コーディングするね。
  - ANALYZE: 整理して分析するね。
  - PLAN: 段取りを組むね。
  - OPS: 手順で案内するね。
  - RESEARCH: 調べてまとめるね。

---

## 9. 状態管理仕様

### 9.1 セッション
- `session_id` はチャネル単位で一意管理（Slackはthread単位推奨）

### 9.2 メモリ
- `short_memory` 中心、`recent_turns` は最小限

### 9.3 ANALYZE保存先
- 保存先を明示する:
  - 提案A: `pkg/memory/store.go` に `analyze_records` を追加
  - 提案B: `pkg/analyze/store.go` を新設
- 実装時はどちらか1つに統一

---

## 10. 設定値と閾値

- 既存 `実装仕様_01` の `config.json` を継承
- 最低設定:
  - `routing.classifier.min_confidence = 0.6`
  - `routing.classifier.min_confidence_for_code = 0.8`
  - `loop.max_loops = 3`
  - `loop.max_millis = 25000`
  - `loop.allow_auto_reroute_once = true`
  - `loop.allow_chat_propose_reroute_once = true`

---

## 11. テスト観点

### 11.1 正常系
- command優先
- rules確定
- classifier経由の安全側フォールバック
- reroute最大1回

### 11.2 異常系
- 分類器JSON不正
- ワーカーJSON不正
- `local_only` 中の CODE要求
- `risk=high` で確認停止

### 11.3 回帰
- 非対象チャネルへの副作用がないこと
- 宣言文の出し分けが維持されること

---

## 12. 既存分割仕様との関係

- `実装仕様_01`〜`07` は詳細参照として有効
- 本書で明示した統一定義を優先する:
  - WorkerOutput任意項目
  - ユーザー確認停止理由
  - 会話LLM再ルート提案IF
  - ログイベント固定
  - 分類器プロンプト固定管理
