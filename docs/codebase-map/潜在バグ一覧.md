---
generated_at: 2026-02-28T20:30:00+09:00
run_id: run_20260228_170007
phase: 2
step: "13"
profile: picoclaw_multiLLM
artifact: anomaly_list
---

# 潜在バグ一覧

## 概要

Phase 2 ボトムアップ検証で発見された潜在バグ、設計書との乖離、未実装機能、技術的負債を集約したリスト。優先度順に整理し、各項目に影響範囲、発見箇所、推奨対応を記載する。

## 関連ドキュメント

- 各モジュール解析: modules/*.md
- [アーキテクチャ総合.md](アーキテクチャ総合.md)（Phase 2 検証結果サマリー）
- [結合ポイントマップ.md](結合ポイントマップ.md)（Phase 2 追加情報）
- 実装仕様（正本）: docs/01_正本仕様/実装仕様.md

---

## 異常カテゴリ分類

- **[高]**: 機能不全またはセキュリティリスク、短期対応必須
- **[中]**: 実装品質・保守性の問題、中期対応推奨
- **[低]**: 技術的負債、長期改善で対応可

---

## 高優先度（短期対応必須）

### #1. [高] 承認後の Worker 実行委譲が未実装

**カテゴリ**: 設計書との乖離（実装仕様 6.2 節）

**発見箇所**:
- `pkg/agent/loop.go:1931` - TODO コメント「Worker による差分適用は次のフェーズで実装予定」
- `docs/codebase-map/modules/agent.md` - Phase 2 検証結果

**現状**:
- `/approve <job_id>` コマンドで承認すると、ジョブは `StatusGranted` になる
- しかし、実際に Worker が patch を適用する処理は未実装
- 承認完了メッセージのみ返却される

**影響範囲**:
- Coder3（Claude API）による計画・実装案が承認されても、実際には何も実行されない
- 承認フローが機能的に不完全

**推奨対応**:
- Phase 4 で実装予定（実装プラン参照）
- Worker への patch 適用委譲ロジックを agent/loop.go に追加
- Worker の実行結果をログ記録・ユーザーへフィードバック

**リスク評価**: 高（承認フローのコア機能が未完成）

---

### #2. [高] Auto-Approve 機能が完全未実装

**カテゴリ**: 設計書との乖離（実装仕様 6.4 節、Coder3 仕様 7章）

**発見箇所**:
- `pkg/approval/manager.go` - `StatusAutoApproved` は定義されているが使用されていない
- `docs/codebase-map/modules/approval.md` - Phase 2 検証結果

**現状**:
- `EnableAutoApprove()` / `DisableAutoApprove()` メソッドは存在しない
- `CheckAutoApprove()` 判定ロジックは存在しない
- Scope（対象タスク種別、対象パス、禁止操作）の設定なし
- TTL（有効期限）の管理なし

**影響範囲**:
- すべての破壊的操作が手動承認必須（運用効率の低下）
- Coder3 仕様で定義された Auto-Approve モードが使用できない

**推奨対応**:
- Phase 4-6 で実装予定（実装プラン参照）
- `config.Config` に `AutoApproveConfig` 型を追加
- EnableAutoApprove/DisableAutoApprove メソッドを実装
- Scope/TTL 判定ロジックを実装
- Chrome 操作（`UsesBrowser=true`）は Auto-Approve の対象外にする（例外なく承認必須）

**リスク評価**: 高（承認フローの効率化機能が未実装）

---

### #3. [高] Chrome 操作の実行ロジックが未統合（Phase 5-C）

**カテゴリ**: 未実装機能（実装仕様 5.1 節）

**発見箇所**:
- `pkg/agent/loop.go:501` - TODO コメント「Patch から Chrome 操作を検出して usesBrowser を設定」
- `pkg/mcp/client.go`, `pkg/mcp/chrome_tools.go` - Phase 5-B（クライアント実装）は完了
- `docs/codebase-map/modules/mcp.md` - Phase 2 検証結果

**現状**:
- MCP クライアントは完全に実装されている（`ChromeNavigate`, `ChromeClick`, `ChromeScreenshot`, `ChromeGetText`）
- しかし、Agent Loop との統合は未実装
- Coder3 が `uses_browser: true` を設定する仕組みなし
- Worker が patch から Chrome コマンドをパースする実装なし
- mcpClient 呼び出しと実行結果ログ記録なし

**影響範囲**:
- MCP 機能が実質的に使用できない（初期化のみ）
- ブラウザ操作を含む自動化タスクが実行不可

**推奨対応**:
- Phase 5-C で実装予定
- Coder3 出力パーサーに `uses_browser` フラグ設定ロジックを追加
- Worker に patch から Chrome コマンドをパースする実装を追加
- Agent Loop に mcpClient 呼び出しロジックと実行結果ログ記録を追加

**リスク評価**: 高（MCP 統合のコア機能が未完成）

---

### #4. [高] cost_hint フィールドが未実装

**カテゴリ**: 設計書との乖離（Coder3 仕様 8-2）

**発見箇所**:
- `pkg/approval/job.go` - `Job` 構造体に `cost_hint` フィールドなし
- `docs/codebase-map/modules/approval.md` - Phase 2 検証結果

**現状**:
- Coder3 仕様では `cost_hint` フィールド（トークン消費見積もり）が定義されている
- しかし、Job 構造体には存在しない
- コスト超過時の強制承認ロジックも未実装

**影響範囲**:
- コスト管理機能が使用できない
- 高コストの操作を事前に警告できない

**推奨対応**:
- `Job` 構造体に `CostHint` フィールドを追加（`map[string]interface{}` または構造体）
- Coder3 出力パーサーで `cost_hint` を抽出
- 承認要求メッセージにコスト情報を表示
- コスト超過時の強制承認ロジックを実装（Auto-Approve 対象外）

**リスク評価**: 高（コスト制御機能の欠如）

---

## 中優先度（中期対応推奨）

### #5. [中] 環境変数タグのテンプレート問題（要検証）

**カテゴリ**: 潜在バグ

**発見箇所**:
- `pkg/config/config.go` - `ProviderConfig` の env タグが `{{.Name}}` テンプレート形式
- `docs/codebase-map/modules/core.md` - Phase 2 検証結果（変更時の注意事項 #7）

**現状**:
- `ProviderConfig` の環境変数タグは `env:"PICOCLAW_PROVIDERS_{{.Name}}_API_KEY"` のように記述
- `caarlos0/env` ライブラリがこのテンプレートを展開するかどうか要検証
- 実際には各プロバイダー固有のタグが必要な可能性

**影響範囲**:
- 環境変数による設定上書きが正しく動作しない可能性
- API キーの読み込みに失敗するリスク

**推奨対応**:
- `caarlos0/env` ライブラリの動作を検証
- テンプレート展開が機能しない場合、各プロバイダー固有の env タグに修正
- または、環境変数パースロジックをカスタム実装

**リスク評価**: 中（環境変数設定が動作しない可能性、ただし API キー管理は機能している可能性高）

---

### #6. [中] Ollama モデルチェックの対象外（Coder3）

**カテゴリ**: 設計上の制約

**発見箇所**:
- `cmd/picoclaw/main.go:674-701` - Ollama モデルチェックのロジック
- `docs/codebase-map/modules/core.md` - Phase 2 検証結果（落とし穴 #12）

**現状**:
- Gateway 起動時の Ollama モデルチェックは Chat/Worker/Coder/Coder2 のみが対象
- Coder3（Claude API）は provider が "ollama" でないため対象外
- Coder3 の provider に誤って "ollama" を設定しても、ヘルスチェックで検出されない

**影響範囲**:
- 設定ミス時の検出が困難
- Coder3 で Ollama を使う場合（実際にはありえない）にヘルスチェックが動作しない

**推奨対応**:
- Gateway 起動時に Coder3 の provider を検証
- "ollama" が設定されている場合は警告または拒否
- または、ヘルスチェックロジックを拡張して Coder3 も対象に含める（provider に応じて適切な検証）

**リスク評価**: 中（設定ミス時の検出が困難、ただし実害は限定的）

---

### #7. [中] embed.FS のビルド時依存

**カテゴリ**: 技術的負債

**発見箇所**:
- `cmd/picoclaw/main.go:43` - `//go:embed workspace` ディレクティブ
- `docs/codebase-map/modules/core.md` - Phase 2 検証結果（落とし穴 #15）

**現状**:
- ワークスペーステンプレート（`workspace/`）は `//go:embed` でバイナリに埋め込まれる
- ビルド時に `go generate` を実行して `workspace/` をコピーする必要がある
- CI/CD 環境でビルドする際に `go generate` を実行し忘れると、埋め込みに失敗する

**影響範囲**:
- ビルド失敗またはランタイムエラー（ワークスペーステンプレート欠損）
- CI/CD パイプラインでのビルドエラー

**推奨対応**:
- CI/CD パイプラインに `go generate` ステップを追加
- ビルドスクリプトに `go generate` を組み込む
- または、埋め込みファイルの存在をユニットテストで検証

**リスク評価**: 中（ビルド環境の設定ミスで失敗する可能性）

---

### #8. [中] スキルインストールのタイムアウト不足

**カテゴリ**: 設計上の制約

**発見箇所**:
- `cmd/picoclaw/main.go:1313, L1426` - `skillsInstallCmd`, `skillsSearchCmd` のタイムアウト 30 秒
- `docs/codebase-map/modules/core.md` - Phase 2 検証結果（落とし穴 #7）

**現状**:
- `skillsInstallCmd()` と `skillsSearchCmd()` は 30 秒のタイムアウトを設定
- GitHub API のレート制限や大きなリポジトリのクローン時には不足する可能性

**影響範囲**:
- スキルインストール失敗（タイムアウトエラー）
- ユーザー体験の低下

**推奨対応**:
- タイムアウトを設定可能にする（環境変数または config）
- デフォルト値を 60-120 秒に延長
- GitHub API のレート制限エラーを検出して適切なメッセージを表示

**リスク評価**: 中（運用上の不便、ただし致命的ではない）

---

### #9. [中] MCP タイムアウト固定（config 未使用）

**カテゴリ**: 設計上の制約

**発見箇所**:
- `pkg/mcp/client.go:23-24` - HTTP クライアントのタイムアウト 30 秒ハードコード
- `pkg/config/config.go` - `MCP.Chrome.TimeoutSec` フィールド定義あり（未使用）
- `docs/codebase-map/modules/mcp.md` - Phase 2 検証結果（落とし穴 #2）

**現状**:
- MCP クライアントの HTTP タイムアウトは 30 秒でハードコード
- `config.MCP.Chrome.TimeoutSec` は参照されていない

**影響範囲**:
- ブラウザ操作が 30 秒を超えるとタイムアウト
- 設定変更でタイムアウトを調整できない

**推奨対応**:
- `NewClient` のシグネチャを変更してタイムアウトを引数で受け取る
- Agent Loop の初期化時に `cfg.MCP.Chrome.TimeoutSec` を渡す
- または、`Client.SetTimeout()` メソッドを追加

**リスク評価**: 中（運用の柔軟性低下）

---

### #10. [中] マスキング機構の不在

**カテゴリ**: セキュリティリスク（軽微）

**発見箇所**:
- `pkg/logger/logger.go:119-159` - ログ出力時のマスキング処理なし
- `docs/codebase-map/modules/infra.md` - Phase 2 検証結果

**現状**:
- API キー等の自動マスキングが未実装
- ログに平文で出力されるリスク（環境変数管理で緩和）
- 現状の設計では API キーはログに出力されない前提

**影響範囲**:
- ログファイルに API キーが誤って記録されるリスク
- 監査ログの閲覧時に機密情報が露出する可能性

**推奨対応**:
- `logger.formatFields()` にマスキング処理を追加
- `api_key`, `token`, `password`, `secret` 等のキーワードを検出して `***` でマスク
- または、フィールド名のパターンマッチングで自動マスク

**リスク評価**: 中（API キー管理は適切だが、予防的マスキングは推奨）

---

### #11. [中] ログローテーション不在

**カテゴリ**: 技術的負債

**発見箇所**:
- `pkg/logger/logger.go:119-124` - append モードで追記し続ける
- `docs/codebase-map/modules/infra.md` - Phase 2 検証結果

**現状**:
- ログファイルは append モードで追記し続ける
- ローテーション機構なし
- 長時間稼働でログファイルが肥大化

**影響範囲**:
- ディスク容量の圧迫
- ログファイルの解析が困難

**推奨対応**:
- サイズベースのローテーション（例: 100MB ごとに分割）
- 日付ベースのローテーション（例: 日次で新ファイル作成）
- 外部ツール（logrotate）による緩和も可

**リスク評価**: 中（長時間稼働時の運用負荷）

---

## 低優先度（長期改善）

### #12. [低] 再ルーティング機能の未実装

**カテゴリ**: 設計書との乖離（実装仕様 3.3 節）

**発見箇所**:
- `docs/codebase-map/modules/agent.md` - Phase 2 検証結果（設計書との乖離 #3）

**現状**:
- 実装仕様 3.3 節で定義されている再ルーティング機能（`fit=false` かつ `suggested_route` 有効時）は未実装
- `max_reroute=1` の制約のみコメントに記載

**影響範囲**:
- ルーティング決定の柔軟性低下
- 分類器の誤判定を修正する仕組みがない

**推奨対応**:
- 実装仕様 3.3 節に従って再ルーティングロジックを実装
- LLM が `fit=false`, `suggested_route` を返した場合に再ルート
- 最大 1 回の制約を厳守（無限ループ防止）

**リスク評価**: 低（現状でもルーティングは機能、改善の余地あり）

---

### #13. [低] 会話LLM提案IF の未実装

**カテゴリ**: 設計書との乖離（実装仕様 3.4 節）

**発見箇所**:
- `docs/codebase-map/modules/agent.md` - Phase 2 検証結果（設計書との乖離 #4）

**現状**:
- 実装仕様 3.4 節で定義されている会話LLM提案IF（`{"propose_next_loop": false, "route": "...", ...}`）は未実装

**影響範囲**:
- Chat LLM がユーザーに対して次のアクションを提案する機能がない
- ユーザー体験の改善機会損失

**推奨対応**:
- 実装仕様 3.4 節に従って提案IF を実装
- Chat LLM の出力に `propose_next_loop` フィールドを追加
- Agent Loop で提案を解析してユーザーに選択肢を提示

**リスク評価**: 低（現状でも会話は機能、UX 改善の余地あり）

---

### #14. [低] WorkerInput/Output スキーマの未実装

**カテゴリ**: 設計書との乖離（実装仕様 4.3, 4.4 節）

**発見箇所**:
- `docs/codebase-map/modules/agent.md` - Phase 2 検証結果（設計書との乖離 #5）

**現状**:
- 実装仕様 4.3, 4.4 節で定義されている Worker 統一 JSON 契約（`needs_next_loop`, `fit`, `suggested_route` 等）は未実装
- 現状は LLM が直接ツールを呼び出す設計で、Worker 専用出力契約は未適用

**影響範囲**:
- Worker の出力が統一されていない
- ループ制御の柔軟性低下

**推奨対応**:
- Worker 専用の入出力スキーマを定義
- providers.ToolResult を拡張して Worker 出力契約に対応
- Agent Loop で Worker 出力を解析してループ制御に反映

**リスク評価**: 低（現状でも Worker は機能、設計の洗練度向上）

---

### #15. [低] タイムゾーンハードコード

**カテゴリ**: 設計上の制約

**発見箇所**:
- `pkg/agent/memory.go:18` - `CutoverTimezone = "Asia/Tokyo"` ハードコード
- `docs/codebase-map/modules/agent.md`, `modules/session.md` - Phase 2 検証結果

**現状**:
- 日次カットオーバーの 04:00 JST が `Asia/Tokyo` ハードコード
- グローバル展開時にタイムゾーン設定が必要

**影響範囲**:
- 日本国外での運用時にカットオーバータイミングが不適切
- ユーザーのローカルタイムゾーンに合わせられない

**推奨対応**:
- `config.Config` に `CutoverTimezone` フィールドを追加
- デフォルト値は `Asia/Tokyo`
- カットオーバー処理で設定値を参照

**リスク評価**: 低（日本国内運用では問題なし、グローバル展開時のみ対応必要）

---

### #16. [低] 設定ホットリロード未サポート

**カテゴリ**: 技術的負債

**発見箇所**:
- `pkg/config/config.go` - 起動時のみ読み込み
- `docs/codebase-map/アーキテクチャ総合.md` - Phase 2 検証結果

**現状**:
- 設定ファイルは起動時のみ読み込み
- 実行中の再読み込み不可
- 設定変更には再起動が必要

**影響範囲**:
- 設定変更時の運用負荷（再起動によるサービス中断）

**推奨対応**:
- SIGHUP シグナル受信時の設定再読み込み機能を実装
- 設定変更を検知して自動リロード
- または、`/config/reload` エンドポイントを追加

**リスク評価**: 低（現状でも運用可能、利便性向上の余地あり）

---

### #17. [低] 承認ジョブの永続化なし

**カテゴリ**: 設計上の制約

**発見箇所**:
- `pkg/approval/manager.go` - in-memory 実装（`map[string]*Job`）
- `docs/codebase-map/modules/approval.md` - Phase 2 検証結果

**現状**:
- 承認ジョブは in-memory 実装
- プロセス再起動でジョブ情報消失
- 承認待ち中の再起動で承認状態が失われる

**影響範囲**:
- 再起動時に承認待ちジョブが消失
- 監査ログの不完全性

**推奨対応**:
- Obsidian 連携による永続化（session パッケージと同様）
- または、DB（SQLite）への永続化
- 起動時に永続化されたジョブをロード

**リスク評価**: 低（現状でも運用可能、監査ログは logger で記録される）

---

## 補足: Phase 2 検証での主要発見

### 実装品質の高さ

- Phase 1-3 で実装された機能は堅牢（テストカバレッジ高、エラーハンドリング適切）
- 未実装機能は TODO コメントや実装プランで明確に記録されており、意図的な段階的実装

### 設計書との一貫性

- 基本設計は実装仕様に準拠
- 未実装箇所は Phase 計画通り
- 設計書との乖離は明示的に文書化されている

### コード品質

- Go の慣用句に従った実装
- 並行アクセス制御は適切（RWMutex, ディープコピー）
- ログイベントは 45 種類を網羅

---

## 次のアクション

### 短期（Phase 5-C, Phase 4）

1. **MCP 統合完了**（#3）: Chrome 操作の実行ロジック実装
2. **承認フロー完成**（#1, #2, #4）: Worker 実行委譲、Auto-Approve、cost_hint 実装
3. **環境変数タグ検証**（#5）: `caarlos0/env` の動作確認

### 中期（Phase 6）

4. **マスキング機構**（#10）: API キー・トークンの自動マスキング
5. **ログローテーション**（#11）: サイズ・日付ベースのローテーション
6. **設定ホットリロード**（#16）: SIGHUP シグナル受信時の設定再読み込み

### 長期（Phase 7+）

7. **永続化強化**（#17）: 承認ジョブの DB 永続化
8. **タイムゾーン設定可能化**（#15）: カットオーバー時刻の設定ファイル化
9. **再ルーティング・LLM提案IF**（#12, #13, #14）: 高度なルーティング機能実装

---

**最終更新**: 2026-02-28（Phase 2 検証完了）
**総異常数**: 17 項目（高優先度 4, 中優先度 7, 低優先度 6）
**解析対象**: 全 7 モジュール（core, agent, approval, llm_provider, session, mcp, infra）
