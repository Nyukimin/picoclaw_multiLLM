# 承認フロー削除箇所リスト

**作成日**: 2026-02-28
**目的**: 承認フロー廃止に伴う削除対象コードの詳細リスト
**関連仕様**: [20260228_承認フロー廃止プラン.md](./20260228_承認フロー廃止プラン.md)

---

## 概要

このドキュメントは、承認フロー廃止に伴って削除すべきコードの正確な行番号と内容を記載したものです。
実装時はこのリストに従って慎重に削除を実行してください。

**総削除行数**: 約 590 行（pkg/approval/ 全体を含む）

---

## 1. pkg/approval/ ディレクトリ全体削除

### 削除対象ファイル

| ファイル名 | 行数 | 内容 |
|-----------|------|------|
| `pkg/approval/job.go` | 19 行 | job_id 生成関数 |
| `pkg/approval/manager.go` | 151 行 | 承認ジョブ管理（Manager, Job 構造体） |
| `pkg/approval/message.go` | 36 行 | 承認要求メッセージフォーマット |
| `pkg/approval/job_test.go` | 推定 100 行 | job.go のテスト |
| `pkg/approval/manager_test.go` | 推定 300 行 | manager.go のテスト |

### 削除コマンド

```bash
# pkg/approval/ ディレクトリごと削除
rm -rf pkg/approval/
```

---

## 2. pkg/agent/loop.go 修正箇所

### 2.1 import 文削除

**行番号**: L25
**削除内容**:
```go
"github.com/sipeed/picoclaw/pkg/approval"
```

---

### 2.2 AgentLoop 構造体フィールド削除

**行番号**: L59
**削除内容**:
```go
approvalMgr    *approval.Manager
```

---

### 2.3 NewAgentLoop 初期化コード削除

**行番号**: L224
**削除内容**:
```go
approvalMgr:    approval.NewManager(),
```

---

### 2.4 Coder3 出力の承認処理ブロック削除

**行番号**: L497-L520
**削除内容**:
```go
} else if coderOutput.NeedApproval {
	// 承認が必要な場合
	jobID := approval.GenerateJobID()

	// 承認ジョブを作成
	createErr := al.approvalMgr.CreateJob(jobID, coderOutput.Plan, coderOutput.Patch, coderOutput.Risk, usesBrowser)
	if createErr != nil {
		logger.ErrorCF("agent", "approval.create_job_error", map[string]interface{}{
			"job_id": jobID,
			"error":  createErr.Error(),
		})
		response = fmt.Sprintf("承認ジョブの作成に失敗したよ: %v", createErr)
	} else {
		// session に job_id を保存
		flags.PendingApprovalJobID = jobID
		al.sessions.SetFlags(sessionKey, flags)
		al.sessions.Save(sessionKey)

		// 承認要求ログを記録
		logger.LogApprovalRequested(jobID, coderOutput.Plan, coderOutput.Patch, coderOutput.Risk)

		// 承認要求メッセージを生成
		job, _ := al.approvalMgr.GetJob(jobID)
		response = approval.FormatApprovalRequest(job)
	}
```

**置き換え内容**:
- 削除後は「即時実行ロジック」に置き換え（Task #15 で設計）

---

### 2.5 /approve コマンドハンドラ削除

**行番号**: L1917-L1925
**削除内容**:
```go
case RouteApprove:
	if len(parts) < 2 {
		response = "/approve <job_id> の形式で指定してね。"
		break
	}
	jobID := strings.TrimSpace(parts[1])
	err := al.approvalMgr.Approve(jobID, msg.SenderID)
	if err != nil {
		response = fmt.Sprintf("承認に失敗したよ: %v", err)
		break
	}
	logger.LogApprovalGranted(jobID, msg.SenderID)

	// 承認後の実行ロジック（Worker 呼び出し）は未実装
	job, err := al.approvalMgr.GetJob(jobID)
```

---

### 2.6 /deny コマンドハンドラ削除

**行番号**: L1940-L1947
**削除内容**:
```go
case RouteDeny:
	if len(parts) < 2 {
		response = "/deny <job_id> の形式で指定してね。"
		break
	}
	jobID := strings.TrimSpace(parts[1])
	err := al.approvalMgr.Deny(jobID, msg.SenderID)
	if err != nil {
		response = fmt.Sprintf("拒否に失敗したよ: %v", err)
		break
	}
	logger.LogApprovalDenied(jobID, msg.SenderID)
	response = fmt.Sprintf("job %s を拒否したよ。", jobID)
```

---

### 2.7 CoderOutput 構造体の NeedApproval フィールド削除

**行番号**: L1960
**削除内容**:
```go
NeedApproval bool                   `json:"need_approval"`
```

**注意**: この行は CoderOutput 構造体の定義の一部。削除時は構造体全体の整合性を確認すること。

---

## 3. pkg/agent/router.go 修正箇所

### 3.1 ルート定数削除

**行番号**: L22-L23
**削除内容**:
```go
RouteApprove  = "APPROVE"
RouteDeny     = "DENY"
```

---

### 3.2 parseRouteCommand 内の承認コマンド解析削除

**行番号**: L237-L240
**削除内容**:
```go
case "/approve":
	return RouteApprove, nextLocalOnly, "", rest, true
case "/deny":
	return RouteDeny, nextLocalOnly, "", rest, true
```

---

## 4. pkg/session/manager.go 修正箇所

### 4.1 SessionFlags 構造体フィールド削除

**行番号**: L31
**削除内容**:
```go
PendingApprovalJobID string `json:"pending_approval_job_id,omitempty"` // 承認待ちの job_id
```

**注意**: コメントも含めて削除すること。

---

## 5. pkg/logger/logger.go 修正箇所

### 5.1 承認関連ログ関数すべて削除

**行番号**: L241-L284
**削除内容**:
```go
// Approval-related logging helpers

// LogApprovalRequested は承認要求のログを記録
func LogApprovalRequested(jobID, plan, patch string, risk map[string]interface{}) {
	InfoCF("approval", "approval.requested", map[string]interface{}{
		"job_id": jobID,
		"plan":   plan,
		"patch":  patch,
		"risk":   risk,
	})
}

// LogApprovalGranted は承認許可のログを記録
func LogApprovalGranted(jobID, approver string) {
	InfoCF("approval", "approval.granted", map[string]interface{}{
		"job_id":   jobID,
		"approver": approver,
	})
}

// LogApprovalDenied は承認拒否のログを記録
func LogApprovalDenied(jobID, approver string) {
	InfoCF("approval", "approval.denied", map[string]interface{}{
		"job_id":   jobID,
		"approver": approver,
	})
}

// LogApprovalAutoApproved は自動承認のログを記録
func LogApprovalAutoApproved(jobID, reason string) {
	InfoCF("approval", "approval.auto_approved", map[string]interface{}{
		"job_id": jobID,
		"reason": reason,
	})
}

// LogCoderPlanGenerated は Coder による plan/patch 生成のログを記録
func LogCoderPlanGenerated(jobID, plan string) {
	InfoCF("coder", "coder.plan_generated", map[string]interface{}{
		"job_id": jobID,
		"plan":   plan,
	})
}
```

**注意**: コメントを含む全 44 行を削除すること。

---

### 5.2 追加する Worker 関連ログ関数

**追加位置**: L241（削除後の末尾）
**追加内容**:
```go
// Worker-related logging helpers

// LogWorkerSuccess は Worker 実行成功のログを記録
func LogWorkerSuccess(patch, result string) {
	InfoCF("worker", "worker.success", map[string]interface{}{
		"patch":  patch,
		"result": result,
	})
}

// LogWorkerFail は Worker 実行失敗のログを記録
func LogWorkerFail(patch string, err error) {
	ErrorCF("worker", "worker.fail", map[string]interface{}{
		"patch": patch,
		"error": err.Error(),
	})
}
```

---

## 6. cmd/picoclaw/main.go 修正箇所

**該当なし**

main.go には承認関連のコードが存在しません。
approval.Manager の初期化は pkg/agent/loop.go:L224 で行われています。

---

## 7. 削除検証チェックリスト

削除後、以下を確認すること:

- [ ] `pkg/approval/` ディレクトリが完全に削除されている
- [ ] `pkg/agent/loop.go` から approval import が削除されている
- [ ] `pkg/agent/loop.go` の approvalMgr フィールドが削除されている
- [ ] `pkg/agent/router.go` から RouteApprove/RouteDeny が削除されている
- [ ] `pkg/session/manager.go` から PendingApprovalJobID が削除されている
- [ ] `pkg/logger/logger.go` から LogApproval* 関数が削除されている
- [ ] `go build ./cmd/picoclaw` がエラーなく成功する
- [ ] `go test ./pkg/...` で全テストが通過する

---

## 8. 補足: 削除に伴う影響範囲

### 8.1 削除される機能

- `/approve <job_id>` コマンド
- `/deny <job_id>` コマンド
- 承認要求メッセージの生成
- job_id ベースのジョブ追跡
- 承認ステータス管理（pending, granted, denied, auto_approved）

### 8.2 削除されないもの（保持）

- Coder3 による plan/patch 生成機能
- ルーティング機能（CHAT/WORKER/CODE1/CODE2/CODE3）
- セッション管理
- ログ記録（worker.success/worker.fail に置き換え）

---

## 9. 次のステップ

このリストに基づいて削除を実行した後:

1. **Task #15**: Worker 実行ロジックの設計を実行
2. **実装**: 設計に基づいて即時実行ロジックを実装
3. **テスト**: ユニットテストと統合テストで検証
4. **ドキュメント更新**: 実装仕様・運用仕様を更新

---

**最終更新**: 2026-02-28
**作成者**: Claude (Serena Agent)
**関連ドキュメント**: [20260228_承認フロー廃止プラン.md](./20260228_承認フロー廃止プラン.md)
