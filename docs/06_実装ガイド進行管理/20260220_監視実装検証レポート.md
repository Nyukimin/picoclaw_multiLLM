# 常駐監視実装 検証レポート

作成日時（JST）: 2026-02-20

## 検証項目と結果

### 1) 構文/単体レベル
- 検証項目: `scripts/ops_watchdog.sh` のbash構文
  - 期待結果: 構文エラーなし
  - 実結果: `bash -n scripts/ops_watchdog.sh` 成功
  - 差異: なし

- 検証項目: 設定構造の回帰
  - 期待結果: `pkg/config` テスト通過
  - 実結果: `go test ./pkg/config` 成功
  - 差異: なし

- 検証項目: 監視ロジックの非破壊シナリオテスト（モック）
  - 期待結果: 主要分岐が想定通り動作する
  - 実結果: `bash scripts/tests/watchdog_mock_test.sh` 成功
    - `[1/4] healthy scenario`
    - `[2/4] health failure triggers restart`
    - `[3/4] ollama 3rd failure suppresses restart`
    - `[4/4] kick request triggers gateway restart`
    - `PASS: watchdog mock tests`
  - 差異: なし

- 検証項目: キック入力経路の構文健全性
  - 期待結果: キックスクリプトが構文エラーなく実行可能
  - 実結果: `bash -n scripts/ops_watchdog_kick.sh` 成功
  - 差異: なし

### 2) 仕様適合チェック（実装レビュー）
- 検証項目: Gateway再起動制御（10分3回 + バックオフ）
  - 期待結果: 上限/待機が実装される
  - 実結果: `restart_gateway_guarded` で実装済み
  - 差異: なし

- 検証項目: Ollama連続失敗の段階対応
  - 期待結果: 1回再試行、2回Gateway再起動、3回以上アラートのみ
  - 実結果: `check_ollama` で実装済み
  - 差異: なし

- 検証項目: Funnel復旧フロー
  - 期待結果: `--bg` 再公開、未復旧なら `reset -> --bg`
  - 実結果: `recover_funnel` で実装済み
  - 差異: なし

- 検証項目: LINE通知（通知専用）
  - 期待結果: 閾値超過系のみ通知、クールダウンあり
  - 実結果: `alert_with_cooldown` + `send_line_push` で実装済み
  - 差異: なし

## 未実施の実運用テスト
- 疑似障害を伴う実機検証（Gateway停止、Funnel無効化、Ollama停止）は、環境影響を避けるため本変更では未実行。
- 実運用導入後に以下を順次実施する:
  1. `make enable-watchdog` 後に Gateway プロセス停止を発生させ、2分以内復帰確認
  2. `tailscale funnel reset` 実行で再公開確認
  3. Ollama停止で連鎖再起動抑制と通知確認

## 補足
- 現環境では `make` コマンドが未導入のため、モック試験は `bash scripts/tests/watchdog_mock_test.sh` で直接実施した。

## 本番組み込み実施ログ
- 実施内容:
  1. `~/.local/share/picoclaw/scripts/` へ watchdog/kick スクリプト配置
  2. `~/.config/systemd/user/` へ service/timer 配置
  3. `systemctl --user daemon-reload`
  4. `systemctl --user enable --now picoclaw-watchdog.timer`
- 実結果:
  - timer 有効化成功（`enabled`）
  - `picoclaw-watchdog.service` は oneshot 実行で `status=0/SUCCESS`
- 差異:
  - `~/.picoclaw/.env` は未配置のため、監視はデフォルト設定で動作中（`EnvironmentFile` は optional 設定）

## 対応策
- 本番反映前に、運用メンテナンス時間帯で上記の疑似障害テストを必ず実施する。
- `sudo -n tailscale` が失敗する場合は sudoers を調整する。
