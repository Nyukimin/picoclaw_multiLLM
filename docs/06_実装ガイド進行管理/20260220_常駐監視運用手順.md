# 常駐監視・ヘルスチェック・自動復旧 実装/運用手順

作成日時（JST）: 2026-02-20

## 1. 目的
- `systemd --user` を主系として、Gateway / Health / Funnel / Ollama の監視を自動運用する。
- 障害時は段階的に自己復旧し、連続障害・上限超過時のみ LINE に運用通知する。
- RAM 8GB 制約を守るため、状態・ログは `~/.picoclaw` 配下にディスク保存する。

## 2. 実装ファイル
- 監視スクリプト: `scripts/ops_watchdog.sh`
- systemd unit: `systemd/user/picoclaw-watchdog.service`
- systemd timer: `systemd/user/picoclaw-watchdog.timer`
- Make導線: `Makefile` (`install-watchdog`, `enable-watchdog`, `watchdog-status` など)
- 設定キー: `pkg/config/config.go` `WatchdogConfig`
- 設定例: `.env.example`

## 3. 監視対象と判定
1. Gateway プロセス/ポート
   - `systemctl --user is-active picoclaw-gateway.service`
   - LISTEN: `18790` / `18791`
2. Health/Ready
   - `GET /health == 200`
   - `GET /ready == 200`
3. Tailscale Funnel
   - `tailscale funnel status` に `Funnel on` と `proxy http://127.0.0.1:18791`
4. Webhook 到達性
   - `GET /webhook/line == 405`
5. Ollama 疎通
   - `GET /v1/models == 200`

## 4. 自動復旧ポリシー
- Gateway 再起動上限: 10分で最大3回
- バックオフ: 1回目即時 / 2回目10秒 / 3回目30秒
- Health/Ready 連続2回失敗で `journalctl --user -u picoclaw-gateway.service -n 200` を採取
- Ollama 連続失敗:
  - 1回: 10秒後再試行
  - 2回: Gateway再起動
  - 3回以上: Gateway再起動抑制 + LINE通知
- Funnel 異常:
  - `sudo -n tailscale funnel --bg 18791`
  - 未復旧なら `tailscale funnel reset` 後に再実行

## 5. LINE 通知（通知専用）
- 本実装は既定で「通知のみ」。ただし運用判断で手動キック経路を有効化できる。
- 通知トリガ:
  - Gateway再起動上限超過
  - Gateway再起動失敗
  - Health連続失敗
  - Funnel復旧失敗
  - Ollama連続失敗（3回以上）
- 通知スパム防止として障害別クールダウンを適用。

## 6. 導入手順
1. 監視関連をインストール
   - `make install-watchdog`
2. timer を有効化
   - `make enable-watchdog`
3. 状態確認
   - `make watchdog-status`
4. 本番組み込み確認
   - `systemctl --user is-enabled picoclaw-watchdog.timer`
   - `systemctl --user list-timers | rg picoclaw-watchdog`

### 6.1 具体的な初期設定（推奨）
1. `config/watchdog.env.example` を `~/.picoclaw/.env` にコピーする
2. 最低限、次の3項目を埋める
   - `PICOCLAW_WATCHDOG_LINE_NOTIFY_ENABLED`
   - `PICOCLAW_WATCHDOG_LINE_NOTIFY_TO`
   - `PICOCLAW_CHANNELS_LINE_CHANNEL_ACCESS_TOKEN`
3. 反映確認
   - `systemctl --user daemon-reload`
   - `make watchdog-run-once`

### 6.2 本番組み込み（最短）
1. `cp config/watchdog.env.example ~/.picoclaw/.env`
2. 必須値を編集（通知先、トークン）
3. `make install-watchdog`
4. `make enable-watchdog`
5. `make watchdog-status`

## 7. 主要設定（.env）
- `PICOCLAW_WATCHDOG_ENABLED=true`
- `PICOCLAW_WATCHDOG_INTERVAL_SEC=60`
- `PICOCLAW_WATCHDOG_RESTART_WINDOW_SEC=600`
- `PICOCLAW_WATCHDOG_RESTART_MAX_COUNT=3`
- `PICOCLAW_WATCHDOG_LINE_NOTIFY_ENABLED=true|false`
- `PICOCLAW_WATCHDOG_LINE_NOTIFY_TO=<LINE User/Group ID>`
- `PICOCLAW_CHANNELS_LINE_CHANNEL_ACCESS_TOKEN=<token>`

## 8. 運用ログ/状態
- 監視ログ: `~/.picoclaw/logs/ops-watchdog.log`
- 監視状態: `~/.picoclaw/state/watchdog/`
  - `restart_gateway_times.log`
  - `health_fail_count`
  - `ollama_fail_count`
  - `webhook_fail_count`
  - `alert_*.ts`

## 9. 検証項目（疑似障害）
1. Gateway停止: 2分以内の復帰
2. Funnel無効化: 2分以内の再公開
3. Ollama疎通断: 再起動ループ抑制
4. 連続稼働: 24hでwatchdog自体が停止しないこと

### 9.1 非破壊テスト（モック）
- コマンド: `make test-watchdog-mock`
- テスト内容:
  - 正常時に再起動しない
  - Health異常時にGateway再起動する
  - Ollama連続3回目相当で再起動を抑止する

## 11. LINEキック経路（任意）
- キックは「監視スクリプトへの要求キュー投入」で実現する。
- 要求は `~/.picoclaw/state/watchdog/kick_request` に1件書き込み（watchdogが次回周期で処理）。
- 認可は `PICOCLAW_WATCHDOG_KICK_TOKEN` で保護する。

### 11.1 有効化
- `PICOCLAW_WATCHDOG_KICK_ENABLED=true`
- `PICOCLAW_WATCHDOG_KICK_TOKEN=<十分長いランダム文字列>`

### 11.2 実行コマンド
- 直接実行:
  - `bash ~/.local/share/picoclaw/scripts/ops_watchdog_kick.sh restart_gateway line <token>`
- Make経由:
  - `make watchdog-kick ACTION=restart_gateway SOURCE=line TOKEN=<token>`

### 11.3 許可アクション
- `restart_gateway`
- `recover_funnel`
- `check_ollama`

### 11.4 LINE連携の実運用案
- LINEメッセージを受けたWorker/Coder経路で、認可済みの場合のみ `watchdog-kick` を実行する。
- 監査のため、実行時は `SOURCE=line:<chat_or_user_id>` を必ず付与する。

## 10. 注意点
- `tailscale funnel` の自動復旧は `sudo -n` 実行を前提にする。必要に応じて sudoers 設定を行う。
- 通知先 ID は運用専用チャネルを推奨する。
