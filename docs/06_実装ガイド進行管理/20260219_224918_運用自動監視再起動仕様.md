# Gateway/Ollama/Tailscale 自動監視・再起動仕様（2026-02-19 更新版）

## 概要
- 目的: `picoclaw gateway` の常駐運用を安定化し、障害時の検知と自動復旧を行う。
- 対象: Gateway（systemd）、Tailscale Funnel、Ollama疎通、Webhook/Health の到達性。
- 方針: 「定期チェック -> 異常判定 -> 段階的再起動 -> 復旧確認」を統一フロー化する。

## 絶対条件（ハード制約）
- 本運用は **RAM 8GB 環境を前提** とし、メモリ浪費を禁止する。
- 永続化可能な情報（ログ、状態、一時ファイル）は **基本HDDへ書き出す**。
- メモリ使用量が閾値を超えた場合は、優先順位を以下とする:
  1. 不要な一時データ破棄
  2. ログ/状態のディスク退避
  3. プロセス再起動（自動復旧ポリシーに従う）
- 監視・復旧実装は、この制約に反する設計（メモリ常駐の肥大化）を採用しない。

## 対象コンポーネント
- `picoclaw-gateway.service`（`systemd --user`）
- `tailscale funnel`（`https://fujitsu-ubunts.tailb07d8d.ts.net -> 127.0.0.1:18791`）
- `Gateway health endpoint`（`http://127.0.0.1:18790/health` と `/ready`）
- `LINE webhook endpoint`（`https://fujitsu-ubunts.tailb07d8d.ts.net/webhook/line`）
- `Ollama API`（`http://100.83.207.6:11434/v1`）

## 監視要件
### 1. Gateway プロセス監視
- 判定条件:
  - `systemctl --user is-active picoclaw-gateway.service` が `active` であること。
  - `ss -lntp` で `18790` と `18791` が LISTEN であること。
- 異常時アクション:
  - `systemctl --user restart picoclaw-gateway.service`
  - 復旧判定を 5 秒後に再実施。

### 2. Health/Ready 監視
- 判定条件:
  - `GET http://127.0.0.1:18790/health` が `200`
  - `GET http://127.0.0.1:18790/ready` が `200`
- 異常時アクション:
  - 1回目: `systemctl --user restart picoclaw-gateway.service`
  - 2回連続失敗: `journalctl --user -u picoclaw-gateway.service -n 200` を採取し、アラート記録。

### 3. Tailscale Funnel 監視
- 判定条件:
  - `tailscale funnel status` に以下が含まれること:
    - `Funnel on`
    - `proxy http://127.0.0.1:18791`
- 異常時アクション:
  - `sudo tailscale funnel --bg 18791` で再公開。
  - 再判定で未復旧なら `tailscale funnel reset` -> `sudo tailscale funnel --bg 18791`。

### 4. Webhook 到達性監視
- 判定条件:
  - `GET https://fujitsu-ubunts.tailb07d8d.ts.net/webhook/line` が `405`（POST専用として正常）。
- 異常時アクション:
  - Funnel 側設定不整合として扱い、Tailscale復旧フローを実行。

### 5. Ollama 疎通監視
- 判定条件:
  - `GET http://100.83.207.6:11434/v1/models` が `200`
- 異常時アクション:
  - 一時失敗（1回）: 10秒待機後に再試行。
  - 連続失敗（2回）: Gateway再起動（依存復旧）を実施。
  - 連続失敗（3回以上）: リモートOllama障害としてアラートのみ（Gateway連続再起動抑制）。

## 自動復旧ポリシー
- 再起動上限:
  - Gateway は 10分間で最大3回まで。
  - 上限超過時は自動再起動停止 + アラート発報。
- バックオフ:
  - 1回目: 即時、2回目: 10秒、3回目: 30秒。
- 連鎖障害抑制:
  - Ollama未復旧時に Gateway を無制限再起動しない。

## 実行周期・タイムアウト
- 監視周期: 60秒（初期値）
- APIタイムアウト:
  - ローカルHTTP（health/ready）: 3秒
  - 外部HTTPS（funnel URL）: 5秒
  - リモートOllama: 5秒

## ログ・監査要件
- ログ出力先:
  - 常時: `journalctl --user -u picoclaw-gateway.service`
  - 監視スクリプト専用ログ: `~/.picoclaw/logs/ops-watchdog.log`
  - Gateway標準ログ: `~/.picoclaw/logs/gateway.log`（systemd append）
- 1回の判定で記録する項目:
  - チェック時刻（JST）
  - 対象（gateway/health/funnel/ollama）
  - 判定結果（OK/NG）
  - 実行アクション（none/restart/recover）
  - 復旧成否

## 通知要件（段階導入）
- Phase 1: ログ記録のみ（手動確認）
- Phase 2: 失敗連続時に LINE へ運用通知（別チャンネル）
- Phase 3: 日次サマリ（稼働率、再起動回数、失敗理由ランキング）

## 実装単位（次段で着手するタスク）
1. 監視スクリプト仕様確定（bash）  
2. `systemd --user` timer/service の追加（watchdog 常駐）  
3. 再起動制御（上限・バックオフ・状態ファイル、HDD保存）  
4. ログ整形と障害レポート出力  
5. 総合テスト（疑似障害: port占有、funnel無効化、Ollama停止）

## 受け入れ条件（Definition of Done）
- Gateway停止時、2分以内に自動復帰する。
- Funnel無効時、2分以内に再公開される。
- Health/Ready異常時、原因ログと復旧アクションが残る。
- Ollama疎通断時、連続再起動ループに陥らない。
- 24時間連続稼働で監視処理自体が停止しない。

## LINE 会話経路仕様（最新）
### 1) Kuro 会話継続
- セッションファイル `~/.picoclaw/workspace/sessions/line_<chat_id>.json` を会話文脈として継続利用する。
- `CHAT` ルートでは自動要約を無効化し、会話履歴を優先して継続性を確保する。
- Kuro人格は `CHAT_PERSONA.md` を最優先とし、汎用ヘルプデスク調の自己説明を抑制する。

### 2) LINE 送信モード
- 通常返信は **Push API固定**（通常発信）とする。
- 標準運用では Reply API を使わない。

### 3) 特別対応: 依頼元IDリプライ
- Worker/Coder に繋がる入力（`CHAT` 以外のルート）を受けた時点で、受信 `message_id` を「依頼元ID」として記録する。
- 保存先はセッションフラグ:
  - `origin_message_id`
  - `origin_route`
  - `pending_origin_reply`
- Worker/Coder 完了時に `pending_origin_reply=true` かつ `origin_message_id` がある場合、
  - 完了報告は該当IDへのリプライ（quoteToken利用）で返す。
  - 返送後は `pending_origin_reply=false` にして一回消費する。
- 該当IDリプライが使えない場合は通常Pushへフォールバックする。

### 4) セッション運用
- 人格崩れ・文脈汚染時は対象セッションJSONを削除して再初期化する。
- 長期記憶は別管理とし、本仕様の対象は会話継続の短中期コンテキストに限定する。

## 8GB 制約のエージェント適用（運用固定）
- Chat / Worker / Coder の最上位指示として以下を固定する:
  - RAM 8GB制約を厳守
  - 情報は基本HDDへ書き出し
  - `spawn` / `subagent` 禁止
- 実装反映:
  - サービス側 `MemoryHigh/MemoryMax`, `GOMEMLIMIT`, `TMPDIR` を設定
  - ツール登録から `spawn` / `subagent` を除外（現在 `Tools: 11 loaded`）

## 既知障害の修復仕様（cron）
- 症状: `failed to load store: unexpected end of JSON input`
- 対応:
  - `cron/jobs.json` が空または破損JSONの場合に自動修復する。
  - 修復内容は空ストア `{ "version": 1, "jobs": [] }` へ再生成・保存。
