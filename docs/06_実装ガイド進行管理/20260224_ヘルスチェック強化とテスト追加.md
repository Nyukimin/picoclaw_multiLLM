# 2026-02-24 変更サマリー：ヘルスチェック強化とテスト追加

最終更新: 2026-02-24

## 変更概要

Ollama モデル管理の堅牢性向上とテストカバレッジ改善を目的とした一連の変更を実施。

## 主要変更

### 1. Ollama コンテキストサイズ制約の追加

#### 1.1 問題
- Ollama モデルのロード時、`num_ctx` が大きすぎると失敗する
- 例: `num_ctx: 131072` でロードすると、メモリ不足やタイムアウトが発生

#### 1.2 解決策
- `ModelRequirement` に `MaxContext` フィールドを追加
- `MaxContext: 8192` を設定し、これを超える `context_length` のモデルは NG と判定
- ヘルスチェック時に自動検出して再起動トリガー

#### 1.3 実装箇所
- `pkg/health/checks.go`: `MaxContext` フィールド追加
- `pkg/agent/loop.go`: `buildOllamaRequiredModels()` で `MaxContext: 8192` を設定
- `cmd/picoclaw/main.go`: gateway 起動時にも同様の制約を適用

#### 1.4 コード例
```go
type ModelRequirement struct {
    Name       string // モデル名（例: chat-v1:latest）
    MinContext int    // 0 でなければ、これ未満は NG
    MaxContext int    // 0 でなければ、これを超えると NG（例: 8192 で 131072 は NG）
}

required := []health.ModelRequirement{
    {Name: "chat-v1:latest", MaxContext: 8192},
    {Name: "worker-v1:latest", MaxContext: 8192},
}
```

### 2. ヘルスチェック強化

#### 2.1 モデル未ロード検出の強化
従来:
- Ollama サーバーの疎通確認のみ

新規:
- Ollama サーバー疎通確認
- **モデルのロード状況確認**
- **モデルの context_length 制約確認**

#### 2.2 実装
`pkg/agent/loop.go` の `processMessage()` 内:
```go
// LINE指示ごと: ヘルスチェック（失敗してなくても実行）
//   → Ollama落ち/モデル未ロードなら再起動
//   → リトライ
ollamaOK, ollamaMsg := health.OllamaCheck(checkURL, 5*time.Second)()
required := al.buildOllamaRequiredModels()
modelsOK, modelsMsg := true, ""
if len(required) > 0 {
    modelsOK, modelsMsg = health.OllamaModelsCheck(checkURL, 5*time.Second, required)()
}
needsRestart := !ollamaOK || !modelsOK
if needsRestart && strings.TrimSpace(al.cfg.Providers.OllamaRestartCommand) != "" {
    // 再起動実行
}
```

### 3. CHAT_PERSONA 優先読み込み

#### 3.1 問題
- 共有ファイル（AGENTS.md、USER.md）が先に読まれるため、キャラクター個性が薄まる

#### 3.2 解決策
- CHAT ルート時、`CHAT_PERSONA.md` を**最優先**で読み込む
- その後 `PrimerMessage.md`、最後に共有ファイル

#### 3.3 実装箇所
`pkg/agent/context.go` の `LoadBootstrapFilesForRoute()`:
```go
// For CHAT, CHAT_PERSONA is loaded first so personality takes priority.
if isChat {
    // CHAT: load persona first so 個性 takes priority
    for _, filename := range chatOnlyFiles {
        // CHAT_PERSONA.md, PrimerMessage.md を先に読み込む
    }
}
// 共有ファイルは後で読み込む
for _, filename := range sharedFiles {
    // AGENTS.md, USER.md など
}
```

### 4. Work Overlay 改善

#### 4.1 変更内容
従来:
```
- 結論→手順→確認（確認は1〜3件）
```

新規:
```
- 要点→手順→確認の順だが、見出し（結論・手順・確認）は出力しない。自然な文で構成
```

#### 4.2 実装箇所
- `pkg/agent/loop.go`: `WorkOverlayDirectiveText` 定数を更新
- `Modelfile.chat`: SYSTEM プロンプトを更新

### 5. チャットモデル変更

#### 5.1 変更
- モデル: `dsasai/llama3-elyza-jp-8b:latest` → `qwen3-vl:latest`
- `num_ctx: 8192` を明示追加
- SYSTEM プロンプトの調整（見出し出力禁止）

#### 5.2 ファイル
- `Modelfile.chat`

### 6. テストの追加

#### 6.1 問題
- `pkg/health/checks.go` にテストファイルが存在しない
- MaxContext 機能の品質保証が不足

#### 6.2 解決策
`pkg/health/checks_test.go` を作成し、11個のテストケースを追加:

1. ✅ `TestOllamaCheck_Success` - 正常系
2. ✅ `TestOllamaCheck_Unreachable` - サーバー到達不可
3. ✅ `TestOllamaCheck_StatusError` - HTTP ステータスエラー
4. ✅ `TestOllamaModelsCheck_AllModelsLoaded` - すべてのモデルがロード済み
5. ✅ `TestOllamaModelsCheck_ModelMissing` - 必要なモデルが未ロード
6. ✅ `TestOllamaModelsCheck_MaxContextExceeded` - **MaxContext 超過（131072 > 8192）**
7. ✅ `TestOllamaModelsCheck_MinContextNotMet` - MinContext 未満
8. ✅ `TestOllamaModelsCheck_ContextInRange` - コンテキストが範囲内
9. ✅ `TestOllamaModelsCheck_MultipleContextViolations` - 複数の違反を同時検出
10. ✅ `TestOllamaModelsCheck_NoRequirements` - 要件なし
11. ✅ `TestOllamaModelsCheck_ZeroConstraintsIgnored` - 0の制約は無視

#### 6.3 結果
- **OllamaCheck**: 100% カバレッジ
- **OllamaModelsCheck**: 93.1% カバレッジ
- すべてのテストがパス

## ドキュメント更新

### 更新したドキュメント

1. **`docs/01_正本仕様/実装仕様.md`**
   - 最終更新日: 2026-02-22 → 2026-02-24
   - 最新反映点に MaxContext 制約を追加
   - 10章「設定値と閾値」に MaxContext/MinContext の説明を追加

2. **`docs/05_LLM運用プロンプト設計/LLM_Ollama常駐管理.md`**
   - 監視対象に context_length 制約確認を追加
   - 復旧フローに context_length 制約違反の対応を追加

3. **`docs/05_LLM運用プロンプト設計/CHAT_PERSONA設計.md`（新規作成）**
   - CHAT_PERSONA と PrimerMessage の設計書
   - 読み込み順序の説明
   - /work モードとの連携
   - 運用ガイドライン

4. **`docs/00_ドキュメント分類一覧.md`**
   - CHAT_PERSONA設計.md を追加
   - ファイル数: 37 → 38

## 影響範囲

### 変更されたファイル
- `Modelfile.chat`: モデル変更、プロンプト調整
- `cmd/picoclaw/main.go`: MaxContext 制約追加
- `pkg/agent/loop.go`: ヘルスチェック強化、Work Overlay 更新
- `pkg/agent/context.go`: CHAT_PERSONA 優先読み込み
- `pkg/health/checks.go`: MaxContext フィールド追加

### 新規作成されたファイル
- `pkg/health/checks_test.go`: テストファイル（11テストケース）
- `workspace/CHAT_PERSONA.md`: Mio キャラクター定義
- `workspace/PrimerMessage.md`: プライマーメッセージ
- `.mcp.json`: Serena MCP サーバー設定
- `docs/05_LLM運用プロンプト設計/CHAT_PERSONA設計.md`: 設計書

## テスト結果

```bash
$ go test ./pkg/health/
PASS
ok  	github.com/sipeed/picoclaw/pkg/health	0.009s

$ go test -cover ./pkg/health/
ok  	github.com/sipeed/picoclaw/pkg/health	0.010s	coverage: 31.3% of statements
```

カバレッジ詳細:
- `OllamaCheck`: 100.0%
- `OllamaModelsCheck`: 93.1%

## 残作業・推奨事項

### 完了済み ✅
- [x] MaxContext 制約の実装
- [x] ヘルスチェック強化
- [x] テストの追加（11テストケース）
- [x] ドキュメント更新
- [x] CHAT_PERSONA 設計書作成

### 推奨事項 ⚠️
1. **モデル名の確認**
   - `qwen3-vl:latest` が `chat-v1:latest` の alias か確認
   - 仕様書では `chat-v1:latest` を想定

2. **未追跡ファイルのコミット**
   ```bash
   git add .mcp.json workspace/CHAT_PERSONA.md workspace/PrimerMessage.md
   git add docs/05_LLM運用プロンプト設計/CHAT_PERSONA設計.md
   git add docs/06_実装ガイド進行管理/20260224_ヘルスチェック強化とテスト追加.md
   ```

3. **Modelfile の整合性確認**
   - `Modelfile.chat` の実体モデル名を確認
   - 必要に応じて alias 設定を追加

## 検証チェックリスト

- [x] ビルド成功
- [x] 静的解析（go vet）クリア
- [x] 全テスト通過
- [x] health パッケージのテストカバレッジ向上
- [ ] 実環境での Ollama ヘルスチェック動作確認
- [ ] MaxContext 違反時の自動再起動確認
- [ ] CHAT_PERSONA 優先読み込みの動作確認
- [ ] Work Overlay の見出し非出力確認

## 次のステップ

1. 未追跡ファイルをコミット
2. 実環境でヘルスチェック動作確認
3. モデル名の整合性確認（qwen3-vl vs chat-v1）
4. 必要に応じて追加のエッジケーステストを作成

## 参照

- 実装仕様: `docs/01_正本仕様/実装仕様.md`
- Ollama 常駐管理: `docs/05_LLM運用プロンプト設計/LLM_Ollama常駐管理.md`
- CHAT_PERSONA 設計: `docs/05_LLM運用プロンプト設計/CHAT_PERSONA設計.md`
- テストコード: `pkg/health/checks_test.go`
