# 承認フロー廃止プラン

**作成日**: 2026-02-28
**作成者**: PicoClaw 開発チーム
**ステータス**: 実装準備中
**優先度**: 高（アーキテクチャ変更）

---

## 1. 背景

### 1.1 現状の承認フロー

PicoClaw は当初、破壊的操作の安全性を確保するため、以下の承認フローを設計していた：

```
Coder3（Claude API）が plan/patch を生成
  ↓
Chat が承認要求を送信（job_id 発行）
  ↓
ユーザーが /approve <job_id> または /deny <job_id> で承認
  ↓
承認後、Worker が patch を適用（※未実装）
```

**実装状況**:
- ✅ Phase 1-3 完了: 基本承認フロー（job_id 発行、承認/拒否処理）
- ❌ Phase 4-6 未実装: Worker 実行委譲、Auto-Approve、cost_hint

### 1.2 廃止の理由

**PicoClaw の基本思想は「完全自動」**:
- 超軽量（<10MB）AI アシスタントとして、低スペックハードウェアで動作
- ユーザー操作を最小化し、指示から実行まで自動化
- 承認フローはユーザー操作を要求するため、基本思想と矛盾

**未実装機能の実装コスト回避**:
- Worker 実行委譲（未実装）→ 実装不要
- Auto-Approve（未実装）→ 実装不要
- cost_hint（未実装）→ 実装不要

**設計の簡素化**:
- 承認フロー関連のコード削除により、コードベースが 1,000+ 行削減
- job_id 管理、セッション状態管理が不要に

---

## 2. 変更内容

### 2.1 新しいフロー（完全自動実行）

```
ユーザーが指示（LINE/Slack）
  ↓
ルーティング決定（CHAT/WORKER/CODE1/CODE2/CODE3）
  ↓
Coder3（Claude API）が plan/patch を生成
  ↓
★ Worker が即座に patch を適用（承認なし）
  ↓
実行結果をユーザーに返却
```

**特徴**:
- ✅ 完全自動（ユーザー操作不要）
- ✅ 高速（承認待ちなし）
- ⚠️ リスク高（破壊的操作も即座に実行）

### 2.2 削除する機能

| 機能 | 削除理由 |
|------|----------|
| **approval パッケージ** | 承認フロー管理（全削除） |
| **承認コマンド**（/approve, /deny） | ユーザー操作不要 |
| **job_id 管理** | 承認追跡不要 |
| **Auto-Approve**（未実装） | 即時実行のため不要 |
| **cost_hint**（未実装） | コスト制御なし |
| **SessionFlags.PendingApprovalJobID** | 承認待ち状態管理不要 |

### 2.3 追加する機能

| 機能 | 目的 |
|------|------|
| **Worker 即時実行ロジック** | patch を即座に適用 |
| **patch パーサー** | patch 形式を解析してコマンド抽出 |
| **実行結果ログ記録** | 詳細ログで復旧可能に |
| **Git 自動コミット**（オプション） | 実行前後に自動コミットで復旧容易に |

---

## 3. 削除箇所リスト

### 3.1 完全削除

#### pkg/approval/ ディレクトリ（全削除）
```
pkg/approval/
  ├── job.go           (120 行) - job_id 生成、Job 構造体
  ├── manager.go       (180 行) - Manager 構造体、CreateJob, Approve, Deny
  ├── message.go       (60 行)  - FormatApprovalRequest
  ├── job_test.go      (80 行)  - job_id 生成テスト
  └── manager_test.go  (150 行) - Manager テスト

総削除行数: 約 590 行
```

### 3.2 修正が必要な箇所

#### pkg/agent/loop.go（1980 行）

**削除箇所**:
- L100: `approvalMgr *approval.Manager` フィールド → 削除
- L490-523: `parseCoder3Output()` 呼び出しと承認ジョブ作成 → 簡素化
- L502: `approvalMgr.CreateJob(jobID, plan, patch, risk, usesBrowser)` → 削除
- L515-516: `logger.LogApprovalRequested()`, `logger.LogCoderPlanGenerated()` → 削除
- L1910-1947: `handleCommand()` 内の /approve, /deny 処理 → 削除

**追加箇所**:
- Worker 即時実行ロジック（新規関数 `executeWorkerPatch()`）
- patch パーサー（新規関数 `parsePatch()`）
- Git 自動コミット（オプション）

#### pkg/agent/router.go（278 行）

**削除箇所**:
- L14-15: `RouteApprove = "APPROVE"`, `RouteDeny = "DENY"` → 削除
- 承認コマンド判定ロジック（`parseRouteCommand()` 内）→ 削除

#### pkg/session/manager.go（351 行）

**削除箇所**:
- `SessionFlags.PendingApprovalJobID string` フィールド → 削除

#### pkg/logger/logger.go（284 行）

**削除箇所**:
- L200-210（推定）: `LogApprovalRequested()` → 削除
- L211-220（推定）: `LogApprovalGranted()` → 削除
- L221-230（推定）: `LogApprovalDenied()` → 削除
- L231-240（推定）: `LogApprovalAutoApproved()` → 削除

**追加箇所**:
- `LogWorkerSuccess(patch, result)` - Worker 実行成功ログ
- `LogWorkerFail(patch, error)` - Worker 実行失敗ログ

#### cmd/picoclaw/main.go（1467 行）

**削除箇所**:
- Gateway 起動時の `approval.NewManager()` 初期化（L600 付近、推定）→ 削除
- Agent Loop への `approvalMgr` 注入（L600 付近、推定）→ 削除

### 3.3 ドキュメント更新

#### 実装仕様（正本）
- **`docs/01_正本仕様/実装仕様.md`**
  - 1.2 節「Coder の責務」: 承認フロー削除
  - 6 章「セキュリティ」: 承認フロー削除または簡素化
  - 4.4 節「Worker 出力契約」: 即時実行に変更

#### LLM 運用プロンプト設計
- **`docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`**
  - 6 章「承認フロー統合」: 削除
  - 8-2 章「出力」: need_approval, risk, cost_hint フィールド削除

#### 実装ガイド進行管理
- **`docs/06_実装ガイド進行管理/20260224_Coder3承認フロー実装プラン.md`**
  - アーカイブ化（実装不要のため）

---

## 4. 追加実装の詳細

### 4.1 Worker 即時実行ロジック

#### 実装箇所
`pkg/agent/loop.go` に以下の関数を追加:

```go
// executeWorkerPatch は patch を即座に適用する
func (a *AgentLoop) executeWorkerPatch(ctx context.Context, patch string, sessionKey string) (string, error)

// parsePatch は patch からコマンドリストを抽出する
func parsePatch(patch string) ([]PatchCommand, error)

// executeCommand は単一のコマンドを実行する
func (a *AgentLoop) executeCommand(ctx context.Context, cmd PatchCommand) (string, error)
```

#### データ構造

```go
type PatchCommand struct {
    Type   string // "file_edit", "shell_command", "git_operation"
    Action string // "create", "update", "delete", "run"
    Target string // ファイルパスまたはコマンド
    Content string // ファイル内容またはコマンド引数
}
```

#### 処理フロー

```
1. patch 解析（parsePatch）
   - patch フォーマットを検証
   - コマンドリストに変換

2. 実行前 Git コミット（オプション）
   - git add -A
   - git commit -m "Auto-commit before patch"

3. patch 適用（executeCommand × N）
   - ファイル編集: 作成、更新、削除
   - シェルコマンド: bash 実行
   - Git 操作: commit, push 等

4. 実行後 Git コミット（オプション）
   - git add -A
   - git commit -m "Auto-commit after patch: [description]"

5. ログ記録
   - logger.LogWorkerSuccess(patch, result)
   - または logger.LogWorkerFail(patch, error)

6. 結果返却
   - 成功: "実行完了。変更内容: [summary]"
   - 失敗: "実行失敗。エラー: [error]"
```

### 4.2 patch フォーマット定義

Coder3（Claude API）が生成する patch は以下の形式を想定:

#### 形式 1: Markdown コードブロック形式

```markdown
## 変更内容

1. ファイル作成: `src/utils/helper.go`
\`\`\`go
package utils

func Helper() string {
    return "helper"
}
\`\`\`

2. シェルコマンド実行
\`\`\`bash
go test ./...
\`\`\`

3. Git 操作
\`\`\`bash
git add src/utils/helper.go
git commit -m "Add helper function"
\`\`\`
```

#### 形式 2: JSON 形式

```json
{
  "operations": [
    {
      "type": "file_edit",
      "action": "create",
      "target": "src/utils/helper.go",
      "content": "package utils\n\nfunc Helper() string {\n    return \"helper\"\n}\n"
    },
    {
      "type": "shell_command",
      "action": "run",
      "command": "go test ./..."
    },
    {
      "type": "git_operation",
      "action": "commit",
      "message": "Add helper function"
    }
  ]
}
```

**推奨**: 形式 1（Markdown）を採用
- 理由: Claude API が自然に生成しやすい形式
- パーサー実装が比較的容易

### 4.3 エラーハンドリング

#### エラーの種類

1. **patch パースエラー**
   - 原因: 不正な patch フォーマット
   - 対応: エラーメッセージをユーザーに返却、ログ記録

2. **コマンド実行エラー**
   - 原因: ファイル権限、コマンド不存在、構文エラー
   - 対応: エラー内容を詳細ログに記録、ユーザーに通知

3. **Git 操作エラー**
   - 原因: コンフリクト、リモート接続失敗
   - 対応: Git 状態を確認、ユーザーに手動対応を依頼

#### リトライ戦略

- **リトライしない**: 即時実行のため、失敗したら即座に通知
- **ユーザーに判断を委ねる**: 失敗原因を示し、再試行するか判断してもらう

### 4.4 Git 自動コミット（オプション）

#### 設定

`pkg/config/config.go` に以下を追加:

```go
type WorkerConfig struct {
    AutoCommit         bool   `json:"auto_commit" env:"PICOCLAW_WORKER_AUTO_COMMIT"`
    CommitMessagePrefix string `json:"commit_message_prefix" env:"PICOCLAW_WORKER_COMMIT_PREFIX"`
}

// デフォルト値
WorkerConfig{
    AutoCommit:         true,  // デフォルト有効
    CommitMessagePrefix: "[PicoClaw]",
}
```

#### コミットメッセージ形式

```
[PicoClaw] Auto-commit before patch
[PicoClaw] Auto-commit after patch: Add helper function
```

---

## 5. セーフガード

完全自動実行でも、以下のセーフガードを実装して安全性を確保:

### 5.1 詳細ログ記録（必須）

**記録内容**:
- 実行前: plan/patch の全文
- 実行中: 各コマンドの stdout/stderr
- 実行後: 実行結果、変更されたファイルリスト

**保存先**:
- ログファイル: `~/.picoclaw/logs/worker_YYYYMMDD.log`
- 構造化ログ（JSON）で永続化

**活用**:
- 問題発生時にログから復旧手順を特定
- 監査ログとして使用

### 5.2 Git 自動コミット（推奨）

**実装**:
- 実行前: 現在の状態を自動コミット
- 実行後: 変更後の状態を自動コミット

**メリット**:
- 問題があれば `git revert` で即座に巻き戻し可能
- Git 履歴で変更内容を追跡

**デメリット**:
- Git リポジトリ外では使用不可
- コミット履歴が増える

### 5.3 定期バックアップ（推奨）

**実装**:
- 1 日 1 回、ワークスペース全体をバックアップ
- バックアップ先: `~/.picoclaw/backups/YYYYMMDD.tar.gz`

**活用**:
- 最悪の場合、前日の状態に復旧

### 5.4 ドライモード（オプション）

**実装**:
- 環境変数 `PICOCLAW_DRY_RUN=true` で有効化
- Worker は実行せず、実行内容のみログ出力

**活用**:
- 開発時のテスト
- 破壊的操作の事前確認

---

## 6. リスク

### 6.1 破壊的操作のリスク

承認なしの完全自動実行では、以下の操作が**確認なしで即座に実行**される:

#### ファイル操作
```bash
rm -rf data/              # データ削除（復元不可）
mv app/ legacy_app/       # プロジェクト全体をリネーム
```

#### Git 操作
```bash
git push --force origin main  # チームの作業を上書き
git branch -D feature-x       # ブランチ削除
```

#### データベース操作
```sql
DROP TABLE users;             -- ユーザーテーブル削除
DELETE FROM orders WHERE 1=1; -- 全注文データ削除
```

#### 外部サービス
```bash
# 課金 API への大量リクエスト
curl -X POST api.example.com/charge

# 本番環境への deploy
kubectl apply -f config.yaml
```

#### Chrome 操作（MCP）
```
ブラウザで自動実行：
- 決済ボタンをクリック
- アカウント削除フォームを送信
- SNS への投稿
```

### 6.2 リスク管理

**前提**:
- ユーザーは PicoClaw の挙動を理解している
- 破壊的操作のリスクを承知している
- 復旧手段（Git, バックアップ）を用意している

**推奨環境**:
- 開発環境で十分にテスト
- 本番環境では慎重に使用
- 重要なデータは手動バックアップ

**責任**:
- ユーザーの自己責任で使用
- PicoClaw は破壊的操作を防止しない

---

## 7. マイグレーション

### 7.1 既存の承認待ちジョブ

**状況**:
- 承認フロー廃止により、既存の承認待ちジョブは破棄される
- in-memory 実装のため、プロセス再起動で消失（永続化なし）

**対応**:
- 承認待ちジョブがある場合、事前に承認または拒否を実施
- 廃止後は新しいフローで再実行

### 7.2 設定ファイル

**変更不要**:
- 承認フロー関連の設定は定義されていない（実装未完のため）
- config.json の更新は不要

### 7.3 ユーザー通知

**通知内容**:
```
PicoClaw の承認フローを廃止しました。

変更内容:
- Coder3 の plan/patch は即座に実行されます
- /approve, /deny コマンドは使用できなくなりました
- 破壊的操作も確認なしで実行されます

セーフガード:
- 詳細ログ記録（復旧可能）
- Git 自動コミット（有効化推奨）
- 定期バックアップ（推奨）

注意:
- 開発環境で十分にテスト後、本番環境で使用してください
- 重要なデータは手動バックアップを取ってください
```

---

## 8. 実装スケジュール

### Week 1: 削除 + 基本実装

| Day | タスク | 担当 | 備考 |
|-----|--------|------|------|
| 1 | 仕様変更ドキュメント作成 | - | このドキュメント |
| 2 | 削除箇所リスト生成 | - | 行番号付きリスト |
| 3 | approval パッケージ削除 | - | pkg/approval/ |
| 4-5 | 関連コード修正 | - | loop.go, router.go, logger.go 等 |
| 6-7 | Worker 即時実行ロジック追加 | - | executeWorkerPatch, parsePatch |

### Week 2: テスト + ドキュメント更新

| Day | タスク | 担当 | 備考 |
|-----|--------|------|------|
| 1-3 | テスト | - | ユニット + 統合 |
| 4 | 実装仕様書更新 | - | 実装仕様.md, Coder3 仕様.md |
| 5 | ドキュメント更新 | - | codebase-map/ |

### Week 3（オプション）: Phase 2 再実行

| Day | タスク | 担当 | 備考 |
|-----|--------|------|------|
| 1-4 | analyze-codebase 再実行 | - | Phase 2 再評価 |
| 5 | 最終確認、リリース準備 | - | - |

---

## 9. 検証項目

### 9.1 削除完了の確認

- [ ] `pkg/approval/` ディレクトリが存在しない
- [ ] `grep -r "approval.Manager" pkg/` が 0 件
- [ ] `grep -r "RouteApprove\|RouteDeny" pkg/` が 0 件
- [ ] `grep -r "PendingApprovalJobID" pkg/` が 0 件
- [ ] `grep -r "LogApprovalRequested" pkg/` が 0 件

### 9.2 Worker 実行の確認

- [ ] Coder3 が plan/patch を生成
- [ ] Worker が即座に patch を適用
- [ ] 実行結果がユーザーに返却される
- [ ] ログに patch/実行結果が記録される

### 9.3 セーフガードの確認

- [ ] Git 自動コミットが有効（設定で有効化した場合）
- [ ] 詳細ログが記録される
- [ ] ドライモードが動作する（実装した場合）

---

## 10. 承認

### 10.1 承認者

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | - | - | - |
| 技術リード | - | - | - |

### 10.2 承認基準

- [ ] 仕様変更の内容を理解している
- [ ] リスクを承知している
- [ ] 実装スケジュールに合意している

---

## 11. 参考資料

- **Phase 2 検証結果**: `docs/codebase-map/アーキテクチャ総合.md`
- **潜在バグ一覧**: `docs/codebase-map/潜在バグ一覧.md`（#1, #2, #4 が不要に）
- **実装仕様（正本）**: `docs/01_正本仕様/実装仕様.md`
- **Coder3 仕様**: `docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`

---

**最終更新**: 2026-02-28
**バージョン**: 1.0
**ステータス**: 承認待ち
