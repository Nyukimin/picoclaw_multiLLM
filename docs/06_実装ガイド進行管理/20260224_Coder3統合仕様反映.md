# 2026-02-24 Coder3 統合仕様反映

最終更新: 2026-02-24

## 概要

Coder3（Claude API 専用）の仕様を追加し、従来の実装仕様と統合。
承認フロー、Auto-Approve モード、Chat/Worker/Coder の責務分離を明確化。

## 主要な追加内容

### 1. Coder3 の位置づけ

#### 1.1 特徴
- **Claude API 専用**（OAuth/ブラウザセッション不使用）
- **提案と差分まで**：実行は Worker が担当
- **承認フロー必須**：破壊的操作には承認が必要
- **高品質コーディング/推論**：失敗コストが高い局面で使用

#### 1.2 既存の Coder との関係
- Coder1: 仕様設計向け（DeepSeek 等）
- Coder2: 実装向け（OpenAI 等）
- **Coder3**: 高品質コーディング/推論（Claude API 専用）【新規】

### 2. 責務の明確化

#### 2.1 三役割モデル（Chat/Worker/Coder）

| 役割 | 責務 | 実行内容 |
|------|------|----------|
| **Chat** | 意思決定・承認管理 | ユーザー対話、ルーティング決定、承認要求送信 |
| **Worker** | 実行・道具係 | ファイル編集、コマンド実行、テスト実行、差分適用 |
| **Coder** | 設計・実装案作成 | 仕様策定、コード生成、`plan` と `patch` の生成 |

**重要な原則**:
- Coder は原則として破壊的操作を**直接実行せず**、`plan` と `patch` を生成
- 実行は Worker が承認後に担当
- Chat が承認フローを管理

### 3. ルーティングカテゴリの拡張

従来: `CODE` / `CODE1` / `CODE2`
新規: `CODE` / `CODE1` / `CODE2` / **`CODE3`**

#### 3.1 CODE3 の選択条件
- 生成品質が作業成功率に直結するタスク
- 1回の失敗コストが大きい（手戻りが重い）タスク
- 例: 仕様策定の骨格、複雑な推論、重大バグの原因切り分け

#### 3.2 委譲プロトコル
```
DELEGATE: PLAN|ANALYZE|OPS|RESEARCH|CODE|CODE1|CODE2|CODE3 + TASK
```

### 4. 承認フロー仕様（新規）

#### 4.1 標準フロー
```
1. Chat がジョブ作成（job_id 付与）
2. Coder が提案・差分を生成
   - plan: 手順・判断理由
   - patch: diff 形式の変更案
   - risk: 破壊的変更/互換性評価
   - need_approval: 承認要否（通常 true）
3. Chat がユーザーへ承認要求（LINE/Slack 等）
4. 承認後、Worker が適用実行
5. 結果を通知、ログ保存
```

#### 4.2 承認要求メッセージの必須項目
- `job_id`: 押下対象を確定する ID
- 操作要約（1〜3行）
- 影響範囲（ファイル/環境）
- 取り消し可否（ロールバック可/不可）
- コスト見積もり（任意）

### 5. Auto-Approve モード（新規）

#### 5.1 目的
承認待ちで詰まる場面を減らしつつ、事故範囲を限定。

#### 5.2 設計
- **Scope（範囲）を持つ**:
  - 対象ジョブ種別（例: `design`, `review` のみ）
  - 対象ツール（例: ファイル書込み制限）
  - 対象パス（例: `docs/` のみ）
- **TTL（有効期限）**:
  - 例: 30分、2時間
- **即時 OFF 可能**（最優先操作）

#### 5.3 強制承認が必要なケース
Auto-Approve でも以下は**例外**:
- 削除、リネーム、広範囲の上書き
- 機密情報を含む可能性が高い送信
- 外部公開（SNS 投稿、public リポジトリへの push）
- コストが閾値超過

### 6. Coder3 の I/O インターフェース

#### 6.1 入力（Coder3 へのリクエスト）
```json
{
  "job_id": "string (必須)",
  "task_type": "design | codegen | review | refactor",
  "context": "string (必要最小限の背景)",
  "constraints": {
    "language": "go",
    "environment": "production",
    "forbidden": ["破壊的操作"],
    "output_format": "diff"
  },
  "artifacts": "ファイル抜粋、差分、ログ断片"
}
```

#### 6.2 出力（Coder3 からのレスポンス）
```json
{
  "job_id": "string (必須)",
  "plan": "手順・判断理由（簡潔に）",
  "patch": "diff 形式の変更案",
  "risk": {
    "destructive": false,
    "compatibility_issues": [],
    "rollback_possible": true
  },
  "cost_hint": {
    "estimated_tokens": 8000,
    "near_limit": false
  },
  "need_approval": true
}
```

### 7. 設定例

#### 7.1 routing.llm 設定
```json
{
  "routing": {
    "llm": {
      "chat_alias": "Mio",
      "chat_provider": "ollama",
      "chat_model": "ollama/chat-v1:latest",

      "worker_alias": "Shiro",
      "worker_provider": "ollama",
      "worker_model": "ollama/worker-v1:latest",

      "coder_alias": "Aka",
      "coder_provider": "deepseek",
      "coder_model": "deepseek-coder",

      "coder2_alias": "Ao",
      "coder2_provider": "openai",
      "coder2_model": "gpt-4",

      "coder3_alias": "Claude",
      "coder3_provider": "anthropic",
      "coder3_model": "claude-sonnet-4.5"
    }
  }
}
```

#### 7.2 Coder3 設定
```json
{
  "coder3": {
    "provider": "anthropic",
    "base_url": "https://api.anthropic.com",
    "api_key_env": "ANTHROPIC_API_KEY",
    "model": "claude-sonnet-4.5",
    "max_tokens": 16000,
    "retry_max": 2,
    "timeout_sec": 60
  }
}
```

#### 7.3 承認フロー設定
```json
{
  "approval": {
    "required_by_default": true,
    "auto_approve": {
      "enabled": false,
      "scope": {
        "allowed_task_types": ["design", "review"],
        "allowed_paths_prefix": ["docs/"],
        "deny_operations": ["delete", "rename", "push_public"]
      },
      "ttl_minutes": 60,
      "hard_require_approval": [
        "delete",
        "rename",
        "send_sensitive",
        "push_public",
        "cost_over_limit"
      ]
    }
  }
}
```

### 8. ログイベントの追加

新規イベント種別:
- `approval.requested`: 承認要求送信
- `approval.granted`: 承認許可
- `approval.denied`: 承認拒否
- `approval.auto_approved`: Auto-Approve による自動承認
- `coder.plan_generated`: Coder による plan/patch 生成

保存項目:
- `job_id`, `approval_status`, `approval_requested_at`, `approval_decided_at`
- `approver`, `coder_output`（plan/patch/risk の要約）

### 9. ドキュメント更新

#### 9.1 更新されたドキュメント
1. **`docs/01_正本仕様/仕様.md`**
   - ルーティングカテゴリに CODE3 を追加

2. **`docs/01_正本仕様/実装仕様.md`**
   - 1.1 役割命名に coder3_alias/provider/model を追加
   - 1.2 Coder の責務を明確化（新規セクション）
   - 2.6 委譲プロトコルに CODE3 を追加
   - 3.4 会話 LLM 提案 IF に CODE3 を追加
   - 5.1 Coder3 の出力仕様（新規セクション）
   - **6. 承認フロー仕様（新規章）**
   - 7.1 イベント種別に承認関連を追加
   - 7.3 承認フロー関連の保存項目（新規セクション）
   - 10.1 Coder3 設定（新規セクション）
   - 10.2 承認フロー設定（新規セクション）

3. **`docs/00_ドキュメント分類一覧.md`**
   - Coder3_Claude_API仕様.md を追加
   - ファイル数: 38 → 39

#### 9.2 新規作成されたドキュメント
- **`docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`**
  - Coder3 の詳細仕様（元ファイル移動）

- **`docs/06_実装ガイド進行管理/20260224_Coder3統合仕様反映.md`**
  - 本ドキュメント

### 10. 実装への影響

#### 10.1 実装が必要な箇所
1. **`pkg/agent/router.go`**
   - CODE3 ルーティング追加
   - `selectCoderRoute()` に Coder3 選択ロジック追加

2. **`pkg/providers/`**
   - Anthropic Claude API 統合（既存の claude_provider.go を拡張）
   - Coder3 専用の I/O ハンドリング

3. **`pkg/approval/`**（新規パッケージ）
   - 承認フロー管理
   - Auto-Approve ロジック
   - job_id 管理

4. **`pkg/agent/loop.go`**
   - Coder 出力と Worker 実行の分離
   - 承認待ち状態の管理

5. **`pkg/config/config.go`**
   - Coder3 設定追加
   - 承認フロー設定追加

#### 10.2 既存コードへの影響
- **後方互換性**: Coder1/Coder2 の既存動作は変更なし
- **段階的導入**: Coder3 と承認フローは独立して実装可能
- **設定デフォルト**: `approval.required_by_default = true` でデフォルトは安全側

### 11. テスト観点

#### 11.1 Coder3 機能テスト
- [ ] Claude API 経由での plan/patch 生成
- [ ] OAuth/ブラウザセッション未使用の確認
- [ ] エラーハンドリング（401/429/5xx）

#### 11.2 承認フローテスト
- [ ] 承認要求メッセージ生成
- [ ] 承認/拒否の処理
- [ ] Worker による実行（承認後）
- [ ] ログへの記録（job_id, approval_status）

#### 11.3 Auto-Approve テスト
- [ ] Scope 制約（task_type, path, operation）
- [ ] TTL 期限切れ
- [ ] 即時 OFF 機能
- [ ] 強制承認例外（delete, rename, etc.）

#### 11.4 統合テスト
- [ ] Chat → Coder3 → Worker の連携
- [ ] CODE1/CODE2/CODE3 の使い分け
- [ ] 承認フローありなしの両パターン

### 12. 受け入れ条件

- [ ] OAuth トークン/ブラウザセッションを一切使わずに動作
- [ ] 承認フローなしに破壊的変更が適用されない
- [ ] Auto-Approve は Scope と TTL で事故範囲が限定され、即 OFF できる
- [ ] すべての処理が job_id で追跡できる
- [ ] Chat/Worker/Coder の責務が混ざらず運用できる

### 13. 次のステップ

#### 13.1 優先度: 高
1. `pkg/approval/` パッケージの実装
2. `pkg/providers/` に Coder3 対応追加
3. `pkg/agent/router.go` に CODE3 ルーティング追加

#### 13.2 優先度: 中
4. 承認要求メッセージの UI 実装（LINE/Slack）
5. Auto-Approve ロジックの実装
6. ログイベントの追加

#### 13.3 優先度: 低
7. コスト制御機能の実装
8. リトライ・バックオフロジックの実装
9. Coder3 専用のテストスイート作成

## 参照

- Coder3 詳細仕様: `docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`
- 実装仕様: `docs/01_正本仕様/実装仕様.md`
- 元仕様: `docs/01_正本仕様/仕様.md`
