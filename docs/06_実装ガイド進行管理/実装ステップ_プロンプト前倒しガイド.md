# 実装ステップ_プロンプト前倒しガイド

目的: STEPの依存関係を崩さずに、プロンプトで先行できる部分を早めに取り込む。

## 方針
- 実装must（システム担保）はSTEP順を厳守する。
- プロンプト先行OKは同一STEP内で前倒し可能。
- 後回しは運用安定後に着手する。

## STEP別整理

| STEP | 実装must（順序固定） | プロンプト先行OK（前倒し可） | 後回し（安定後） |
|---|---|---|---|
| STEP 1 最小で動かす | `command -> rules -> classifier -> fallback`、6ルート定義、会話LLM最終応答、`/local` `/cloud` 反映 | 会話LLMの基本文体固定、ワーカーJSON返却の強い指示 | 細かい文体チューニング |
| STEP 2 事故防止 | `local_only` 中CODE禁止、CODE高閾値+強証拠、分類器故障時CHATフォールバック | `/code`拒否時の短文案内テンプレ、分類器`reason`を短文化 | 例外ケースの文言最適化 |
| STEP 3 ループ制御 | `max_loops`/`max_millis`、`needs_next_loop` 判定、失敗時停止 | 失敗要約の定型文、継続/停止説明の簡潔化 | 会話LLM提案IFの高度化 |
| STEP 4 可視化 | ルート変更時のみ宣言、CHAT宣言なし、内部事情非表示 | 宣言文の語調統一、出し分け文言の微調整 | チャネル別の細かな文体差分 |
| STEP 5 ログ最小運用 | 最低ログ項目保存（initial/final/classifier/stop_reason など） | ログメッセージ文面の統一（可読性向上） | ログ粒度の高度化/分析自動化 |
| STEP 6 拡張 | 再ルート提案IF、サニタイズ責務統一、辞書育成フロー | 各workerプロンプトの高精度化 | 大規模最適化、全自動改善 |

## 前倒し可否の判断ルール
- 前倒ししてよい: 「失敗しても安全側に倒れる」項目
- 前倒ししない: 「誤爆・漏洩・無限ループ防止」に関わる項目

## 実行テンプレ（各STEP）
1. 実装mustを先に満たす
2. 同STEP内のプロンプト先行OKを適用
3. 受け入れ条件（安全性/再現性）を確認
4. 後回し項目はTODOに回す

## 現状チェック（2026-02-19）
- STEP 1: 実装済み（Router骨格、6ルート、`/local` `/cloud`）
- STEP 2: 実装済み（`local_only`中CODE拒否、CODE強証拠、分類器異常時CHAT）
- STEP 3: 一部実装済み（`max_loops`/`max_millis`、停止要約）
- STEP 4: 実装済み（ルート変更時のみ宣言、CHAT無宣言）
- STEP 5: 実装済み（`initial_route/final_route/classifier_confidence/stop_reason/error_reason`）
- STEP 6: 未着手（会話LLM再ルート採択、ログ細分化、サニタイズ責務完全分離）
