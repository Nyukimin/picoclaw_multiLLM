# 実装仕様（統合正本）

本書は `docs/01_正本仕様/仕様.md` に対する実装の唯一の正本とする。  
`docs/03_旧分割仕様アーカイブ/実装仕様_01.md`〜`docs/03_旧分割仕様アーカイブ/実装仕様_07.md` はアーカイブ（互換参照）として扱う。

## 仕様リンク

- 元仕様: `docs/01_正本仕様/仕様.md`
- 章分割版: `docs/02_v2統合分割仕様/実装仕様_v2_00_目次.md`
- 旧版アーカイブ: `docs/03_旧分割仕様アーカイブ/実装仕様_アーカイブ一覧.md`

## 最終更新（2026-02-24）

本書の最新反映点:

- `LINE -> CHAT(Mio)` の入口固定を維持。
- `Mio` が会話中に `Worker/Coder` 委譲を判断するオーケストレーションを採用。
- Chat/Worker の Ollama モデル: `chat-v1:latest`, `worker-v1:latest`（実体は設定で変更可能）。
- Ollama リクエストに `keep_alive: -1` を付与（Chat/Worker 永続化）。
- LINE指示ごと: LLM呼び出し → ヘルスチェック（常時）→ Ollama 落ち/モデル未ロード検出 → 再起動 → 失敗時のみリトライ（`pkg/agent/loop.go`）。
- ヘルスチェック強化: `MaxContext` 制約チェックを追加（例: 8192 を超える context_length は NG）（`pkg/health/checks.go`）。
- CHAT ルート時の bootstrap ファイル読み込み順序: `CHAT_PERSONA.md` を最優先で読み込み、個性を優先（`pkg/agent/context.go`）。
- Coder1/Coder2/Coder3 三重ルーティング（`CODE1`/`CODE2`/`CODE3`）。
  - **Coder3**: Claude API 専用、高品質コーディング/推論（`docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`）
- **承認フロー追加**: Coder は「提案と差分」まで、実行は Worker が承認後に担当（6章）。
- **Auto-Approve モード**: Scope/TTL 付き、即時 OFF 可能（6.4節）。
- 画像入力は `buildHTTPMessagesWithAudit` / `toImageURLPayload` を通して `image_url` へ変換して送信。
- 画像送信直前/タイムアウト後の監査ログを追加。

### 実装章 → 仕様章 対応
- 1章（スコープ・責務境界） → 仕様「目的と前提」「用語」「全体構成」
- 2章（ルーティング決定仕様） → 仕様「ルーティングカテゴリ」「ルーティング決定ルール」「分類器」
- 3章（ループ制御と再ルート） → 仕様「ループ制御」「誤分類への対策」
- 4章/5章（I/O契約/ワーカー） → 仕様「ワーカー出力契約」
- 6章（セキュリティ） → 仕様「セキュリティとデータ取り扱い」
- 7章（ログ） → 仕様「ログと改善データ」
- 8章（Prompt/宣言） → 仕様「ユーザーへの可視化（宣言）」
- 9章（状態管理） → 仕様「セッションとメモリ」
- 10章（設定値と閾値） → 仕様「分類器」「ループ制御」
- 11章（テスト観点） → 仕様全体の検証項目

---

## 1. スコープ・責務境界
- 対象チャネル: LINE / Slack（他チャネルは対象外、既存挙動を壊さない）
- 最終応答は会話LLMのみが生成する
- 分岐決定は Router / LoopController のみ
- LLMは提案者であり決定権を持たない

### 1.1 役割命名（固定）と実体（可変）
- 役割名は固定: `Chat / Worker / Coder`
- 愛称（例: Mio / Shiro / Aka / Ao / Claude）と実体LLMは可変
- 差し替えは設定ファイルで行う（`routing.llm.*`）
  - `chat_alias/chat_provider/chat_model`（例: Mio / ollama / ollama/chat-v1:latest）
  - `worker_alias/worker_provider/worker_model`（例: Shiro / ollama / ollama/worker-v1:latest）
  - `coder_alias/coder_provider/coder_model`（Coder1、例: Aka / deepseek）
  - `coder2_alias/coder2_provider/coder2_model`（Coder2、例: Ao / openai）
  - `coder3_alias/coder3_provider/coder3_model`（Coder3、例: Claude / anthropic / claude-sonnet-4.5）
- 旧キー `code_provider/code_model` は後方互換として許容

### 1.2 Coder の責務（重要な変更点 2026-02-24）
Coder3 追加仕様（`docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`）により、Coder の責務が明確化：
- **Coder の役割**: 設計・実装案の作成（「提案と差分」まで）
- **Worker の役割**: 実際の適用実行（ファイル書込み、コマンド実行）
- **Chat の役割**: 承認フロー管理、意思決定、ルーティング

**重要**: Coder は原則として破壊的操作を直接実行せず、`plan` と `patch` を生成する。
実行は Worker が承認後に担当する。

---

## 2. ルーティング決定仕様

### 2.1 優先順位（固定）
1. 明示コマンド
2. ルール辞書（強証拠）
3. 分類器（1入力につき最大1回）
4. 安全側フォールバック

### 2.2 明示コマンド
- `/code /analyze /plan /ops /research /chat /local /cloud`
- 行頭コマンドのみ有効
- `local_only=true` 中の `/code` は Router段階で拒否し、会話LLMで解除案内

### 2.3 ルール辞書
- 初期辞書は強証拠のみ
- 評価順は priority降順、同値は定義順
- 辞書定義は `docs/03_旧分割仕様アーカイブ/実装仕様_02.md` を正式参照

### 2.4 分類器
- 出力は JSON のみ（`route`,`confidence`,`reason`,`evidence`）
- 故障時（JSON不正/必須欠損/列挙外/範囲外）は CHAT フォールバック
- CODE判定は `confidence >= 0.8` かつ強証拠を必須

### 2.5 分類器プロンプト管理
- 分類器system promptは1枚固定
- 更新はカテゴリ追加時のみ

### 2.6 LINEチャネルの入口制約（現行）

- LINE入力は `CHAT` 固定で開始する（`line_forced_chat`）。
- 前段Routerで直接 `PLAN/CODE` に送らない。
- 委譲は `Mio` の応答プロトコル（`DELEGATE: PLAN|ANALYZE|OPS|RESEARCH|CODE|CODE1|CODE2|CODE3` + `TASK`）でのみ実行する。

---

## 3. ループ制御と再ルート

### 3.1 停止条件
- `max_loops` 到達
- `max_millis` 到達
- worker失敗
- ユーザー確認が必要

### 3.2 ユーザー確認停止
- 停止理由を `need_user_confirmation` に統一
- 発火条件:
  - `risk=high`
  - 低confidenceかつ重大分岐
  - 追加情報不足

### 3.3 再ルート（最大1回）
- `fit=false` かつ `suggested_route` 有効
- または会話LLM提案IFを採択
- 同一入力で最大1回

### 3.4 会話LLM提案IF
```json
{"propose_next_loop":false,"route":"CHAT|PLAN|ANALYZE|OPS|RESEARCH|CODE|CODE1|CODE2|CODE3","reason":"short text","confidence":0.0}
```

---

## 4. I/O契約

### 4.1 InputMessage
- `channel`, `session_id`, `user_text`, `raw`, `received_at`

### 4.2 RoutingDecision
- `primary_route`, `source`, `confidence`, `reason`, `evidence`, `flags.local_only`

### 4.3 WorkerInput
- `docs/03_旧分割仕様アーカイブ/実装仕様_03.md` の入力スキーマを採用

### 4.4 WorkerOutput（統一定義）
- 必須: `result`,`needs_next_loop`,`why`,`next_actions`,`questions_for_user`,`confidence`,`risk`
- 任意: `fit`,`suggested_route`

---

## 5. ワーカー仕様
- 全ワーカーの出力は JSON のみ
- 失敗時は `needs_next_loop=false`
- `next_actions` / `questions_for_user` は最大3
- CODEはクラウド専用、`local_only` 時は呼び出し禁止（Router拒否を主、worker保険）

### 5.1 Coder3 の出力仕様（2026-02-24追加）
Coder3 は「提案と差分」を生成し、実行は Worker に委譲する：
- 必須フィールド:
  - `job_id`: ジョブ識別子
  - `plan`: 手順・判断理由（簡潔に）
  - `patch`: diff 形式の変更案（または変更内容の箇条書き）
  - `risk`: 破壊的変更/互換性/手戻り可能性
  - `need_approval`: 承認要否（通常 true）
- 任意フィールド:
  - `cost_hint`: 概算トークン数や上限接近の警告

詳細: `docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`

---

## 6. 承認フロー仕様（2026-02-24追加）

### 6.1 基本原則
- Coder（Coder1/Coder2/Coder3）は「提案（plan）」と「差分（patch）」を生成
- **実際の適用（書込み/実行）は Worker が担当**
- 破壊的操作には**承認が必須**

### 6.2 標準フロー
1. Chat がジョブ作成（`job_id` 付与）
2. Coder が提案・差分を生成
3. Chat がユーザーへ承認要求（LINE/Slack 等）
4. 承認後、Worker が適用実行
5. 結果を通知、ログ保存

### 6.3 承認要求メッセージの必須項目
- `job_id`: 押下対象を確定する ID
- 操作要約（1〜3行）
- 影響範囲（ファイル/環境）
- 取り消し可否（ロールバック可/不可）
- コスト見積もり（任意）

### 6.4 Auto-Approve モード
Auto-Approve は **Scope（範囲）と TTL（有効期限）を持つ**：
- 対象ジョブ種別（例: docs 生成のみ）
- 対象ツール（例: ファイル書込み制限）
- 対象パス（例: `docs/` のみ）
- 有効期限（例: 30分）
- **即時 OFF 可能**（最優先操作）

**強制承認が必要なケース**（Auto-Approve でも例外）:
- 削除、リネーム、広範囲の上書き
- 機密情報を含む可能性が高い送信
- 外部公開（SNS 投稿、public リポジトリへの push）
- コストが閾値超過

詳細: `docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md` 7章

---

## 7. セキュリティ仕様
- CODE以外でクラウド利用禁止
- `/local` 中はクラウド呼び出し禁止
- 機密情報（token/secret/PII）はクラウド送信前に除外
- ログ保存はマスク後のみ
- サニタイズ責務は `pkg/security/sanitizer.go` に一本化

---

## 7. ログ仕様

### 7.1 イベント種別（固定）
- `router.decision`
- `classifier.error`
- `worker.success`
- `worker.fail`
- `route.override`
- `loop.stop`
- `final.route`
- `approval.requested`（2026-02-24追加）
- `approval.granted`（2026-02-24追加）
- `approval.denied`（2026-02-24追加）
- `approval.auto_approved`（2026-02-24追加）
- `coder.plan_generated`（2026-02-24追加）

### 7.2 最低保存項目
- `initial_route`, `final_route`
- `classifier_route`, `classifier_confidence`
- `worker_calls`, `needs_next_loop`, `risk`, `fit`
- `reroute_used`, `stop_reason`, `error_reason`

### 7.3 承認フロー関連の保存項目（2026-02-24追加）
- `job_id`: ジョブ識別子
- `approval_status`: `pending` / `granted` / `denied` / `auto_approved`
- `approval_requested_at`: 承認要求時刻
- `approval_decided_at`: 承認決定時刻
- `approver`: 承認者（ユーザーID）
- `coder_output`: Coder の生成した plan/patch/risk の要約

### 7.3 画像送信監査ログ（現行）

- ログカテゴリ: `provider.http`
- 送信前: `LLM image audit before request`
  - `source_path`, `url_type`, `image_url`（要約）, `image_url_length`
  - `local_exists_before`, `local_size_before_bytes`
  - `included`, `drop_reason`
- タイムアウト時: `LLM image audit after timeout`
  - `local_exists_after_timeout`, `local_size_after_timeout_bytes`

---

## 8. Prompt/宣言仕様
- persona/policy/overlay を固定順で連結
- system prompt はアプリ側のみが構築
- route変更時のみ1行宣言（CHATは宣言なし）

---

## 9. 状態管理仕様
- `session_id` はチャネル単位で一意管理（Slackはthread単位推奨）
- `short_memory` 中心で運用し `recent_turns` は最小限
- ANALYZE構造化データの保存先は実装で1つに統一:
  - `pkg/memory/store.go` 拡張
  - または `pkg/analyze/store.go` 新設

---

## 10. 設定値と閾値
- `routing.classifier.min_confidence = 0.6`
- `routing.classifier.min_confidence_for_code = 0.8`
- `loop.max_loops = 3`
- `loop.max_millis = 90000`
- `loop.allow_auto_reroute_once = true`
- `loop.allow_chat_propose_reroute_once = true`
- Ollama呼び出し時 `options.num_ctx = 8192`、`keep_alive: -1` をリクエストに含める
- `providers.ollama_restart_command`（任意）: Ollama 再起動コマンド（例: `systemctl --user restart ollama`）
- ヘルスチェック制約:
  - `ModelRequirement.MaxContext = 8192`: モデルの context_length がこれを超える場合は NG（大きすぎる num_ctx によるロード失敗を防止）
  - `ModelRequirement.MinContext`: 指定時、context_length がこれ未満の場合は NG（必要に応じて使用）

### 10.1 Coder3 設定（2026-02-24追加）
- `coder3.provider = "anthropic"`: Claude API 専用
- `coder3.model = "claude-sonnet-4.5"`: 使用モデル
- `coder3.max_tokens = 16000`: 1ジョブあたりの上限
- `coder3.retry_max = 2`: 連続リトライ回数制限
- `coder3.timeout_sec = 60`: タイムアウト

### 10.2 承認フロー設定（2026-02-24追加）
- `approval.required_by_default = true`: デフォルトで承認必須
- `approval.auto_approve.enabled = false`: Auto-Approve 無効（デフォルト）
- `approval.auto_approve.scope.allowed_task_types = ["design", "review"]`: 許可タスク種別
- `approval.auto_approve.scope.allowed_paths_prefix = ["docs/"]`: 許可パスプレフィックス
- `approval.auto_approve.scope.deny_operations = ["delete", "rename", "push_public"]`: 禁止操作
- `approval.auto_approve.ttl_minutes = 60`: 有効期限（分）
- `approval.hard_require_approval = ["delete", "rename", "send_sensitive", "push_public", "cost_over_limit"]`: 強制承認が必要な操作

---

## 11. テスト観点
- 正常系: command優先、rules確定、classifierフォールバック、reroute最大1回
- 異常系: 分類器JSON不正、ワーカーJSON不正、`local_only`中CODE、`risk=high`確認停止
- 回帰: 非対象チャネルへ副作用なし、宣言文切替の維持

---

## 12. 参照関係
- 正本: `docs/01_正本仕様/実装仕様.md`（本書）
- 分割版: `docs/02_v2統合分割仕様/実装仕様_v2_00_目次.md`
- 旧版アーカイブ一覧: `docs/03_旧分割仕様アーカイブ/実装仕様_アーカイブ一覧.md`

---

## 13. 実装状況（MVP / 2026-02-19）

### 13.1 実装済み
- Router（MVP）: `command -> rules -> classifier -> fallback` を実装
  - `pkg/agent/router.go`
- Classifier（MVP）: JSON抽出/検証、異常時フォールバックを実装
  - `pkg/agent/classifier.go`
- AgentLoop統合: ルーティング判定、宣言文付与、`local_only` セッション保持を実装
  - `pkg/agent/loop.go`
- 設定追加: `routing` / `loop` を追加（デフォルト値含む）
  - `pkg/config/config.go`
- セッション拡張: `local_only` / `prev_primary_route` を保存
  - `pkg/session/manager.go`

### 13.2 テスト状況
- パッケージテスト: `go test ./pkg/config ./pkg/session ./pkg/agent` 通過
- 追加テスト:
  - `pkg/agent/router_test.go`
  - `pkg/session/manager_test.go`（flags永続化）
  - `pkg/config/config_test.go`（routing/loop初期値）

### 13.3 既知の制約（MVP）
- 分類器はモデル出力に依存し、JSON不正時は `CHAT` にフォールバックする。
- `needs_next_loop` を前提にした高度なworker連鎖は未実装（1ターン完結中心）。
- 会話LLMの再ルート提案IF採択ロジックは次フェーズ。

### 13.4 接続運用メモ（Ollama/Tailscale）
- `api_base` は名前解決不安定時に Tailscale IP 直指定を推奨。
- 現行実装では Ollama接続時に provider判定の都合上、`model` は `ollama/<model>` 形式で指定する。

### 13.5 画像I/O実装状況（2026-02-20）
- LINE画像は一時保存後、`image_url(data URI)` に変換して送信。
- 一時ファイルは即時削除せず保持期間後にクリーンアップ。
- `provider.http` の監査ログで「送信時存在」「サイズ」「タイムアウト後存在」を追跡可能。

### 13.6 2026-02-22 反映
- Coder1/Coder2 二重ルーティング: `pkg/agent/router.go`（RouteCode1/RouteCode2）、`pkg/agent/loop.go`（`selectCoderRoute`）
- Ollama `keep_alive: -1`: `pkg/providers/http_provider.go`
- LINE指示ごとのOllamaヘルスチェック・再起動・リトライ: `pkg/agent/loop.go` の `processMessage`
- Chat/Worker モデル名: `chat-v1:latest`, `worker-v1:latest`（`Modelfile.chat`、`config.example.json`）
