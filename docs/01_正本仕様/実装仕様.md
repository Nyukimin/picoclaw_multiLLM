# 実装仕様（統合正本）

本書は `docs/01_正本仕様/仕様.md` に対する実装の唯一の正本とする。  
`docs/03_旧分割仕様アーカイブ/実装仕様_01.md`〜`docs/03_旧分割仕様アーカイブ/実装仕様_07.md` はアーカイブ（互換参照）として扱う。

## 仕様リンク

- 元仕様: `docs/01_正本仕様/仕様.md`
- 章分割版: `docs/02_v2統合分割仕様/実装仕様_v2_00_目次.md`
- 旧版アーカイブ: `docs/03_旧分割仕様アーカイブ/実装仕様_アーカイブ一覧.md`

## 最終更新（2026-03-01）

本書の最新反映点:

### 2026-03-01: マルチエージェント新アーキテクチャ - Phase 1-4 完了
- **プロジェクトモジュール名変更**: `github.com/sipeed/picoclaw` → `github.com/Nyukimin/picoclaw_multiLLM`（独自開発のため）
- **Phase 1 基盤構築完了**: モジュールインターフェース、JobID生成、フィーチャーフラグ実装
- **Phase 2 モジュール実装完了**: Chat/Worker/Order の全モジュール実装（10ファイル）
- **Phase 3 エージェントファクトリ完了**: 新フロー実装、Router アダプター、新旧切り替え
- **Phase 4 Provider 統合完了**: ExecutionModule, ProposalGenerationModule, Heartbeat プロトコル実装
- **全テスト PASS**: 30+ tests、すべてのパッケージで成功

### 2026-03-01: マルチエージェント新アーキテクチャ採用（仕様策定）
- **エージェント共通コア設計**: 5つのエージェント（Chat/Worker/Order1/Order2/Order3）は同じコアを共有し、機能モジュールで個性を付与（1.0章）
- **Chat の役割変更**: ルーティング決定 → 軽量受領・最終決定のみ（1.2章）
- **Worker の役割拡張**: 実行のみ → ルーティング・集約・Heartbeat管理を担当（1.2章）
- **JobID 全体必須化**: すべての作業・応答に JobID を必須化（トレーサビリティ向上）（7.4章）
- **Heartbeat システム**: 全エージェントが自律的に状態報告、Worker が集約（新12章）
- **合議制（Deliberation Mode）**: 複数 Coder の並列提案 → 比較 → 最終決定（オプション機能、新13章）
- **エージェント名称**: Coder1/Coder2/Coder3 → Order1/Order2/Order3 へ変更可能（設定で選択）
- **プラグイン型モジュール**: 機能を独立したモジュールとして実装、組み合わせで動作を決定（新1.0章）

### 2026-02-24: Coder3 統合・承認フロー
- `LINE -> CHAT(Mio)` の入口固定を維持。
- Chat/Worker の Ollama モデル: `chat-v1:latest`, `worker-v1:latest`（実体は設定で変更可能）。
- Ollama リクエストに `keep_alive: -1` を付与（Chat/Worker 永続化）。
- LINE指示ごと: LLM呼び出し → ヘルスチェック（常時）→ Ollama 落ち/モデル未ロード検出 → 再起動 → 失敗時のみリトライ（`pkg/agent/loop.go`）。
- ヘルスチェック強化: `MaxContext` 制約チェックを追加（例: 8192 を超える context_length は NG）（`pkg/health/checks.go`）。
- CHAT ルート時の bootstrap ファイル読み込み順序: `CHAT_PERSONA.md` を最優先で読み込み、個性を優先（`pkg/agent/context.go`）。
- Coder1/Coder2/Coder3 三重ルーティング（`CODE1`/`CODE2`/`CODE3`）。
  - **Coder3**: 愛称 Gin、Claude API 専用、高品質コーディング/推論（`docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`）
- **承認フロー追加**: Coder は「提案と差分」まで、実行は Worker が承認後に担当（6章）。
- **Auto-Approve モード**: Scope/TTL 付き、即時 OFF 可能（6.4節）。
- 画像入力は `buildHTTPMessagesWithAudit` / `toImageURLPayload` を通して `image_url` へ変換して送信。
- 画像送信直前/タイムアウト後の監査ログを追加。

### 実装章 → 仕様章 対応
- 1章（スコープ・責務境界） → 仕様「目的と前提」「用語」「全体構成」
- 2章（ルーティング決定仕様） → 仕様「ルーティングカテゴリ」「ルーティング決定ルール」「分類器」
- 3章（ループ制御と再ルート） → 仕様「ループ制御」「誤分類への対策」
- 4章/5章（I/O契約/ワーカー） → 仕様「ワーカー出力契約」
- 6章（セキュリティ） → 仕様「セキュリティとデータ取り扱い」
- 7章（ログ） → 仕様「ログと改善データ」
- 8章（Prompt/宣言） → 仕様「ユーザーへの可視化（宣言）」
- 9章（状態管理） → 仕様「セッションとメモリ」
- 10章（設定値と閾値） → 仕様「分類器」「ループ制御」
- 11章（テスト観点） → 仕様全体の検証項目

---

## 1.0 エージェントアーキテクチャ（2026-03-01追加）

### 1.0.1 基本設計原則

**5つのエージェントは同じコアを共有し、機能モジュールで個性を付ける**

```
共通エージェントコア
├── ID, Alias, Provider, Model
├── LLM クライアント
└── 機能モジュール（プラグイン）
    ├── Chat 用モジュール
    ├── Worker 用モジュール
    └── Coder 用モジュール
```

### 1.0.2 エージェント構成（5体）

| ID | 愛称 | Provider | Model | 主要モジュール |
|----|------|----------|-------|---------------|
| **chat** | Mio | ollama | chat-v1:latest | LightweightReception, FinalDecision, ApprovalUI |
| **worker** | Shiro | ollama | worker-v1:latest | Routing, LoopControl, Heartbeat, Aggregation, Execution |
| **order1** | Aka | deepseek | deepseek-chat | ProposalGeneration, CodeAnalysis |
| **order2** | Ao | openai | gpt-4 | ProposalGeneration, CodeAnalysis |
| **order3** | Gin | anthropic | claude-sonnet-4-5 | ProposalGeneration, ApprovalFlow, CodeAnalysis |

**注**: Coder1/Coder2/Coder3 という旧名称も設定で使用可能（後方互換）

### 1.0.3 モジュール分類

#### Chat 用モジュール
- **LightweightReceptionModule**: 軽量な入力受付、JobID 付与
- **FinalDecisionModule**: Worker からの報告を受けて最終決定
- **ApprovalUIModule**: 承認 UI（LINE/Slack へメッセージ送信）

#### Worker 用モジュール
- **RoutingModule**: ルーティング決定（Router/Classifier を内包）
- **LoopControlModule**: ループ制御
- **HeartbeatCollectorModule**: 全エージェントの Heartbeat を集約
- **AggregationModule**: 各エージェント結果の集約
- **ExecutionModule**: 実行・道具係（ファイル操作、コマンド実行）

#### Coder 用モジュール（Order1/2/3 共通）
- **ProposalGenerationModule**: 提案生成（plan/patch）
- **ApprovalFlowModule**: 承認フロー管理（Order3 専用）
- **CodeAnalysisModule**: コード分析
- **PatchApplicationModule**: パッチ適用（Worker へ委譲）

#### 共通モジュール
- **LoggingModule**: ログ出力
- **SessionModule**: セッション管理
- **MemoryModule**: メモリ管理

### 1.0.4 動作フロー（新設計）

```
1. LINE入力
   ↓
2. Chat (Mio) - LightweightReceptionModule
   - JobID 付与
   - Worker へタスク委譲
   ↓
3. Worker (Shiro)
   - RoutingModule: ルーティング決定（CHAT/CODE1/CODE2/CODE3）
   - LoopControlModule: ループ制御
   - 必要に応じて Order1/Order2/Order3 へ委譲
   ↓
4. Order1/Order2/Order3 (Aka/Ao/Gin)
   - ProposalGenerationModule: plan/patch 生成
   - (Order3 のみ) ApprovalFlowModule: 承認要求
   ↓
5. Worker (Shiro)
   - AggregationModule: 結果集約
   - HeartbeatCollectorModule: 各エージェント状態確認
   - Chat へ報告
   ↓
6. Chat (Mio) - FinalDecisionModule
   - 最終決定
   - ApprovalUIModule: 承認が必要なら LINE/Slack へ通知
   - ユーザーへ応答
```

---

## 1. スコープ・責務境界
- 対象チャネル: LINE / Slack（他チャネルは対象外、既存挙動を壊さない）
- 最終応答は Chat のみが生成する（軽量・最終決定に特化）
- ルーティング決定は Worker の RoutingModule が担当
- LLMは提案者であり決定権を持たない

### 1.1 役割命名（固定）と実体（可変）
- **エージェント ID は固定**: `chat / worker / order1 / order2 / order3`
  - 旧名称 `coder1 / coder2 / coder3` も設定で使用可能（後方互換）
- **愛称と実体LLMは可変**: 設定ファイル `routing.llm.*` で指定
  - `chat_alias/chat_provider/chat_model`（例: Mio / ollama / chat-v1:latest）
  - `worker_alias/worker_provider/worker_model`（例: Shiro / ollama / worker-v1:latest）
  - `order1_alias/order1_provider/order1_model`（例: Aka / deepseek / deepseek-chat）
    - 旧: `coder_alias/coder_provider/coder_model`
  - `order2_alias/order2_provider/order2_model`（例: Ao / openai / gpt-4）
    - 旧: `coder2_alias/coder2_provider/coder2_model`
  - `order3_alias/order3_provider/order3_model`（例: Gin / anthropic / claude-sonnet-4-5）
    - 旧: `coder3_alias/coder3_provider/coder3_model`

### 1.2 エージェント責務（2026-03-01 更新）

#### Chat（Mio）
- **軽量な入力受付**: LINE/Slack からの入力を受け取り、JobID を付与
- **Worker へタスク委譲**: ルーティング・実行は Worker に任せる
- **最終決定**: Worker からの報告を受けて最終的な応答を決定
- **承認 UI**: 承認が必要な場合、LINE/Slack へ通知

#### Worker（Shiro）
- **ルーティング決定**: Router/Classifier を使用してタスクを分類
- **ループ制御**: 最大ループ数・時間制限の管理
- **Order への委譲**: 必要に応じて Order1/2/3 へタスクを振り分け
- **結果集約**: 各 Order からの提案を集約
- **Heartbeat 管理**: 全エージェントの状態を収集・監視
- **実行・道具係**: ファイル操作、コマンド実行、パッチ適用

#### Order1（Aka / DeepSeek）
- **低コスト・大量処理向け**: 比較的単純な作業を担当
- **提案生成**: plan/patch を生成（実行はしない）

#### Order2（Ao / OpenAI）
- **コーディング・実装の中核**: 実装タスクを担当
- **提案生成**: plan/patch を生成（実行はしない）

#### Order3（Gin / Anthropic Claude）
- **高品質推論・複雑なタスク**: 失敗コストが高いタスクを担当
- **提案生成 + 承認フロー**: plan/patch を生成し、承認を要求
- **将来の拡張**: SSHブリッジ経由でリモート環境の LLM を利用可能

**重要原則**:
- すべての作業・応答に **JobID を必須** とする
- Order（旧Coder）は原則として破壊的操作を**直接実行せず**、`plan` と `patch` を生成
- 実行は Worker が承認後に担当

---

## 2. ルーティング決定仕様

**重要**: ルーティング決定は **Worker（Shiro）の RoutingModule** が担当する（2026-03-01以降）。
Chat（Mio）は入力を受け取り、Worker へタスクを委譲する。

### 2.1 優先順位（固定）
1. 明示コマンド
2. ルール辞書（強証拠）
3. 分類器（1入力につき最大1回）
4. 安全側フォールバック

### 2.2 明示コマンド
- `/code /analyze /plan /ops /research /chat /local /cloud`
- 行頭コマンドのみ有効
- `local_only=true` 中の `/code` は Router段階で拒否し、会話LLMで解除案内

### 2.3 ルール辞書
- 初期辞書は強証拠のみ
- 評価順は priority降順、同値は定義順
- 辞書定義は `docs/03_旧分割仕様アーカイブ/実装仕様_02.md` を正式参照

### 2.4 分類器
- 出力は JSON のみ（`route`,`confidence`,`reason`,`evidence`）
- 故障時（JSON不正/必須欠損/列挙外/範囲外）は CHAT フォールバック
- CODE判定は `confidence >= 0.8` かつ強証拠を必須

### 2.5 分類器プロンプト管理
- 分類器system promptは1枚固定
- 更新はカテゴリ追加時のみ

### 2.6 LINEチャネルの入口制約（2026-03-01更新）

**新設計**:
- LINE入力 → Chat（Mio）が受領 → Worker（Shiro）へタスク委譲
- Worker が RoutingModule でルーティング決定（`CHAT/PLAN/CODE1/CODE2/CODE3` 等）
- 必要に応じて Order1/2/3 へ振り分け
- Worker が結果を集約して Chat へ報告
- Chat が最終決定・応答

**旧設計（2026-02-24時点）**:
- LINE入力は `CHAT` 固定で開始する（`line_forced_chat`）
- Chat（Mio）が Router を呼び出してルーティング決定
- 委譲は Mio の応答プロトコル（`DELEGATE: ...`）で実行

---

## 3. ループ制御と再ルート

### 3.1 停止条件
- `max_loops` 到達
- `max_millis` 到達
- worker失敗
- ユーザー確認が必要

### 3.2 ユーザー確認停止
- 停止理由を `need_user_confirmation` に統一
- 発火条件:
  - `risk=high`
  - 低confidenceかつ重大分岐
  - 追加情報不足

### 3.3 再ルート（最大1回）
- `fit=false` かつ `suggested_route` 有効
- または会話LLM提案IFを採択
- 同一入力で最大1回

### 3.4 会話LLM提案IF
```json
{"propose_next_loop":false,"route":"CHAT|PLAN|ANALYZE|OPS|RESEARCH|CODE|CODE1|CODE2|CODE3","reason":"short text","confidence":0.0}
```

---

## 4. I/O契約

### 4.1 InputMessage
- `channel`, `session_id`, `user_text`, `raw`, `received_at`

### 4.2 RoutingDecision
- `primary_route`, `source`, `confidence`, `reason`, `evidence`, `flags.local_only`

### 4.3 WorkerInput
- `docs/03_旧分割仕様アーカイブ/実装仕様_03.md` の入力スキーマを採用

### 4.4 WorkerOutput（統一定義）
- 必須: `result`,`needs_next_loop`,`why`,`next_actions`,`questions_for_user`,`confidence`,`risk`
- 任意: `fit`,`suggested_route`

---

## 5. ワーカー仕様
- 全ワーカーの出力は JSON のみ
- 失敗時は `needs_next_loop=false`
- `next_actions` / `questions_for_user` は最大3
- CODEはクラウド専用、`local_only` 時は呼び出し禁止（Router拒否を主、worker保険）

### 5.1 Coder3 の出力仕様（2026-02-24追加）
Coder3 は「提案と差分」を生成し、実行は Worker に委譲する：
- 必須フィールド:
  - `job_id`: ジョブ識別子
  - `plan`: 手順・判断理由（簡潔に）
  - `patch`: diff 形式の変更案（または変更内容の箇条書き）
  - `risk`: 破壊的変更/互換性/手戻り可能性
  - `need_approval`: 承認要否（通常 true）
- 任意フィールド:
  - `cost_hint`: 概算トークン数や上限接近の警告

詳細: `docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md`

---

## 6. 承認フロー仕様（2026-02-24追加）

### 6.1 基本原則
- Coder（Coder1/Coder2/Coder3）は「提案（plan）」と「差分（patch）」を生成
- **実際の適用（書込み/実行）は Worker が担当**
- 破壊的操作には**承認が必須**

### 6.2 標準フロー
1. Chat がジョブ作成（`job_id` 付与）
2. Coder が提案・差分を生成
3. Chat がユーザーへ承認要求（LINE/Slack 等）
4. 承認後、Worker が適用実行
5. 結果を通知、ログ保存

### 6.3 承認要求メッセージの必須項目
- `job_id`: 押下対象を確定する ID
- 操作要約（1〜3行）
- 影響範囲（ファイル/環境）
- 取り消し可否（ロールバック可/不可）
- コスト見積もり（任意）

### 6.4 Auto-Approve モード
Auto-Approve は **Scope（範囲）と TTL（有効期限）を持つ**：
- 対象ジョブ種別（例: docs 生成のみ）
- 対象ツール（例: ファイル書込み制限）
- 対象パス（例: `docs/` のみ）
- 有効期限（例: 30分）
- **即時 OFF 可能**（最優先操作）

**強制承認が必要なケース**（Auto-Approve でも例外）:
- 削除、リネーム、広範囲の上書き
- 機密情報を含む可能性が高い送信
- 外部公開（SNS 投稿、public リポジトリへの push）
- コストが閾値超過

詳細: `docs/05_LLM運用プロンプト設計/Coder3_Claude_API仕様.md` 7章

---

## 7. セキュリティ仕様
- CODE以外でクラウド利用禁止
- `/local` 中はクラウド呼び出し禁止
- 機密情報（token/secret/PII）はクラウド送信前に除外
- ログ保存はマスク後のみ
- サニタイズ責務は `pkg/security/sanitizer.go` に一本化

---

## 7. ログ仕様

### 7.1 イベント種別（固定）
- `router.decision`
- `classifier.error`
- `worker.success`
- `worker.fail`
- `route.override`
- `loop.stop`
- `final.route`
- `approval.requested`（2026-02-24追加）
- `approval.granted`（2026-02-24追加）
- `approval.denied`（2026-02-24追加）
- `approval.auto_approved`（2026-02-24追加）
- `coder.plan_generated`（2026-02-24追加）

### 7.2 最低保存項目
- `initial_route`, `final_route`
- `classifier_route`, `classifier_confidence`
- `worker_calls`, `needs_next_loop`, `risk`, `fit`
- `reroute_used`, `stop_reason`, `error_reason`

### 7.3 承認フロー関連の保存項目（2026-02-24追加）
- `job_id`: ジョブ識別子
- `approval_status`: `pending` / `granted` / `denied` / `auto_approved`
- `approval_requested_at`: 承認要求時刻
- `approval_decided_at`: 承認決定時刻
- `approver`: 承認者（ユーザーID）
- `coder_output`: Coder の生成した plan/patch/risk の要約

### 7.4 JobID 必須化（2026-03-01追加）
すべての作業・応答に JobID を必須とする：
- ログ保存時に必ず `job_id` フィールドを含める
- JobID 形式: `job_<YYYYMMDD>_<連番>`（例: `job_20260301_001`）
- JobID はセッション単位でインクリメント
- トレーサビリティ向上のため、すべてのエージェント間通信で JobID を伝播

### 7.5 画像送信監査ログ（現行）

- ログカテゴリ: `provider.http`
- 送信前: `LLM image audit before request`
  - `source_path`, `url_type`, `image_url`（要約）, `image_url_length`
  - `local_exists_before`, `local_size_before_bytes`
  - `included`, `drop_reason`
- タイムアウト時: `LLM image audit after timeout`
  - `local_exists_after_timeout`, `local_size_after_timeout_bytes`

---

## 8. Prompt/宣言仕様
- persona/policy/overlay を固定順で連結
- system prompt はアプリ側のみが構築
- route変更時のみ1行宣言（CHATは宣言なし）

---

## 9. 状態管理仕様
- `session_id` はチャネル単位で一意管理（Slackはthread単位推奨）
- `short_memory` 中心で運用し `recent_turns` は最小限
- ANALYZE構造化データの保存先は実装で1つに統一:
  - `pkg/memory/store.go` 拡張
  - または `pkg/analyze/store.go` 新設

---

## 10. 設定値と閾値
- `routing.classifier.min_confidence = 0.6`
- `routing.classifier.min_confidence_for_code = 0.8`
- `loop.max_loops = 3`
- `loop.max_millis = 90000`
- `loop.allow_auto_reroute_once = true`
- `loop.allow_chat_propose_reroute_once = true`
- Ollama呼び出し時 `options.num_ctx = 8192`、`keep_alive: -1` をリクエストに含める
- `providers.ollama_restart_command`（任意）: Ollama 再起動コマンド（例: `systemctl --user restart ollama`）
- ヘルスチェック制約:
  - `ModelRequirement.MaxContext = 8192`: モデルの context_length がこれを超える場合は NG（大きすぎる num_ctx によるロード失敗を防止）
  - `ModelRequirement.MinContext`: 指定時、context_length がこれ未満の場合は NG（必要に応じて使用）

### 10.1 Coder3 設定（2026-02-24追加）
- `coder3.provider = "anthropic"`: Claude API 専用
- `coder3.model = "claude-sonnet-4.5"`: 使用モデル
- `coder3.max_tokens = 16000`: 1ジョブあたりの上限
- `coder3.retry_max = 2`: 連続リトライ回数制限
- `coder3.timeout_sec = 60`: タイムアウト

### 10.2 承認フロー設定（2026-02-24追加）
- `approval.required_by_default = true`: デフォルトで承認必須
- `approval.auto_approve.enabled = false`: Auto-Approve 無効（デフォルト）
- `approval.auto_approve.scope.allowed_task_types = ["design", "review"]`: 許可タスク種別
- `approval.auto_approve.scope.allowed_paths_prefix = ["docs/"]`: 許可パスプレフィックス
- `approval.auto_approve.scope.deny_operations = ["delete", "rename", "push_public"]`: 禁止操作
- `approval.auto_approve.ttl_minutes = 60`: 有効期限（分）
- `approval.hard_require_approval = ["delete", "rename", "send_sensitive", "push_public", "cost_over_limit"]`: 強制承認が必要な操作

---

## 11. テスト観点
- 正常系: command優先、rules確定、classifierフォールバック、reroute最大1回
- 異常系: 分類器JSON不正、ワーカーJSON不正、`local_only`中CODE、`risk=high`確認停止
- 回帰: 非対象チャネルへ副作用なし、宣言文切替の維持

---

## 12. Heartbeat システム（2026-03-01追加）

### 12.1 基本原則
すべてのエージェントは自律的に Heartbeat を発行し、動作状態を Worker へ報告する。

### 12.2 Heartbeat データ構造
```json
{
  "agent_id": "order3",
  "alias": "Gin",
  "timestamp": "2026-03-01T12:00:00Z",
  "status": "idle|busy|error",
  "current_job_id": "job_20260301_001",
  "memory_usage_mb": 5.2,
  "last_task_duration_ms": 1234,
  "error_message": ""
}
```

### 12.3 Worker の集約処理
Worker（Shiro）は：
1. すべてのエージェントから Heartbeat を収集
2. 自身の Heartbeat も含める
3. 統合状態レポートを生成
4. Chat へ報告（必要時のみ）

### 12.4 Heartbeat イベント
- `heartbeat.received`: エージェントから Heartbeat を受信
- `heartbeat.timeout`: エージェントが一定時間応答なし
- `heartbeat.error`: エージェントがエラー状態を報告
- `heartbeat.aggregated`: Worker が統合レポートを生成

### 12.5 設定
```json
{
  "heartbeat": {
    "enabled": true,
    "interval_sec": 30,
    "timeout_sec": 60,
    "report_to_chat": false  // エラー時のみ報告
  }
}
```

---

## 13. 合議制（Deliberation Mode）（2026-03-01追加）

### 15.1 概要
必要時に複数の Order（Coder）が独立して提案を生成し、Worker が集約・比較して Chat が最終決定する。

**目的**:
- 複数 LLM の提案を比較して品質を向上
- Spawn 多用を避けつつ協調動作を実現

### 15.2 動作フロー
```
1. Chat が合議制を有効化（明示コマンド `/deliberate` または自動判定）
   ↓
2. Worker が複数 Order へ並列リクエスト
   - Order1 (Aka / DeepSeek): 提案 A を生成
   - Order2 (Ao / OpenAI): 提案 B を生成
   - Order3 (Gin / Claude): 提案 C を生成
   ↓
3. Worker が提案を集約・比較
   - 類似点・相違点を分析
   - リスク・コストを比較
   ↓
4. Chat が最終決定
   - ユーザーへ選択肢を提示（必要時）
   - 自動選択（低リスク時）
```

### 13.3 合議制を適用すべきケース
- **失敗コストが高いタスク**: 削除、広範囲のリファクタリング
- **曖昧な仕様**: 解釈が分かれる可能性がある
- **複雑な設計決定**: アーキテクチャ変更、API 設計

### 13.4 合議制を避けるべきケース
- **単純なタスク**: タイポ修正、ドキュメント生成
- **コスト制約**: 予算・時間が限られている
- **承認フローなしのタスク**: 自動実行が前提

### 13.5 設定
```json
{
  "deliberation": {
    "enabled": false,  // デフォルト無効
    "auto_trigger": {
      "enabled": false,
      "conditions": [
        "risk=high",
        "ambiguous_spec",
        "architectural_change"
      ]
    },
    "max_parallel_orders": 3,
    "timeout_sec": 120
  }
}
```

### 13.6 ログイベント
- `deliberation.started`: 合議制開始
- `deliberation.proposal_received`: Order からの提案受信
- `deliberation.comparison`: 提案の比較結果
- `deliberation.decision`: 最終決定

---

## 14. 参照関係

### 14.1 仕様ドキュメント
- **正本**: `docs/01_正本仕様/実装仕様.md`（本書）
- **分割版**: `docs/02_v2統合分割仕様/実装仕様_v2_00_目次.md`
- **旧版アーカイブ一覧**: `docs/03_旧分割仕様アーカイブ/実装仕様_アーカイブ一覧.md`

### 14.2 コードベース解析
コードベースの構造・モジュール・潜在バグを解析したドキュメント：

- **アーキテクチャ総合**: `docs/codebase-map/アーキテクチャ総合.md`
  - プロジェクト全体のアーキテクチャ概要
- **モジュール詳細**: `docs/codebase-map/modules/`
  - `agent.md` - エージェント関連モジュール
  - `approval.md` - 承認フロー
  - `core.md` - コア設定・ログ
  - `integrations.md` - 外部連携（LINE/Slack等）
  - `providers.md` - LLM プロバイダ
- **ユースケース逆引き**: `docs/codebase-map/ユースケース逆引き.md`
  - 機能ごとの実装箇所を逆引き
- **結合ポイントマップ**: `docs/codebase-map/結合ポイントマップ.md`
  - モジュール間の依存関係
- **潜在バグ一覧**: `docs/codebase-map/潜在バグ一覧.md`
  - 既知の問題・改善点
- **refs_mapping.md**: `docs/codebase-map/refs_mapping.md`
  - シンボル参照マッピング
- **manifest.json**: `docs/codebase-map/manifest.json`
  - コードベースマップのメタデータ

---

## 15. 実装状況（MVP / 2026-02-19）

### 15.1 実装済み
- Router（MVP）: `command -> rules -> classifier -> fallback` を実装
  - `pkg/agent/router.go`
- Classifier（MVP）: JSON抽出/検証、異常時フォールバックを実装
  - `pkg/agent/classifier.go`
- AgentLoop統合: ルーティング判定、宣言文付与、`local_only` セッション保持を実装
  - `pkg/agent/loop.go`
- 設定追加: `routing` / `loop` を追加（デフォルト値含む）
  - `pkg/config/config.go`
- セッション拡張: `local_only` / `prev_primary_route` を保存
  - `pkg/session/manager.go`

### 15.2 テスト状況
- パッケージテスト: `go test ./pkg/config ./pkg/session ./pkg/agent` 通過
- 追加テスト:
  - `pkg/agent/router_test.go`
  - `pkg/session/manager_test.go`（flags永続化）
  - `pkg/config/config_test.go`（routing/loop初期値）

### 15.3 既知の制約（MVP）
- 分類器はモデル出力に依存し、JSON不正時は `CHAT` にフォールバックする。
- `needs_next_loop` を前提にした高度なworker連鎖は未実装（1ターン完結中心）。
- 会話LLMの再ルート提案IF採択ロジックは次フェーズ。

### 15.4 接続運用メモ（Ollama/Tailscale）
- `api_base` は名前解決不安定時に Tailscale IP 直指定を推奨。
- 現行実装では Ollama接続時に provider判定の都合上、`model` は `ollama/<model>` 形式で指定する。

### 15.5 画像I/O実装状況（2026-02-20）
- LINE画像は一時保存後、`image_url(data URI)` に変換して送信。
- 一時ファイルは即時削除せず保持期間後にクリーンアップ。
- `provider.http` の監査ログで「送信時存在」「サイズ」「タイムアウト後存在」を追跡可能。

### 15.6 2026-02-22 反映
- Coder1/Coder2 二重ルーティング: `pkg/agent/router.go`（RouteCode1/RouteCode2）、`pkg/agent/loop.go`（`selectCoderRoute`）
- Ollama `keep_alive: -1`: `pkg/providers/http_provider.go`
- LINE指示ごとのOllamaヘルスチェック・再起動・リトライ: `pkg/agent/loop.go` の `processMessage`
- Chat/Worker モデル名: `chat-v1:latest`, `worker-v1:latest`（`Modelfile.chat`、`config.example.json`）

### 15.7 2026-03-01 新アーキテクチャ実装完了

**重要**: プロジェクトモジュール名を `github.com/sipeed/picoclaw` から `github.com/Nyukimin/picoclaw_multiLLM` に変更（独自開発のため）

**マルチエージェント新設計** - Phase 1-4 基本実装完了：

#### Phase 1: 基盤構築 ✅ **完了 (2026-03-01)**
- [x] `pkg/modules/types.go` - Module インターフェース、AgentCore 構造体定義
- [x] `pkg/jobid/generator.go` - JobID 生成機能（フォーマット: job_YYYYMMDD_NNN）
- [x] `pkg/config/config.go` - ArchitectureConfig 追加（use_new_architecture, enable_heartbeat, enable_deliberation）
- [x] `config/config.example.json` - architecture セクション追加
- [x] `pkg/modules/types_test.go` - モジュールインターフェースのテスト（5 tests PASS）
- [x] `pkg/jobid/generator_test.go` - JobID 生成のテスト（4 tests PASS、並行性・リセット・フォーマット検証）
- [x] Coder3Alias のデフォルト値を "Gin" に修正

#### Phase 2: モジュール実装 ✅ **完了 (2026-03-01)**
- [x] `pkg/modules/chat/reception.go` - LightweightReceptionModule（実装・テスト完了）
- [x] `pkg/modules/chat/decision.go` - FinalDecisionModule（実装・テスト完了）
- [x] `pkg/modules/worker/routing.go` - RoutingModule（既存 Router をラップ、循環依存回避）
- [x] `pkg/modules/worker/execution.go` - ExecutionModule（Provider 統合、CHAT/OPS/RESEARCH/PLAN/ANALYZE 対応）
- [x] `pkg/modules/worker/heartbeat.go` - HeartbeatCollectorModule（完全実装）
- [x] `pkg/modules/worker/aggregation.go` - AggregationModule（実装・テスト完了）
- [x] `pkg/modules/order/proposal.go` - ProposalGenerationModule（Provider 統合、PLAN/PATCH/RISK 生成）
- [x] `pkg/modules/order/approval.go` - ApprovalFlowModule（実装・テスト完了）
- [x] `pkg/modules/order/analysis.go` - CodeAnalysisModule（基本構造実装）
- [x] モジュールテスト（chat: 2 tests, worker: 2 tests, order: 2 tests - 全 PASS）

**未実装（優先度低）**:
- [ ] `pkg/modules/chat/approval_ui.go` - ApprovalUIModule（既存の承認フローで代替可能）
- [ ] `pkg/modules/worker/loop.go` - LoopControlModule（既存のループ制御で代替可能）
- [ ] `pkg/modules/common/*` - 共通モジュール（既存実装で十分）

#### Phase 3: エージェントファクトリと新フロー ✅ **完了 (2026-03-01)**
- [x] `pkg/agent/factory.go` - エージェント生成ファクトリ（5エージェント対応）
- [x] `pkg/agent/router_adapter.go` - Router アダプター（循環依存回避）
- [x] `pkg/agent/loop_new.go` - 新アーキテクチャのメッセージ処理（完全実装）
- [x] `pkg/agent/loop.go` - 新旧フロー分岐の追加（processMessageLegacy として既存保存）
- [x] フィーチャーフラグによる新旧切り替え実装（use_new_architecture）
- [x] Order 委譲ロジック実装（動的エージェント生成、提案取得、結果変換）
- [x] ファクトリテスト（5エージェント生成テスト - 全 PASS）

#### Phase 4: 高度機能 ✅ **基本実装完了 (2026-03-01)**
- [x] `pkg/heartbeat/protocol.go` - Heartbeat プロトコル完全実装（pub/sub パターン）
- [x] `pkg/heartbeat/protocol_test.go` - Heartbeat テスト（4 tests PASS）
- [x] Provider 統合完了（ExecutionModule, ProposalGenerationModule で実際の LLM 呼び出し）
- [x] Order エージェント別システムプロンプト（Aka/Ao/Gin）
- [x] PLAN/PATCH/RISK 構造化提案のパーサー実装

**未実装（オプション機能）**:
- [ ] `pkg/modules/worker/deliberation.go` - 合議制コーディネーター（基盤は完成、統合は未実施）
- [ ] Heartbeat の実際のエージェント間送受信（プロトコルは完成、wiring は未実施）
- [ ] 合議制の完全な統合（設定・ログイベントは定義済み）

**テスト状況**:
```
✅ すべてのパッケージで全テスト PASS（30+ tests）
✓ pkg/jobid      - 4 tests PASS
✓ pkg/modules    - 5 tests PASS
✓ pkg/config     - 8 tests PASS
✓ pkg/modules/chat   - 2 tests PASS
✓ pkg/modules/worker - 2 tests PASS
✓ pkg/modules/order  - 2 tests PASS
✓ pkg/heartbeat      - 4 tests PASS
✓ pkg/agent          - 全テスト PASS
```

**後方互換性**:
- 旧名称 `coder_alias/coder_provider/coder_model` も使用可能（order1 にマップ）
- フィーチャーフラグ `architecture.use_new_architecture` で新旧切り替え可能（デフォルト: false）
- 既存コードは `processMessageLegacy()` として完全保存

**新アーキテクチャの特徴**:
- **責務分離**: Chat（軽量受領・最終決定）、Worker（ルーティング・実行・集約）、Order（提案生成）
- **JobID 追跡**: すべての作業に一意な JobID（フォーマット: job_YYYYMMDD_NNN）
- **Provider 統合**: 実際の LLM 呼び出しを各モジュールで実装
- **Heartbeat 監視**: エージェント状態のリアルタイム追跡（pub/sub パターン）
- **段階的移行**: フラグで新旧アーキテクチャを切り替え可能
