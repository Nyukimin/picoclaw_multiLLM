# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåé›†ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

æœ€çµ‚æ›´æ–°: 2026-02-21  
å¯¾è±¡ã‚³ãƒ¼ãƒ‰: `pkg/agent/context.go`, `pkg/agent/memory.go`, `pkg/agent/loop.go`, `pkg/agent/router.go`

---

## æ¦‚è¦

PicoClawã¯ã€è¤‡æ•°ã®æƒ…å ±ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åé›†ã—ã€ãƒ«ãƒ¼ãƒˆï¼ˆCHAT/CODE/PLANç­‰ï¼‰ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‹•çš„ã«æ§‹ç¯‰ã—ã¦LLMã«é€ä¿¡ã™ã‚‹ã€‚æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ãã®å…¨ä½“ãƒ•ãƒ­ãƒ¼ã‚’è¨˜è¿°ã™ã‚‹ã€‚

---

## 1. æƒ…å ±ã‚½ãƒ¼ã‚¹ä¸€è¦§

| # | ã‚½ãƒ¼ã‚¹ | åé›†å ´æ‰€ | æ‹…å½“é–¢æ•° | æ¦‚è¦ |
|---|--------|----------|----------|------|
| A | Identityï¼ˆå›ºå®šæƒ…å ±ï¼‰ | ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | `getIdentity()` | æ™‚åˆ»ãƒ»ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ»ãƒ«ãƒ¼ãƒ« |
| B | ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ« | `workspace/*.md` | `LoadBootstrapFiles()` | ãƒšãƒ«ã‚½ãƒŠãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç­‰ |
| C | ã‚¹ã‚­ãƒ« | `workspace/skills/`, `~/.picoclaw/skills/`, `./skills/` | `BuildSkillsSummary()` | ã‚¹ã‚­ãƒ«å®šç¾©ã®ã‚µãƒãƒª |
| D | ãƒ¡ãƒ¢ãƒª | `workspace/memory/` | `GetMemoryContext()` | é•·æœŸè¨˜æ†¶ãƒ»æ—¥æ¬¡ãƒãƒ¼ãƒˆ |
| E | ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ | `workspace/sessions/{key}.json` | `SessionManager` | ä¼šè©±å±¥æ­´ãƒ»è¦ç´„ |
| F | ãƒ„ãƒ¼ãƒ«å®šç¾© | `pkg/tools/` å„ãƒ„ãƒ¼ãƒ« | `buildToolsSection()` | åˆ©ç”¨å¯èƒ½ãƒ„ãƒ¼ãƒ«ä¸€è¦§ |

---

## 2. å„ã‚½ãƒ¼ã‚¹ã®è©³ç´°

### A. Identityï¼ˆ`getIdentity()`ï¼‰

`pkg/agent/context.go` ã® `getIdentity()` ã§ç”Ÿæˆã•ã‚Œã‚‹å›ºå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€‚

**å«ã¾ã‚Œã‚‹æƒ…å ±:**

| é …ç›® | å†…å®¹ | ä¾‹ |
|------|------|-----|
| ç¾åœ¨æ™‚åˆ» | `time.Now()` ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ | `2026-02-21 14:30 (Friday)` |
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | OSãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»Goç‰ˆ | `linux amd64, Go go1.22.0` |
| ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ã‚¹ | çµ¶å¯¾ãƒ‘ã‚¹ | `/home/user/picoclaw/workspace` |
| å„ç¨®ãƒ‘ã‚¹æ¡ˆå†… | Memory, Daily Notes, Skills, Persona | ãƒ‘ã‚¹ä¸€è¦§ |
| é‹ç”¨ãƒ«ãƒ¼ãƒ« | 8GBåˆ¶ç´„ã€HDDæ°¸ç¶šåŒ–ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¦æ­¢ç­‰ | â€” |

**CHATãƒ«ãƒ¼ãƒˆå›ºæœ‰ã®è¿½åŠ :**
- Mioãƒšãƒ«ã‚½ãƒŠå„ªå…ˆãƒ«ãƒ¼ãƒ«
- CHAT Delegation Protocolï¼ˆWorker/Coderã¸ã®å§”ä»»å½¢å¼ï¼‰

### B. ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`LoadBootstrapFiles()`ï¼‰

`workspace/` é…ä¸‹ã®5ã¤ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ã«èª­ã¿è¾¼ã‚€ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚

| èª­ã¿è¾¼ã¿é † | ãƒ•ã‚¡ã‚¤ãƒ« | ç”¨é€” |
|-----------|----------|------|
| 1 | `CHAT_PERSONA.md` | ãƒãƒ£ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠï¼ˆMioã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šï¼‰ |
| 2 | `AGENTS.md` | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•æŒ‡é‡ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ |
| 3 | `SOUL.md` | ã‚³ã‚¢ãªæ€§æ ¼ç‰¹æ€§ï¼ˆè¦ªåˆ‡ãƒ»æ­£ç›´ãƒ»é€æ˜æ€§ï¼‰ |
| 4 | `USER.md` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆåå‰ãƒ»å¥½ã¿ãƒ»ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼‰ |
| 5 | `IDENTITY.md` | ã‚·ã‚¹ãƒ†ãƒ åãƒ»ç›®çš„ãƒ»èƒ½åŠ›ãƒ»å“²å­¦ |

å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `## {filename}\n\n{content}\n\n` ã®å½¢å¼ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æŒ¿å…¥ã•ã‚Œã‚‹ã€‚

### C. ã‚¹ã‚­ãƒ«æƒ…å ±ï¼ˆ`BuildSkillsSummary()`ï¼‰

3ã¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚¹ã‚­ãƒ«ã‚’æ¤œç´¢ã—ã€XMLå½¢å¼ã®ã‚µãƒãƒªã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¼‰ã›ã‚‹ã€‚

**æ¤œç´¢å„ªå…ˆåº¦:**

```
1. workspace/skills/          â† ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å›ºæœ‰ï¼ˆæœ€å„ªå…ˆï¼‰
2. ~/.picoclaw/skills/        â† ã‚°ãƒ­ãƒ¼ãƒãƒ«
3. ./skills/                  â† ãƒ“ãƒ«ãƒˆã‚¤ãƒ³
```

ã‚µãƒãƒªã«ã¯ã‚¹ã‚­ãƒ«åãƒ»èª¬æ˜ãƒ»æ‰€åœ¨ãƒ»ã‚½ãƒ¼ã‚¹ç¨®åˆ¥ãŒå«ã¾ã‚Œã‚‹ã€‚LLMãŒå¿…è¦ã«å¿œã˜ã¦ `read_file` ãƒ„ãƒ¼ãƒ«ã§ `SKILL.md` ã®å…¨æ–‡ã‚’èª­ã‚€è¨­è¨ˆã€‚

### D. ãƒ¡ãƒ¢ãƒªï¼ˆ`GetMemoryContext()`ï¼‰

`pkg/agent/memory.go` ã® `MemoryStore` ãŒç®¡ç†ã™ã‚‹2ç¨®é¡ã®è¨˜æ†¶ã€‚

| ç¨®é¡ | ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|------|----------|------|
| é•·æœŸè¨˜æ†¶ | `workspace/memory/MEMORY.md` | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨ªæ–­ã§ä¿æŒã™ã‚‹é‡è¦æƒ…å ± |
| æ—¥æ¬¡ãƒãƒ¼ãƒˆ | `workspace/memory/YYYYMM/YYYYMMDD.md` | æ—¥ã”ã¨ã®è¨˜éŒ²ï¼ˆç›´è¿‘3æ—¥åˆ†ã‚’åé›†ï¼‰ |

```
## Long-term Memory
{MEMORY.md ã®å†…å®¹}

---

## Recent Daily Notes
{éå»3æ—¥åˆ†ã®æ—¥æ¬¡ãƒãƒ¼ãƒˆï¼ˆ--- åŒºåˆ‡ã‚Šï¼‰}
```

### E. ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ï¼ˆ`SessionManager`ï¼‰

`workspace/sessions/{sessionKey}.json` ã«æ°¸ç¶šåŒ–ã•ã‚ŒãŸä¼šè©±å±¥æ­´ã€‚

- **å±¥æ­´ï¼ˆHistoryï¼‰**: éå»ã®user/assistant/toolãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—
- **è¦ç´„ï¼ˆSummaryï¼‰**: å±¥æ­´ãŒé•·ããªã£ãŸéš›ã«LLMã§ç”Ÿæˆã—ãŸåœ§ç¸®ãƒ†ã‚­ã‚¹ãƒˆ

### F. ãƒ„ãƒ¼ãƒ«å®šç¾©ï¼ˆ`buildToolsSection()`ï¼‰

`ToolRegistry` ã«ç™»éŒ²ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã®ã‚µãƒãƒªã‚’å‹•çš„ç”Ÿæˆã™ã‚‹ã€‚

**CHATãƒ«ãƒ¼ãƒˆã§ã¯ãƒ„ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³éè¡¨ç¤º**ï¼ˆä¼šè©±å°‚ç”¨ã®ãŸã‚ï¼‰ã€‚

**ç™»éŒ²ãƒ„ãƒ¼ãƒ«ä¸€è¦§:**

| ãƒ„ãƒ¼ãƒ«å | æ©Ÿèƒ½ |
|----------|------|
| `read_file` | ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š |
| `write_file` | ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ |
| `list_dir` | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§ |
| `edit_file` | ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›† |
| `append_file` | ãƒ•ã‚¡ã‚¤ãƒ«è¿½è¨˜ |
| `exec` | ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ |
| `web_search` | Webæ¤œç´¢ï¼ˆBrave/DuckDuckGo/Perplexityï¼‰ |
| `web_fetch` | Webãƒšãƒ¼ã‚¸å–å¾— |
| `i2c` | I2Cãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ |
| `spi` | SPIãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ |
| `message` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |

---

## 3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ãƒ•ãƒ­ãƒ¼

### 3.1 å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    â”‚
    â–¼
Router.Decide()  â†’  ãƒ«ãƒ¼ãƒˆæ±ºå®šï¼ˆCHAT / CODE / PLAN / ANALYZE / OPS / RESEARCHï¼‰
    â”‚
    â–¼
runAgentLoop()
    â”‚
    â”œâ”€ updateToolContexts()         â† ãƒ„ãƒ¼ãƒ«ã«channel/chatIDè¨­å®š
    â”‚
    â”œâ”€ SessionManager.GetHistory()  â† ä¼šè©±å±¥æ­´å–å¾—
    â”œâ”€ SessionManager.GetSummary()  â† è¦ç´„å–å¾—
    â”‚
    â”œâ”€ ContextBuilder.BuildMessages()
    â”‚   â”‚
    â”‚   â”œâ”€ BuildSystemPrompt(route)
    â”‚   â”‚   â”œâ”€ getIdentity(route)         â† Identity + Tools
    â”‚   â”‚   â”œâ”€ LoadBootstrapFiles()       â† *.md ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
    â”‚   â”‚   â”œâ”€ BuildSkillsSummary()       â† ã‚¹ã‚­ãƒ«XMLã‚µãƒãƒª
    â”‚   â”‚   â””â”€ GetMemoryContext()         â† MEMORY.md + æ—¥æ¬¡ãƒãƒ¼ãƒˆ
    â”‚   â”‚
    â”‚   â”œâ”€ Session Info (channel, chatID)
    â”‚   â”œâ”€ Summary (ã‚ã‚Œã°)
    â”‚   â””â”€ buildUserContentWithMedia()    â† æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    â”‚
    â–¼
LLMã¸é€ä¿¡: [System] + [History] + [User Message]
```

### 3.2 æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã®æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ messages[0]: System Message                     â”‚
â”‚  â”œâ”€â”€ # picoclaw ğŸ¦                             â”‚
â”‚  â”‚   â”œâ”€â”€ Current Time                           â”‚
â”‚  â”‚   â”œâ”€â”€ Runtime                                â”‚
â”‚  â”‚   â”œâ”€â”€ Workspace                              â”‚
â”‚  â”‚   â”œâ”€â”€ Available Toolsï¼ˆCHATä»¥å¤–ï¼‰            â”‚
â”‚  â”‚   â””â”€â”€ Important Rules                        â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ --- separator ---                          â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ ## CHAT_PERSONA.md                         â”‚
â”‚  â”œâ”€â”€ ## AGENTS.md                               â”‚
â”‚  â”œâ”€â”€ ## SOUL.md                                 â”‚
â”‚  â”œâ”€â”€ ## USER.md                                 â”‚
â”‚  â”œâ”€â”€ ## IDENTITY.md                             â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ --- separator ---                          â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ # Skillsï¼ˆXMLã‚µãƒãƒªï¼‰                      â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ --- separator ---                          â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ # Memory                                   â”‚
â”‚  â”‚   â”œâ”€â”€ ## Long-term Memory                    â”‚
â”‚  â”‚   â””â”€â”€ ## Recent Daily Notes                  â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ ## Current Sessionï¼ˆchannel, chatIDï¼‰      â”‚
â”‚  â””â”€â”€ ## Summary of Previous Conversation        â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ messages[1..N]: History                         â”‚
â”‚  â””â”€â”€ éå»ã®user / assistant / tool ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸   â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ messages[N+1]: Current User Message             â”‚
â”‚  â”œâ”€â”€ ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡                               â”‚
â”‚  â”œâ”€â”€ [ATTACHMENTS]ï¼ˆç”»åƒãƒ»æ–‡æ›¸ãŒã‚ã‚‹å ´åˆï¼‰      â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ä¸€è¦§                       â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ†ã‚­ã‚¹ãƒˆæŠœç²‹ï¼ˆæœ€å¤§12KBï¼‰               â”‚
â”‚  â”‚   â””â”€â”€ [type=image] ã‚¿ã‚°                      â”‚
â”‚  â””â”€â”€ [ATTACHMENT_POLICY]ï¼ˆå‡¦ç†æ–¹é‡ï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ `\n\n---\n\n` ã§åŒºåˆ‡ã‚‰ã‚Œã‚‹ã€‚

---

## 4. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒ«ãƒ¼ãƒˆåˆ¥æŒ™å‹•

### 4.1 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®šãƒ•ãƒ­ãƒ¼

`Router.Decide()` ãŒä»¥ä¸‹ã®å„ªå…ˆåº¦ã§ãƒ«ãƒ¼ãƒˆã‚’æ±ºå®šã™ã‚‹ã€‚

```
å„ªå…ˆåº¦1: æ˜ç¤ºã‚³ãƒãƒ³ãƒ‰   (/chat, /code, /plan, /analyze, /ops, /research)
    â†“ ãƒãƒƒãƒã—ãªã„å ´åˆ
å„ªå…ˆåº¦2: ãƒ«ãƒ¼ãƒ«ãƒãƒƒãƒ   (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥)
    â†“ ãƒãƒƒãƒã—ãªã„å ´åˆ
å„ªå…ˆåº¦3: LLMã‚¯ãƒ©ã‚·ãƒ•ã‚¡ã‚¤ã‚¢ (LLMè‡ªèº«ã«ã‚ˆã‚‹åˆ†é¡åˆ¤å®šã€ä¿¡é ¼åº¦é–¾å€¤ã‚ã‚Š)
    â†“ ä¿¡é ¼åº¦ä¸è¶³ã®å ´åˆ
å„ªå…ˆåº¦4: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯  (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: CHAT)
```

### 4.2 ãƒ«ãƒ¼ãƒ«åˆ¤å®šã®æ¤œçŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³

| ãƒ«ãƒ¼ãƒˆ | æ¤œçŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ |
|--------|------------|
| CODE | ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆ3é€£ã€`diff --git`ã€`Traceback`ã€ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ï¼ˆ`.go`, `.py` ç­‰ï¼‰ |
| OPS | `systemctl`, `journalctl`, `docker`, `ssh`, `kubectl` |
| ANALYZE | `é›†è¨ˆ`, `å‚¾å‘`, `çµ±è¨ˆ`, `analyze`, `csv`, `json` |
| RESEARCH | URLã€`å‡ºå…¸`, `æœ€æ–°`, `æ¯”è¼ƒ`, `research` |
| PLAN | `ä»•æ§˜`, `è¨­è¨ˆ`, `æ§‹æˆ`, `æ®µå–ã‚Š`, `plan`, `architecture` |

### 4.3 ãƒ«ãƒ¼ãƒˆåˆ¥ã®å·®ç•°

| ãƒ«ãƒ¼ãƒˆ | ãƒ„ãƒ¼ãƒ«æä¾› | LLMãƒ¢ãƒ‡ãƒ« | è¦ç´„æœ‰åŠ¹ | å‚™è€ƒ |
|--------|-----------|-----------|----------|------|
| CHAT | ãªã— | `routing.llm.chat_model` | **ç„¡åŠ¹** | Mioãƒšãƒ«ã‚½ãƒŠã€ä¼šè©±ã®ã¿ |
| CODE | ã‚ã‚Š | `routing.llm.coder_model` | æœ‰åŠ¹ | ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒ»ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œå¯ |
| PLAN | ã‚ã‚Š | `routing.llm.worker_model` | æœ‰åŠ¹ | è¨ˆç”»ç«‹æ¡ˆå‘ã‘ |
| ANALYZE | ã‚ã‚Š | `routing.llm.worker_model` | æœ‰åŠ¹ | ãƒ‡ãƒ¼ã‚¿åˆ†æå‘ã‘ |
| OPS | ã‚ã‚Š | `routing.llm.worker_model` | æœ‰åŠ¹ | é‹ç”¨æ“ä½œå‘ã‘ |
| RESEARCH | ã‚ã‚Š | `routing.llm.worker_model` | æœ‰åŠ¹ | èª¿æŸ»ãƒ»æ¤œç´¢å‘ã‘ |

### 4.4 CHATãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³

CHATãƒ«ãƒ¼ãƒˆã®LLMãŒé‡ã„ä½œæ¥­ã‚’æ¤œçŸ¥ã—ãŸå ´åˆã€ä»¥ä¸‹ã®å½¢å¼ã§å§”ä»»ã‚’å®£è¨€ã§ãã‚‹ã€‚

```
DELEGATE: CODE|PLAN|ANALYZE|OPS|RESEARCH
TASK:
{å…·ä½“çš„ãªä½œæ¥­æŒ‡ç¤º}
```

å§”ä»»ãƒ•ãƒ­ãƒ¼:
1. Mioï¼ˆCHATï¼‰ãŒãƒ‡ãƒªã‚²ãƒ¼ãƒˆå½¢å¼ã‚’å‡ºåŠ›
2. æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§Worker/CoderãŒä½œæ¥­å®Ÿè¡Œ
3. çµæœã‚’Mioã«æˆ»ã—ã€æœ€çµ‚å›ç­”ã‚’ç”Ÿæˆ

---

## 5. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†

### 5.1 ãƒ¡ãƒ‡ã‚£ã‚¢å‚ç…§

ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`ï¼‰ã¯LLMã«ãƒ¡ãƒ‡ã‚£ã‚¢å‚ç…§ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã€‚

### 5.2 ãƒ†ã‚­ã‚¹ãƒˆæŠœç²‹

ãƒ†ã‚­ã‚¹ãƒˆç³»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.md`, `.txt`, `.json`, `.yaml`, `.go`, `.py`, `.ts` ç­‰ï¼‰ã¯æœ€å¤§12,000æ–‡å­—ã¾ã§æŠœç²‹ã‚’æŒ¿å…¥ã€‚

### 5.3 æ·»ä»˜ãƒãƒªã‚·ãƒ¼ï¼ˆ`ATTACHMENT_POLICY`ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ„å›³ã‚’æ¨å®šã—ã€å‡¦ç†æ–¹é‡ã‚’è‡ªå‹•ä»˜ä¸ã™ã‚‹ã€‚

| æ¨å®šæ„å›³ | æ¤œçŸ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ | ãƒãƒªã‚·ãƒ¼å†…å®¹ |
|----------|---------------|-------------|
| `save_data` | ä¿å­˜ã€ä¿ç®¡ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | ãƒ‡ãƒ¼ã‚¿ä¿å­˜å‰æã§æ•´ç† |
| `knowledge_add` | ãƒŠãƒ¬ãƒƒã‚¸ã€çŸ¥è­˜è¿½åŠ  | æ§‹é€ åŒ–ã—ã¦knowledgeé…ä¸‹ã«ä¿å­˜ |
| `image_prompt` | æç”»ã€ç”»åƒç”Ÿæˆã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã—ã¦ | ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¤‰æ› |
| `image_analysis` | åˆ†æã€è§£æã€è¦‹ã¦ | è¦³æ¸¬äº‹å®Ÿã¨æ¨å®šã‚’åˆ†é›¢ã—ã¦èª¬æ˜ |
| `doc_prompt` | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ– | æŒ‡ç¤ºæ–‡ã«æ•´å½¢ |
| `default` | ä¸Šè¨˜ã«è©²å½“ã—ãªã„ | å†…å®¹ç¢ºèªã®ã¿å®Ÿæ–½ã—ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª |

---

## 6. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåœ§ç¸®

### 6.1 é€šå¸¸è¦ç´„ï¼ˆ`maybeSummarize()`ï¼‰

| ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|-------------|-----------|
| å±¥æ­´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•° > 20 | LLMã§è¦ç´„ç”Ÿæˆ |
| ãƒˆãƒ¼ã‚¯ãƒ³æ¨å®šå€¤ > ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®75% | LLMã§è¦ç´„ç”Ÿæˆ |

- ç›´è¿‘4ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¿æŒ
- 10ä»¶è¶…ã®å ´åˆã¯å‰åŠãƒ»å¾ŒåŠã‚’åˆ¥ã€…ã«è¦ç´„ã—ã€ãƒãƒ¼ã‚¸
- è¦ç´„ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®Summaryãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜

### 6.2 ç·Šæ€¥åœ§ç¸®ï¼ˆ`forceCompression()`ï¼‰

LLMã‹ã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¶…éã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚ŒãŸå ´åˆã«ç™ºå‹•ã€‚

- å±¥æ­´ã®å‰åŠ50%ã‚’å³æ™‚ãƒ‰ãƒ­ãƒƒãƒ—
- `[System: Emergency compression dropped N oldest messages]` ã‚’æŒ¿å…¥
- æœ€å¤§2å›ãƒªãƒˆãƒ©ã‚¤

### 6.3 ãƒˆãƒ¼ã‚¯ãƒ³æ¨å®š

```
æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•° = æ–‡å­—æ•°ï¼ˆRuneCountï¼‰ Ã— 2 / 5
```

CJKæ–‡å­—ã‚’è€ƒæ…®ã—ã€1ãƒˆãƒ¼ã‚¯ãƒ³ã‚ãŸã‚Šç´„2.5æ–‡å­—ã§è¨ˆç®—ã€‚

---

## 7. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å¯¾å¿œè¡¨

| æ©Ÿèƒ½ | ãƒ•ã‚¡ã‚¤ãƒ« | é–¢æ•° |
|------|----------|------|
| ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ | `pkg/agent/context.go` | `BuildSystemPrompt()` |
| Identityç”Ÿæˆ | `pkg/agent/context.go` | `getIdentity()` |
| ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—èª­è¾¼ | `pkg/agent/context.go` | `LoadBootstrapFiles()` |
| ãƒ„ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ | `pkg/agent/context.go` | `buildToolsSection()` |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—çµ„ç«‹ | `pkg/agent/context.go` | `BuildMessages()` |
| æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† | `pkg/agent/context.go` | `buildUserContentWithMedia()` |
| æ·»ä»˜ãƒãƒªã‚·ãƒ¼åˆ¤å®š | `pkg/agent/context.go` | `buildAttachmentGuidance()` |
| æ„å›³æ¨å®š | `pkg/agent/context.go` | `inferAttachmentGoal()` |
| ãƒ¡ãƒ¢ãƒªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ | `pkg/agent/memory.go` | `GetMemoryContext()` |
| é•·æœŸè¨˜æ†¶èª­è¾¼ | `pkg/agent/memory.go` | `ReadLongTerm()` |
| æ—¥æ¬¡ãƒãƒ¼ãƒˆåé›† | `pkg/agent/memory.go` | `GetRecentDailyNotes()` |
| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ«ãƒ¼ãƒ— | `pkg/agent/loop.go` | `runAgentLoop()` |
| LLMã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | `pkg/agent/loop.go` | `runLLMIteration()` |
| ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®š | `pkg/agent/router.go` | `Router.Decide()` |
| ãƒ«ãƒ¼ãƒ«ãƒãƒƒãƒ | `pkg/agent/router.go` | `matchRule()` |
| é€šå¸¸è¦ç´„ | `pkg/agent/loop.go` | `summarizeSession()` |
| ç·Šæ€¥åœ§ç¸® | `pkg/agent/loop.go` | `forceCompression()` |
| ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³è§£æ | `pkg/agent/loop.go` | `parseChatDelegateDirective()` |
| ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ | `pkg/agent/loop.go` | `executeChatDelegation()` |
| Mioæœ€çµ‚å›ç­” | `pkg/agent/loop.go` | `finalizeDelegationWithMio()` |
| ãƒ«ãƒ¼ãƒˆåˆ¥LLMåˆ‡æ›¿ | `pkg/agent/loop.go` | `applyRouteLLM()` |
