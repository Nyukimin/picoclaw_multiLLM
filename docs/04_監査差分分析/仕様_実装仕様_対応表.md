# 仕様→実装仕様 対応表（docs監査）

## 監査対象
- 元仕様: `docs/01_正本仕様/仕様.md`
- 実装仕様: `docs/03_旧分割仕様アーカイブ/実装仕様_01.md` 〜 `docs/03_旧分割仕様アーカイブ/実装仕様_07.md`
- 判定基準:
  - `対応`: 実装仕様に具体定義あり
  - `部分対応`: 方針はあるが、値/保存先/実行条件/責務が未確定 or 仕様間で揺れあり
  - `未対応`: 実装仕様への落とし込みが見当たらない

## 集計
- 対応: 65
- 部分対応: 14
- 未対応: 1

## 要件別マッピング

### A. 機能要件（REQ-001〜REQ-043）
- `REQ-001` 会話LLM単一窓口 | 対応: `実装仕様_01` 0章/7章 | 判定: 対応
- `REQ-002` LINE/Slack初期対象 | 対応: `実装仕様_01` 0章/3.1 | 判定: 対応
- `REQ-003` ローカルLLM=Ollama | 対応: `実装仕様_01` 2章（環境変数） | 判定: 対応
- `REQ-004` 常駐2モデル以上 | 対応: `実装仕様_01` 目的/設定 | 判定: 対応
- `REQ-005` CODE時のみクラウド使用 | 対応: `実装仕様_01` 8章、`実装仕様_03` 6章、`実装仕様_04` codeWorker | 判定: 対応
- `REQ-006` Router/LoopControllerが最終決定 | 対応: `実装仕様_01` 1章責務境界、6章 | 判定: 対応
- `REQ-007` 6カテゴリ実装 | 対応: `実装仕様_01` 3.2、`実装仕様_04` types | 判定: 対応
- `REQ-008` 明示コマンド群対応 | 対応: `実装仕様_01` 5.1 | 判定: 対応
- `REQ-009` `/local` でクラウド禁止 | 対応: `実装仕様_01` 5.1/8章 | 判定: 対応
- `REQ-010` `/cloud` で解除 | 対応: `実装仕様_01` 5.1 | 判定: 対応
- `REQ-011` 先頭コマンド以外無効 | 対応: `実装仕様_01` 5.1 | 判定: 対応
- `REQ-012` `local_only=true`中の`/code`拒否 | 対応: `実装仕様_01` 5.1、`実装仕様_04` codeWorker | 判定: 部分対応（拒否は定義、案内文の統一仕様が弱い）
- `REQ-013` ルール辞書の強証拠で確定 | 対応: `実装仕様_01` 5.2、`実装仕様_02` | 判定: 対応
- `REQ-014` 分類器は1入力最大1回 | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-015` 分類器JSONのみ | 対応: `実装仕様_01` 5.4、`実装仕様_03` | 判定: 対応
- `REQ-016` 分類器出力キー定義 | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-017` 強証拠なしCODE禁止 | 対応: `実装仕様_01` 5.3/5.4、`実装仕様_02` CODEルール群 | 判定: 対応
- `REQ-018` 低confidence時は安全側 | 対応: `実装仕様_01` 2章/5.4 | 判定: 対応
- `REQ-019` CODE高閾値 | 対応: `実装仕様_01` 2章（0.8） | 判定: 対応
- `REQ-020` WorkerOutput必須群 | 対応: `実装仕様_01` 3.3、`実装仕様_03` 1章、`実装仕様_04` types | 判定: 対応
- `REQ-021` `fit`/`suggested_route`任意 | 対応: `実装仕様_01` 3.3、`実装仕様_04` omitempty | 判定: 部分対応（`実装仕様_03`では必須化）
- `REQ-022` 次ループ最終決定はLoopController | 対応: `実装仕様_01` 6章、`実装仕様_06` controller | 判定: 対応
- `REQ-023` 会話LLMが続行/停止/確認提案可 | 対応: `実装仕様_03` 7章（任意） | 判定: 部分対応（任意扱い）
- `REQ-024` `risk=high`でユーザー確認 | 対応: `実装仕様_01` 6章、`実装仕様_06` 実装メモ | 判定: 部分対応（実装メモ止まり）
- `REQ-025` 低confidence重大分岐で確認 | 対応: `実装仕様_01` 6章 | 判定: 部分対応（具体判定ロジック未定）
- `REQ-026` 追加情報不足で確認 | 対応: `実装仕様_03` 各Workerの`questions_for_user` | 判定: 対応
- `REQ-027` 自動ループ上限 | 対応: `実装仕様_01` 2章/6章、`実装仕様_06` config | 判定: 対応
- `REQ-028` 上限到達時の報告 | 対応: `実装仕様_01` 6章/7章 | 判定: 部分対応（報告テンプレの具体化なし）
- `REQ-029` ルート切替時のみ宣言 | 対応: `実装仕様_01` 0章/4章、`実装仕様_07` declaration | 判定: 対応
- `REQ-030` CODE宣言文 | 対応: `実装仕様_07` declarationMap | 判定: 対応
- `REQ-031` ANALYZE宣言文 | 対応: `実装仕様_07` declarationMap | 判定: 対応
- `REQ-032` PLAN宣言文 | 対応: `実装仕様_07` declarationMap | 判定: 対応
- `REQ-033` OPS宣言文 | 対応: `実装仕様_07` declarationMap | 判定: 対応
- `REQ-034` RESEARCH宣言文 | 対応: `実装仕様_07` declarationMap | 判定: 対応
- `REQ-035` CHATは宣言なし | 対応: `実装仕様_07` declarationMap | 判定: 対応
- `REQ-036` 明示コマンドで上書き | 対応: `実装仕様_01` 5.1 | 判定: 対応
- `REQ-037` 自動再ルート最大1回 | 対応: `実装仕様_01` 2章/6章、`実装仕様_06` rerouted制御 | 判定: 対応
- `REQ-038` `fit=false`+`suggested_route`で再ルート | 対応: `実装仕様_01` 6章、`実装仕様_06` 3章 | 判定: 対応
- `REQ-039` 会話LLM未達提案の再ルート採否 | 対応: `実装仕様_01` 2章設定、`実装仕様_03` 7章 | 判定: 部分対応（`実装仕様_06`本体に未反映）
- `REQ-040` チャネルごとsession_id | 対応: `実装仕様_01` 3.1、`実装仕様_03` WorkerInput | 判定: 対応
- `REQ-041` short_memory中心運用 | 対応: `実装仕様_01` 4章/7章、`実装仕様_03` WorkerInput | 判定: 対応
- `REQ-042` ANALYZE結果の構造化蓄積 | 対応: `実装仕様_03` analyze result、`実装仕様_01` memory言及 | 判定: 部分対応（保存先定義不足）
- `REQ-043` ルーティングカテゴリ拡張可能 | 対応: `実装仕様_02` routes配列、`実装仕様_01` Router構成 | 判定: 対応

### B. 非機能要件（REQ-044〜REQ-049）
- `REQ-044` 内部事情（クラウド/ローカル）非表示 | 対応: `実装仕様_01` 7章出力制約 | 判定: 対応
- `REQ-045` ログを会話へ混ぜない | 対応: `実装仕様_01` 7章/9章、`実装仕様_06` logger | 判定: 対応
- `REQ-046` クラウド送信前サニタイズ | 対応: `実装仕様_01` 8章、`実装仕様_05` redactor | 判定: 部分対応（専用`pkg/security`仕様が薄い）
- `REQ-047` ログのマスク | 対応: `実装仕様_01` 8章、`実装仕様_05` redactor | 判定: 部分対応（logger層での強制仕様が未明確）
- `REQ-048` 注入で制約上書き不可 | 対応: `実装仕様_01` command優先/責務境界 | 判定: 部分対応（防御ロジックが明文化不足）
- `REQ-049` 履歴圧縮で負荷/漏洩低減 | 対応: `実装仕様_01` 4章/7章、`実装仕様_03` short_memory | 判定: 対応

### C. 制約（REQ-050〜REQ-063）
- `REQ-050` 他チャネル機能を壊さない | 対応: `実装仕様_01` 0章（LINE/Slack対象） | 判定: 部分対応（回帰防止観点の明記不足）
- `REQ-051` 最終回答は会話LLMのみ | 対応: `実装仕様_01` 0章/7章 | 判定: 対応
- `REQ-052` 分岐決定者はシステムのみ | 対応: `実装仕様_01` 1章責務境界/6章 | 判定: 対応
- `REQ-053` CODE以外クラウド不使用 | 対応: `実装仕様_01` 8章、`実装仕様_03` codeWorker前提 | 判定: 対応
- `REQ-054` `/local`中クラウド禁止 | 対応: `実装仕様_01` 8章、`実装仕様_04` codeWorker guard | 判定: 対応
- `REQ-055` 分類器呼び出し失敗→CHAT | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-056` CODE誤爆抑制 | 対応: `実装仕様_01` 5.3/5.4、`実装仕様_02` | 判定: 対応
- `REQ-057` 分類器JSONパース不能→CHAT | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-058` 必須キー欠損→CHAT | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-059` route列挙外→CHAT | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-060` confidence範囲外→CHAT | 対応: `実装仕様_01` 5.4 | 判定: 対応
- `REQ-061` ワーカー出力異常時は追加ループしない | 対応: `実装仕様_03` ワーカー故障時、`実装仕様_04` 失敗時ルール、`実装仕様_06` stop | 判定: 対応
- `REQ-062` 誤分類を事故化しない | 対応: `実装仕様_01` 6章/10章、`実装仕様_06` | 判定: 対応
- `REQ-063` CODE誤爆最小化（強証拠+高信頼） | 対応: `実装仕様_01` 5.3/5.4、`実装仕様_02` | 判定: 対応

### D. 画面/API/運用ルール（REQ-064〜REQ-080）
- `REQ-064` 決定順序固定（command→rules→classifier→fallback） | 対応: `実装仕様_01` 4章/5章、`実装仕様_02` notes | 判定: 対応
- `REQ-065` 初期辞書は強証拠のみ | 対応: `実装仕様_02` notes/rules | 判定: 対応
- `REQ-066` CODE強証拠定義 | 対応: `実装仕様_01` 5.3、`実装仕様_02` CODE_* | 判定: 対応
- `REQ-067` OPS強証拠定義 | 対応: `実装仕様_02` OPS_* | 判定: 対応
- `REQ-068` ANALYZE強証拠定義 | 対応: `実装仕様_02` ANALYZE_* | 判定: 対応
- `REQ-069` RESEARCH強証拠定義 | 対応: `実装仕様_02` RESEARCH_* | 判定: 対応
- `REQ-070` PLAN強証拠定義 | 対応: `実装仕様_02` PLAN_* | 判定: 対応
- `REQ-071` ルート切替定義 | 対応: `実装仕様_07` BuildDeclaration(prev, cur) | 判定: 対応
- `REQ-072` 最低ログ（入力/初回route/分類器結果） | 対応: `実装仕様_01` 9章 | 判定: 部分対応（`実装仕様_06`実装例は不足）
- `REQ-073` 上書き有無/再ルート有無ログ | 対応: `実装仕様_01` 9章 | 判定: 部分対応（loggerイベント設計に未展開）
- `REQ-074` worker呼び出し/needs_next_loop/risk/fitログ | 対応: `実装仕様_01` 9章、`実装仕様_06` worker.success | 判定: 対応
- `REQ-075` 最終routeログ | 対応: `実装仕様_01` 9章 | 判定: 部分対応（`実装仕様_06`終了ログ未定義）
- `REQ-076` 分類器/ワーカーのエラー理由ログ | 対応: `実装仕様_01` 9章、`実装仕様_06` worker.fail | 判定: 部分対応（分類器系イベント未具体化）
- `REQ-077` 分類器故障時仕様ログ | 対応: `実装仕様_01` 5.4/9章 | 判定: 部分対応（logger実装例なし）
- `REQ-078` ワーカー故障時仕様ログ | 対応: `実装仕様_03` 故障時、`実装仕様_06` worker.fail | 判定: 対応
- `REQ-079` 辞書をログ駆動で育成 | 対応: `実装仕様_02` データ駆動JSON、`実装仕様_01` 9章 | 判定: 部分対応（運用フロー未定義）
- `REQ-080` 分類器プロンプト固定1枚 | 対応: なし | 判定: 未対応

## 監査結論
- 主要機能の土台（ルーティング順序、分類器制約、ワーカー契約、宣言文、ループ上限）は実装仕様に概ね落ちている。
- 実装時に事故になりやすい箇所は `部分対応/未対応` に集中している:
  - `fit`/`suggested_route` の必須・任意の揺れ
  - `risk=high` や会話LLM提案再ルートの実装レベル不足
  - ログ項目の「仕様→実装」展開不足
  - サニタイズ責務の境界不明確
  - 分類器プロンプト固定ポリシー（REQ-080）未定義
