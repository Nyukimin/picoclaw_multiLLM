# 仕様→実装仕様 差分メモ

## 概要
- 対象: `docs/01_正本仕様/仕様.md` と `docs/03_旧分割仕様アーカイブ/実装仕様_01.md`〜`docs/03_旧分割仕様アーカイブ/実装仕様_07.md`
- 結果: 主要要件は概ね反映済み。ただし、実装ブレを生む差分が複数ある。
- 重点対応: 再ルート制御、出力契約整合、ログ要件、セキュリティ責務の明確化。

## 優先度: 高（実装事故に直結）

### 1) `fit` / `suggested_route` の必須・任意の矛盾
- 差分:
  - `仕様.md`: 任意項目
  - `実装仕様_03`: WorkerOutputのrequiredに含む
  - `実装仕様_04`: `omitempty` で任意
- 影響:
  - ワーカー実装ごとにJSON検証ルールが不一致になり、パース失敗や不要なフォールバックを誘発。
- 推奨:
  - `実装仕様_03` を修正し、`fit`/`suggested_route` は任意扱いに統一。

### 2) 会話LLM提案による再ルート（REQ-039）の仕様止まり
- 差分:
  - `実装仕様_01` に `allow_chat_propose_reroute_once` 設定あり
  - `実装仕様_03` に任意プロンプトあり
  - `実装仕様_06` LoopController本体に採否ロジックがない
- 影響:
  - 仕様が期待する「会話LLM提案の採否」を実現できない。
- 推奨:
  - LoopControllerに提案入力IF（propose_next_loop, route, confidence）と採用条件を追加。

### 3) `risk=high` 時のユーザー確認条件が実装仕様で未具体化
- 差分:
  - `仕様.md` は条件例を提示
  - `実装仕様_06` は実装メモ記載のみで、分岐条件・返却フォーマット不在
- 影響:
  - 高リスク案件で自動継続する危険。
- 推奨:
  - LoopControllerの停止理由に `need_user_confirmation` を追加し、会話LLMへの引き渡し契約を固定。

## 優先度: 中（運用ブレを誘発）

### 4) ログ最小項目（REQ-072〜078）の実装粒度不足
- 差分:
  - `実装仕様_01` にはログ要件がある
  - `実装仕様_06` の loggerサンプルは `worker.success/fail` 中心で、分類器・最終route・上書き有無などのイベント定義不足
- 影響:
  - 改善サイクル（辞書育成・閾値調整）に必要なデータが欠落しやすい。
- 推奨:
  - イベント種別を固定化: `router.decision`, `classifier.error`, `loop.stop`, `route.override`, `final.route`。

### 5) サニタイズ責務の配置ゆれ
- 差分:
  - `実装仕様_01`: `pkg/security/sanitizer.go`
  - `実装仕様_05`: `materials.MakeSimpleRedactor`
- 影響:
  - 「クラウド送信前」と「ログ保存前」で別実装になり漏れが出る可能性。
- 推奨:
  - `pkg/security` を単一責務にし、`materials` はそれを利用する側に整理。

### 6) `local_only` 時のCODE経路の扱いが揺れる
- 差分:
  - `実装仕様_01`: `/code`拒否し解除案内
  - `実装仕様_03`: LoopControllerでPLANへ落とす記述
  - `実装仕様_04`: codeWorker内でfailOutput
- 影響:
  - UXと制御フローが実装者依存になる。
- 推奨:
  - 正式挙動を1つに固定（推奨: Router段階で拒否し会話LLM案内、workerは保険ガード）。

## 優先度: 低（将来拡張時の摩擦）

### 7) REQ-080（分類器プロンプト固定1枚）が未定義
- 差分:
  - 実装仕様側に「分類器プロンプト管理」章がない
- 影響:
  - カテゴリ追加時の変更範囲が不明確になる。
- 推奨:
  - `実装仕様_07` に classifier prompt管理節（配置/更新ルール）を追加。

### 8) ANALYZE構造化蓄積の保存先未定義
- 差分:
  - `仕様.md` は保存先を実装仕様で定義と記載
  - 実装仕様群に具体保存先なし
- 影響:
  - データ活用設計が遅延。
- 推奨:
  - `pkg/memory/store.go` もしくは専用 `pkg/analyze/store.go` を明示。

### 9) 「他チャネル既存挙動を壊さない」検証観点が薄い
- 差分:
  - 対象外宣言はあるが、回帰試験項目としての記載が弱い
- 影響:
  - 既存チャネル（LINE/Slack以外）への副作用が見逃される可能性。
- 推奨:
  - `実装仕様_01` 10章テスト観点に「非対象チャネル回帰」を追記。

## 推奨修正順
1. WorkerOutput契約の統一（高）
2. LoopController再ルート/確認分岐の仕様確定（高）
3. ログイベント体系の確定（中）
4. サニタイズ責務統一（中）
5. 分類器プロンプト管理章の追加（低）
6. ANALYZE保存先・回帰試験観点の追記（低）

## 最終判断
- 「仕様の全てが実装仕様になっているか」の観点では、**骨格は反映済み**。
- ただし、`高優先` の差分を解消しないと、実装段階で挙動差・安全性低下・検証不足が発生しうる。
