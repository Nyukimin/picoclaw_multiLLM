# 実装仕様 章再編案 v2

## 目的
- `docs/01_正本仕様/仕様.md` と `docs/03_旧分割仕様アーカイブ/実装仕様_01.md`〜`docs/03_旧分割仕様アーカイブ/実装仕様_07.md` のズレを解消し、実装者が迷わない章構成に再編する。
- 既存の分割仕様（01〜07）は保持しつつ、参照順を「実装順」に合わせる。

## 再編方針
- 先に「ルールと契約」を確定し、その後に「実行系」「可視化」「運用」を置く。
- 仕様の判断軸（優先順位・失敗時挙動・安全制約）を同じ章に集約する。
- 可変ルール（辞書、プロンプト、閾値）は管理章を独立させる。

## 新章構成（推奨）
1. スコープ・責務境界
2. ルーティング決定仕様（command/rules/classifier/fallback）
3. ループ制御と再ルート仕様
4. I/O契約（InputMessage / RoutingDecision / WorkerInput / WorkerOutput）
5. ワーカー仕様（PLAN/ANALYZE/OPS/RESEARCH/CODE）
6. セキュリティ仕様（local_only、サニタイズ、注入対策）
7. ログ仕様（イベント定義、最低項目、改善データ）
8. Prompt/宣言仕様（最終可視化）
9. 状態管理仕様（session/short_memory/analyze保存）
10. 設定値と閾値（config/env）
11. テスト観点（通常系/異常系/回帰）

## 旧章→新章マッピング

| 旧ドキュメント | 主内容 | 新章 |
|---|---|---|
| `実装仕様_01` 0,1章 | 目的、責務境界、モジュール | 1 |
| `実装仕様_01` 5章 + `実装仕様_02` | ルーティング優先順位、辞書 | 2 |
| `実装仕様_01` 6章 + `実装仕様_06` 3章 + `実装仕様_03` 7章 | ループ、再ルート、確認分岐 | 3 |
| `実装仕様_01` 3章 + `実装仕様_03` 0/1章 + `実装仕様_04` 1章 | 入出力契約 | 4 |
| `実装仕様_03` 2〜6章 + `実装仕様_04` 4/5章 + `実装仕様_06` 1章 | 各ワーカー仕様 | 5 |
| `実装仕様_01` 8章 + `実装仕様_05` redactor | セキュリティ | 6 |
| `実装仕様_01` 9章 + `実装仕様_06` 2章 | ログ仕様 | 7 |
| `実装仕様_07` + `実装仕様_01` 7章 | Prompt/宣言/最終整形 | 8 |
| `実装仕様_01` 4章/7章 + memory関連 | session/memory/analyze保存 | 9 |
| `実装仕様_01` 2章 | config/env/閾値 | 10 |
| `実装仕様_01` 10章 + 差分メモ項目 | テスト観点 | 11 |

## 再編時に同時反映すべき修正（必須）
- `WorkerOutput.fit` / `suggested_route` は任意で統一。
- `risk=high`、低confidence重大分岐、情報不足時の停止理由を `need_user_confirmation` に統一。
- 会話LLMの再ルート提案IFを LoopController に明示追加。
- `REQ-080` 対応として分類器プロンプト管理章を新設。
- ANALYZE構造化データの保存先を明示。

## 成果物構成（提案）
- `docs/02_v2統合分割仕様/実装仕様_v2_統合版.md`（実装の正本）
- `docs/02_v2統合分割仕様/実装仕様_章再編案_v2.md`（この再編説明）
- 既存 `実装仕様_01〜07.md` は「互換参照用」として残す

## 運用ルール
- 新規実装・修正は `実装仕様_v2_統合版.md` を唯一の正本として参照する。
- `実装仕様_01〜07.md` へ追加修正する場合も、同時に v2 へ反映する。
