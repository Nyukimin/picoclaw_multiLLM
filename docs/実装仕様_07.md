# 実装仕様_07（Go版）：Prompt管理と宣言文

> アーカイブ扱い: 本ファイルは互換参照用（更新停止）。内容は v2 へ再配置済みです。  
> 参照: `docs/実装仕様_v2_08_Prompt宣言.md` / 正本 `docs/実装仕様_v2_統合版.md`

設計方針:

* **固定**（人格・口調）と **可変**（運用ルール・素材注入）を分離する
* 可変部分は必ずシステムが組み立てる
* 会話LLMは system prompt 自体を書き換えない

---

## 1) `pkg/prompt/manager.go`

```go
package prompt

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"

	"github.com/sipeed/picoclaw/pkg/workers"
)

type Paths struct {
	BaseDir      string
	PersonaFile  string
	PolicyFile   string
	OverlaysDir  string
}

type BuildContext struct {
	Channel string
	Route   workers.Route
	LocalOnly bool
}

type Built struct {
	SystemPrompt string
	Sections     []string
}

type Manager struct {
	paths Paths
	cache map[string]string
}

func NewManager(p Paths) *Manager {
	return &Manager{paths: p, cache: map[string]string{}}
}

func (m *Manager) loadCached(abs string) string {
	if s, ok := m.cache[abs]; ok {
		return s
	}
	b, err := os.ReadFile(abs)
	if err != nil {
		return ""
	}
	s := strings.TrimSpace(string(b))
	m.cache[abs] = s
	return s
}

func overlayNames(ctx BuildContext) []string {
	list := []string{"common.md"}
	if ctx.Channel == "slack" {
		list = append(list, "channel_slack.md")
	} else if ctx.Channel == "line" {
		list = append(list, "channel_line.md")
	}
	list = append(list, "route_"+strings.ToLower(string(ctx.Route))+".md")
	if ctx.LocalOnly {
		list = append(list, "mode_local_only.md")
	}
	return list
}

func (m *Manager) Build(ctx BuildContext) Built {
	base := m.paths.BaseDir
	sections := []string{}

	persona := m.loadCached(filepath.Join(base, m.paths.PersonaFile))
	if persona != "" {
		sections = append(sections, persona)
	}

	policy := m.loadCached(filepath.Join(base, m.paths.PolicyFile))
	if policy != "" {
		sections = append(sections, policy)
	}

	for _, n := range overlayNames(ctx) {
		p := filepath.Join(base, m.paths.OverlaysDir, n)
		if s := m.loadCached(p); s != "" {
			sections = append(sections, s)
		}
	}

	system := strings.Join(sections, "\n\n---\n\n")
	return Built{SystemPrompt: system, Sections: sections}
}

func BuildUserPrompt(userText, materials, shortMemory string) string {
	return fmt.Sprintf("UserText:\n%s\n\nShortMemory:\n%s\n\nMaterials:\n%s", userText, shortMemory, materials)
}
```

---

## 2) `pkg/prompt/declaration.go`

```go
package prompt

import "github.com/sipeed/picoclaw/pkg/workers"

var declarationMap = map[workers.Route]string{
	workers.RouteCode:     "コーディングするね。",
	workers.RouteAnalyze:  "整理して分析するね。",
	workers.RoutePlan:     "段取りを組むね。",
	workers.RouteOps:      "手順で案内するね。",
	workers.RouteResearch: "調べてまとめるね。",
	workers.RouteChat:     "",
}

func BuildDeclaration(prev *workers.Route, cur workers.Route) string {
	if prev != nil && *prev == cur {
		return ""
	}
	return declarationMap[cur]
}

func PrependDeclaration(declaration, text string) string {
	if declaration == "" {
		return text
	}
	if text == "" {
		return declaration
	}
	return declaration + "\n" + text
}
```

---

## 3) 運用ルール

* declaration は route変更時のみ付与
* system prompt はアプリ側のみが構築
* LLMが返した prompt 改変提案は別ログに保持し、人間またはルールエンジンが採択

---

## 4) 最低テスト

* `BuildDeclaration(nil, workers.RouteCode)` は宣言あり
* `BuildDeclaration(&workers.RouteCode, workers.RouteCode)` は空
* `Build()` は persona/policy/overlay を順序どおり連結
* overlayファイル欠落時にパニックしない
